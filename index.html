<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diamond Recharge</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: #fff;
    }
    header, footer {
      background: #1e1e1e;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    header h1 {
      margin: 0;
      font-size: 18px;
    }
    .menu-btn {
      font-size: 22px;
      cursor: pointer;
    }
    .sidebar {
      position: fixed;
      left: -250px;
      top: 0;
      width: 250px;
      height: 100%;
      background: #1e1e1e;
      transition: left 0.3s;
      padding-top: 50px;
      z-index: 1000;
    }
    .sidebar.active { left: 0; }
    .sidebar a {
      display: block;
      padding: 12px;
      color: #fff;
      text-decoration: none;
    }
    .sidebar a:hover { background: #333; }
    main { padding: 20px; }
    .hidden { display: none; }
    .btn {
      background: #007bff;
      border: none;
      color: white;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    .btn:hover { background: #0056b3; }
    .amount-btns button {
      background: #444;
      margin: 5px;
      padding: 10px;
      border-radius: 5px;
      color: #fff;
      cursor: pointer;
    }
    .status {
      padding: 4px 8px;
      border-radius: 5px;
      color: #fff;
      font-size: 12px;
    }
    .WAITING { background: orange; }
    .COMPLETED { background: green; }
    .CANCELLED { background: red; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td {
      padding: 8px;
      border: 1px solid #333;
      text-align: center;
    }
  </style>
</head>
<body>
  <header>
    <span class="menu-btn" onclick="toggleSidebar()">â˜°</span>
    <h1>Diamond Recharge</h1>
    <span id="userInfo"></span>
  </header>

  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <a href="#" onclick="showPage('dashboard')">Dashboard</a>
    <a href="#" onclick="showPage('order')">Order</a>
    <a href="#" onclick="showPage('history')">Order History</a>
    <a href="#" onclick="showPage('profile')">Profile</a>
    <a href="#" onclick="showPage('admin')">Admin</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <main>
    <!-- Login -->
    <div id="loginPage">
      <h2>Login</h2>
      <input id="loginEmail" placeholder="Email"><br>
      <input id="loginPass" type="password" placeholder="Password"><br>
      <button class="btn" onclick="login()">Login</button>
    </div>

    <!-- Dashboard -->
    <div id="dashboard" class="hidden">
      <h2>Dashboard</h2>
      <p>Balance: <span id="balance">0</span> ðŸ’Ž</p>
      <p>Weekly Orders: <span id="weekly">0</span></p>
      <p>Reward Tier: <span id="tier">-</span></p>
    </div>

    <!-- Order -->
    <div id="order" class="hidden">
      <h2>Place Order</h2>
      <input id="recipient" placeholder="Gift Recipient ID"><br>
      <div class="amount-btns">
        <button onclick="setAmount(10)">10</button>
        <button onclick="setAmount(50)">50</button>
        <button onclick="setAmount(100)">100</button>
        <button onclick="setAmount(200)">200</button>
        <button onclick="setAmount(500)">500</button>
        <button onclick="setAmount(1000)">1000</button>
        <button onclick="setAmount(2000)">2000</button>
        <button onclick="setAmount(5000)">5000</button>
        <button onclick="setAmount(10000)">10000</button>
        <button onclick="setAmount(20000)">20000</button>
      </div>
      <input id="amount" placeholder="Amount" readonly><br>
      <button class="btn" onclick="placeOrder()">Submit</button>
    </div>

    <!-- History -->
    <div id="history" class="hidden">
      <h2>My Orders</h2>
      <table>
        <thead>
          <tr><th>ID</th><th>Recipient</th><th>Amount</th><th>Status</th><th>Time</th></tr>
        </thead>
        <tbody id="orderList"></tbody>
      </table>
    </div>

    <!-- Profile -->
    <div id="profile" class="hidden">
      <h2>My Profile</h2>
      <p>Email: <span id="profileEmail"></span></p>
      <p>Name: <input id="profileName"></p>
      <p>Phone: <input id="profilePhone"></p>
      <button class="btn" onclick="updateProfile()">Update</button>
    </div>

    <!-- Admin -->
    <div id="admin" class="hidden">
      <h2>All Orders</h2>
      <table>
        <thead>
          <tr><th>ID</th><th>User</th><th>Recipient</th><th>Amount</th><th>Status</th><th>Change</th></tr>
        </thead>
        <tbody id="adminOrders"></tbody>
      </table>
    </div>
  </main>

  <footer>
    <p>Â© 2025 Diamond Recharge</p>
  </footer>

  <!-- Firebase -->
  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-app.js";
    import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, updateDoc, collection, addDoc, query, where, getDocs } from "https://www.gstatic.com/firebasejs/10.12.3/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
      authDomain: "diamond-recharge-f7f59.firebaseapp.com",
      projectId: "diamond-recharge-f7f59",
      storageBucket: "diamond-recharge-f7f59.firebasestorage.app",
      messagingSenderId: "657717928489",
      appId: "1:657717928489:web:70431ebc9afb7002d4b238",
      measurementId: "G-TDK78BQ8SQ"
    };

    const app = initializeApp(firebaseConfig);
    const auth = getAuth(app);
    const db = getFirestore(app);

    let currentUser = null;

    // Sidebar toggle
    window.toggleSidebar = function() {
      document.getElementById("sidebar").classList.toggle("active");
    }

    // Show page
    window.showPage = function(id) {
      document.querySelectorAll("main > div").forEach(div => div.classList.add("hidden"));
      document.getElementById(id).classList.remove("hidden");
      document.getElementById("sidebar").classList.remove("active");
    }

    // Login
    window.login = async function() {
      const email = document.getElementById("loginEmail").value;
      const pass = document.getElementById("loginPass").value;
      try {
        await signInWithEmailAndPassword(auth, email, pass);
      } catch (e) {
        alert("Login failed: " + e.message);
      }
    }

    // Logout
    window.logout = async function() {
      await signOut(auth);
      location.reload();
    }

    // Auth state
    onAuthStateChanged(auth, async (user) => {
      if (user) {
        currentUser = user;
        document.getElementById("loginPage").classList.add("hidden");
        showPage("dashboard");
        document.getElementById("userInfo").innerText = user.email;
        loadProfile();
        loadOrders();
      } else {
        document.getElementById("loginPage").classList.remove("hidden");
      }
    });

    // Profile
    async function loadProfile() {
      const ref = doc(db, "users", currentUser.uid);
      const snap = await getDoc(ref);
      if (snap.exists()) {
        const u = snap.data();
        document.getElementById("balance").innerText = u.balance || 0;
        document.getElementById("weekly").innerText = u.weeklyDiamonds || 0;
        document.getElementById("tier").innerText = u.tier || "-";
        document.getElementById("profileEmail").innerText = currentUser.email;
        document.getElementById("profileName").value = u.name || "";
        document.getElementById("profilePhone").value = u.phone || "";
      }
    }

    window.updateProfile = async function() {
      const ref = doc(db, "users", currentUser.uid);
      await updateDoc(ref, {
        name: document.getElementById("profileName").value,
        phone: document.getElementById("profilePhone").value
      });
      alert("Profile updated!");
    }

    // Order
    let selectedAmount = 0;
    window.setAmount = function(val) {
      selectedAmount = val;
      document.getElementById("amount").value = val;
    }

    window.placeOrder = async function() {
      if (!selectedAmount) return alert("Select amount!");
      const recipient = document.getElementById("recipient").value;
      const ref = collection(db, "orders");
      await addDoc(ref, {
        user: currentUser.uid,
        email: currentUser.email,
        recipient,
        amount: selectedAmount,
        status: "WAITING",
        timestamp: new Date().toISOString()
      });
      alert("Order placed!");
      loadOrders();
      showPage("history");
    }

    async function loadOrders() {
      // User Orders
      const q = query(collection(db, "orders"), where("email", "==", currentUser.email));
      const qs = await getDocs(q);
      let rows = "";
      qs.forEach(d => {
        const o = d.data();
        rows += `<tr>
          <td>${d.id}</td>
          <td>${o.recipient}</td>
          <td>${o.amount}</td>
          <td><span class="status ${o.status}">${o.status}</span></td>
          <td>${o.timestamp}</td>
        </tr>`;
      });
      document.getElementById("orderList").innerHTML = rows;

      // Admin Orders
      const all = await getDocs(collection(db, "orders"));
      let adminRows = "";
      all.forEach(d => {
        const o = d.data();
        adminRows += `<tr>
          <td>${d.id}</td>
          <td>${o.email}</td>
          <td>${o.recipient}</td>
          <td>${o.amount}</td>
          <td><span class="status ${o.status}">${o.status}</span></td>
          <td>
            <button onclick="updateStatus('${d.id}','COMPLETED')">âœ”</button>
            <button onclick="updateStatus('${d.id}','CANCELLED')">âœ–</button>
          </td>
        </tr>`;
      });
      document.getElementById("adminOrders").innerHTML = adminRows;
    }

    window.updateStatus = async function(id, status) {
      const ref = doc(db, "orders", id);
      await updateDoc(ref, { status });
      loadOrders();
    }
  </script>
</body>
</html>