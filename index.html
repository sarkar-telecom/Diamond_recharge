<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Diamond Recharge</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: #f5f5f5;
    }
    header {
      background: #1e1e1e;
      padding: 10px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
    }
    header h1 { font-size: 18px; margin: 0; }
    .btn { padding: 8px 12px; border: none; border-radius: 6px; cursor: pointer; }
    .btn-primary { background: #007bff; color: #fff; }
    .btn-danger { background: #dc3545; color: #fff; }
    .btn-success { background: #28a745; color: #fff; }
    .container { padding: 15px; }
    .card {
      background: #1e1e1e;
      padding: 15px;
      border-radius: 10px;
      margin-bottom: 15px;
    }
    input, select {
      width: 100%;
      padding: 10px;
      margin-top: 8px;
      margin-bottom: 12px;
      border-radius: 6px;
      border: 1px solid #333;
      background: #222;
      color: #fff;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    table, th, td {
      border: 1px solid #444;
      padding: 8px;
      text-align: left;
    }
    th { background: #333; }
    .status-waiting { background: #ffc107; color: #000; padding: 3px 6px; border-radius: 4px; }
    .status-completed { background: #28a745; color: #fff; padding: 3px 6px; border-radius: 4px; }
    .status-cancelled { background: #dc3545; color: #fff; padding: 3px 6px; border-radius: 4px; }
    /* Floating Admin Panel */
    #adminPanel {
      position: fixed;
      bottom: 10px;
      right: 10px;
      background: #222;
      border: 1px solid #444;
      border-radius: 10px;
      padding: 15px;
      width: 300px;
      display: none;
      max-height: 80vh;
      overflow-y: auto;
    }
    #adminPanel h3 { margin-top: 0; }
  </style>
</head>
<body>

<header>
  <h1>ðŸ’Ž Diamond Recharge</h1>
  <div id="userInfo"></div>
  <button class="btn btn-danger" id="logoutBtn" style="display:none;">Logout</button>
</header>

<div class="container">

  <!-- Login/Register -->
  <div id="authSection" class="card">
    <h2>Login</h2>
    <input type="email" id="loginEmail" placeholder="Email">
    <input type="password" id="loginPassword" placeholder="Password">
    <button class="btn btn-primary" id="loginBtn">Login</button>
    <p>Don't have account? <a href="#" id="showRegister">Register</a></p>

    <div id="registerSection" style="display:none;">
      <h2>Register</h2>
      <input type="text" id="regName" placeholder="Name">
      <input type="email" id="regEmail" placeholder="Email">
      <input type="password" id="regPassword" placeholder="Password">
      <input type="text" id="regPhone" placeholder="Phone">
      <button class="btn btn-success" id="registerBtn">Register</button>
    </div>
  </div>

  <!-- Dashboard -->
  <div id="dashboard" style="display:none;">
    <div class="card">
      <h2>Dashboard</h2>
      <p>Name: <span id="dashName"></span></p>
      <p>Balance: ðŸ’Ž <span id="dashBalance">0</span></p>
      <p>Weekly Orders: <span id="dashWeekly">0</span></p>
    </div>

    <div class="card">
      <h2>Place Order</h2>
      <input type="text" id="orderClientId" placeholder="Game ID / Client ID">
      <input type="number" id="orderAmount" placeholder="Diamonds">
      <button class="btn btn-primary" id="placeOrderBtn">Place Order</button>
    </div>

    <div class="card">
      <h2>Order History</h2>
      <table id="orderTable">
        <thead>
          <tr>
            <th>ID</th><th>Client</th><th>Amount</th><th>Status</th><th>Time</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

</div>

<!-- Floating Admin Panel -->
<div id="adminPanel">
  <h3>Admin Orders</h3>
  <div id="adminOrders"></div>
</div>

<!-- Firebase SDK -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword, signOut } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, updateDoc, collection, addDoc, query, where, getDocs, onSnapshot } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
    authDomain: "diamond-recharge-f7f59.firebaseapp.com",
    projectId: "diamond-recharge-f7f59",
    storageBucket: "diamond-recharge-f7f59.appspot.com",
    messagingSenderId: "657717928489",
    appId: "1:657717928489:web:70431ebc9afb7002d4b238",
    measurementId: "G-TDK78BQ8SQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const authSection = document.getElementById("authSection");
  const dashboard = document.getElementById("dashboard");
  const logoutBtn = document.getElementById("logoutBtn");
  const userInfo = document.getElementById("userInfo");
  const orderTableBody = document.querySelector("#orderTable tbody");
  const adminPanel = document.getElementById("adminPanel");
  const adminOrdersDiv = document.getElementById("adminOrders");

  let currentUserData = null;

  // Register
  document.getElementById("registerBtn").addEventListener("click", async () => {
    const email = document.getElementById("regEmail").value;
    const pass = document.getElementById("regPassword").value;
    const name = document.getElementById("regName").value;
    const phone = document.getElementById("regPhone").value;

    const cred = await createUserWithEmailAndPassword(auth, email, pass);
    await setDoc(doc(db, "users", cred.user.uid), {
      email, name, phone,
      role: "user", approved: false,
      balance: 100, weeklyDiamonds: 0, avatar: ""
    });
    alert("Registered! Wait for admin approval.");
  });

  // Login
  document.getElementById("loginBtn").addEventListener("click", async () => {
    const email = document.getElementById("loginEmail").value;
    const pass = document.getElementById("loginPassword").value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch(e) { alert(e.message); }
  });

  // Auth State
  onAuthStateChanged(auth, async (user) => {
    if (user) {
      const snap = await getDoc(doc(db, "users", user.uid));
      if (snap.exists()) {
        currentUserData = snap.data();
        if (!currentUserData.approved) {
          alert("Not approved by admin yet.");
          await signOut(auth);
          return;
        }
        authSection.style.display = "none";
        dashboard.style.display = "block";
        logoutBtn.style.display = "block";
        userInfo.innerHTML = currentUserData.name + " ("+currentUserData.role+")";

        document.getElementById("dashName").innerText = currentUserData.name;
        document.getElementById("dashBalance").innerText = currentUserData.balance;
        document.getElementById("dashWeekly").innerText = currentUserData.weeklyDiamonds;

        loadOrders(user.uid);

        if (currentUserData.role === "admin") {
          loadAdminOrders();
          adminPanel.style.display = "block";
        }
      }
    } else {
      authSection.style.display = "block";
      dashboard.style.display = "none";
      logoutBtn.style.display = "none";
      userInfo.innerHTML = "";
      adminPanel.style.display = "none";
    }
  });

  // Logout
  logoutBtn.addEventListener("click", async () => {
    await signOut(auth);
  });

  // Place Order
  document.getElementById("placeOrderBtn").addEventListener("click", async () => {
    if (!currentUserData) return;
    const clientId = document.getElementById("orderClientId").value;
    const amount = parseInt(document.getElementById("orderAmount").value);
    if (amount > currentUserData.balance) {
      alert("Not enough balance!");
      return;
    }
    await addDoc(collection(db, "orders"), {
      clientId, amount, status: "WAITING",
      userEmail: auth.currentUser.email,
      userId: auth.currentUser.uid,
      timestamp: Date.now()
    });
    await updateDoc(doc(db, "users", auth.currentUser.uid), {
      balance: currentUserData.balance - amount
    });
    alert("Order placed!");
  });

  // Load Orders
  async function loadOrders(uid) {
    const q = query(collection(db, "orders"), where("userId", "==", uid));
    onSnapshot(q, (snap) => {
      orderTableBody.innerHTML = "";
      snap.forEach(docu => {
        const o = docu.data();
        const tr = document.createElement("tr");
        tr.innerHTML = `<td>${docu.id}</td>
          <td>${o.clientId}</td>
          <td>${o.amount}</td>
          <td><span class="status-${o.status.toLowerCase()}">${o.status}</span></td>
          <td>${new Date(o.timestamp).toLocaleString()}</td>`;
        orderTableBody.appendChild(tr);
      });
    });
  }

  // Admin Orders
  function loadAdminOrders() {
    const q = query(collection(db, "orders"), where("status", "==", "WAITING"));
    onSnapshot(q, (snap) => {
      adminOrdersDiv.innerHTML = "";
      snap.forEach(docu => {
        const o = docu.data();
        const div = document.createElement("div");
        div.classList.add("card");
        div.innerHTML = `
          <p><b>${o.userEmail}</b> ordered ${o.amount} for ${o.clientId}</p>
          <button class="btn btn-success">Complete</button>
          <button class="btn btn-danger">Cancel</button>
        `;
        div.querySelector(".btn-success").onclick = async () => {
          await updateDoc(doc(db, "orders", docu.id), { status: "COMPLETED" });
        };
        div.querySelector(".btn-danger").onclick = async () => {
          await updateDoc(doc(db, "orders", docu.id), { status: "CANCELLED" });
          // refund
          const usnap = await getDoc(doc(db, "users", o.userId));
          if (usnap.exists()) {
            const udata = usnap.data();
            await updateDoc(doc(db, "users", o.userId), {
              balance: udata.balance + o.amount
            });
          }
        };
        adminOrdersDiv.appendChild(div);
      });
    });
  }

  // Toggle register form
  document.getElementById("showRegister").addEventListener("click", (e) => {
    e.preventDefault();
    document.getElementById("registerSection").style.display = "block";
  });
</script>
</body>
</html>