<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sarkar Telecom ‚Äì Diamond Portal (All-in-One)</title>
<style>
  :root{
    --bg:#0f1115;--card:#171922;--line:#24283b;--muted:#97a0b5;
    --brand:#4cafef;--good:#22c55e;--bad:#ef4444;--wait:#f59e0b;
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:#e9eef6;font:14px/1.45 system-ui,Segoe UI,Roboto,Helvetica,Arial}
  a{color:var(--brand);text-decoration:none}
  /* Header */
  header{position:fixed;inset:0 0 auto 0;height:56px;background:var(--card);border-bottom:1px solid var(--line);
    display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:50}
  .left{display:flex;align-items:center;gap:10px}
  .menu-btn{border:0;background:transparent;color:#fff;font-size:22px;cursor:pointer}
  .brand{font-weight:800;color:#cfe9ff}
  .right{display:flex;align-items:center;gap:10px}
  .pill{background:#111525;border:1px solid var(--line);padding:4px 10px;border-radius:999px;font-size:12px}
  .user-chip{display:flex;align-items:center;gap:8px;background:#111525;border:1px solid var(--line);padding:4px 8px;border-radius:10px}
  .user-chip img{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
  /* Drawer */
  .drawer{position:fixed;inset:0 0 0 auto;width:0;transition:width .25s ease;z-index:60}
  .drawer.open{width:260px}
  .drawer .panel{position:absolute;top:0;right:0;height:100%;width:260px;background:var(--card);border-left:1px solid var(--line);display:flex;flex-direction:column}
  .drawer .links a{display:block;padding:12px 16px;border-bottom:1px solid var(--line);color:#e9eef6}
  .drawer .links a:hover{background:#1c2030}
  .scrim{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:opacity .2s;z-index:55}
  .drawer.open + .scrim{opacity:1;pointer-events:auto}
  /* Main */
  main{max-width:1100px;margin:0 auto;padding:72px 12px 80px}
  .section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin-bottom:14px}
  h2{margin:0 0 12px;font-size:18px}
  .row{display:flex;flex-wrap:wrap;gap:10px}
  .field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px}
  .field label{font-size:12px;color:var(--muted)}
  input,select,button,textarea{font:inherit}
  input,select,textarea{background:#0f1322;color:#e9eef6;border:1px solid var(--line);border-radius:10px;padding:10px}
  .btn{background:var(--brand);color:#02121c;border:0;border-radius:10px;padding:10px 14px;cursor:pointer}
  .btn:disabled{opacity:.5;cursor:not-allowed}
  .btn.outline{background:transparent;color:var(--brand);border:1px solid var(--brand)}
  .btn.danger{background:var(--bad);color:#fff}
  .btn.good{background:var(--good);color:#02150c}
  .btn.wait{background:var(--wait);color:#2b1900}
  .small{font-size:12px;color:var(--muted)}
  .w100{width:100%}
  .center{text-align:center}
  .hide{display:none !important}
  /* Gift grid */
  .gift-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
  .gift{background:#0f1322;border:2px solid transparent;border-radius:12px;padding:14px;text-align:center;cursor:pointer}
  .gift.selected{border-color:var(--brand);background:#12162a}
  .gift .price{font-weight:800}
  /* Tables */
  .table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
  table{width:100%;border-collapse:collapse;background:#0f1322}
  th,td{padding:10px;border-bottom:1px solid #20243a;text-align:center;font-size:13px;white-space:nowrap}
  th{position:sticky;top:0;background:#12162a;color:#cfe9ff;z-index:1}
  .status{display:inline-block;padding:4px 10px;border-radius:8px;font-weight:800;font-size:12px}
  .status.waiting{background:var(--wait);color:#2b1900}
  .status.completed{background:var(--good);color:#04140a}
  .status.cancelled{background:var(--bad);color:#fff}
  /* Footer */
  footer{position:fixed;inset:auto 0 0 0;height:56px;background:var(--card);border-top:1px solid var(--line);
    display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:40}
  /* Responsive */
  @media (max-width:720px){
    .gift-grid{grid-template-columns:repeat(3,1fr)}
    th,td{font-size:12px;padding:8px}
  }
</style>
</head>
<body>

<header>
  <div class="left">
    <button id="menuBtn" class="menu-btn" aria-label="Menu">‚ò∞</button>
    <div class="brand">Sarkar Telecom</div>
  </div>
  <div class="right">
    <span id="hdrUser" class="pill">Guest</span>
    <span id="hdrRole" class="pill">‚Äî</span>
    <span id="hdrBalance" class="pill">üíé 0</span>
    <div class="user-chip">
      <img id="hdrAvatar" alt="avatar" />
      <span id="hdrName">Not logged in</span>
    </div>
  </div>
</header>

<!-- Drawer -->
<div id="drawer" class="drawer">
  <div class="panel">
    <div class="links">
      <a href="#/login">üîê Login</a>
      <a href="#/register">üìù Register</a>
      <a href="#/dashboard">üè† Dashboard</a>
      <a href="#/order">‚ûï Create Order</a>
      <a href="#/history">üìë Order History</a>
      <a href="#/users">üë• Users</a>
      <a href="#/admin">üõ† Admin Panel</a>
      <a href="#/profile">üë§ Profile</a>
      <a href="#/logout">üö™ Logout</a>
    </div>
  </div>
</div>
<div id="scrim" class="scrim"></div>

<main>
  <!-- LOGIN -->
  <section id="view-login" class="section">
    <h2>Login</h2>
    <div class="row">
      <div class="field"><label>Email</label><input id="loginEmail" type="email" placeholder="admin@sarkar.com" /></div>
      <div class="field"><label>Password</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" /></div>
    </div>
    <div class="row">
      <button id="btnLogin" class="btn">Login</button>
      <button class="btn outline" onclick="go('#/register')">Create account</button>
    </div>
    <p class="small">Demo admin user: <b>admin@sarkar.com / Admin@123</b> (‡¶Ü‡¶ó‡ßá Users ‡¶∂‡¶ø‡¶ü‡ßá ‡¶Ø‡ßã‡¶ó ‡¶ï‡¶∞‡ßá ‡¶∞‡¶æ‡¶ñ‡ßÅ‡¶®)</p>
  </section>

  <!-- REGISTER -->
  <section id="view-register" class="section hide">
    <h2>Register</h2>
    <div class="row">
      <div class="field"><label>Email</label><input id="regEmail" type="email" placeholder="you@example.com" /></div>
      <div class="field"><label>Password</label><input id="regPass" type="password" /></div>
      <div class="field"><label>Full Name</label><input id="regName" type="text" placeholder="Your Name" /></div>
      <div class="field"><label>Phone</label><input id="regPhone" type="tel" placeholder="+880..." /></div>
    </div>
    <div class="row">
      <button id="btnRegister" class="btn">Submit for Approval</button>
      <button class="btn outline" onclick="go('#/login')">Back to Login</button>
    </div>
    <p class="small">Note: Admin approval ‡¶®‡¶æ ‡¶™‡¶æ‡¶ì‡ßü‡¶æ ‡¶™‡¶∞‡ßç‡¶Ø‡¶®‡ßç‡¶§ ‡¶≤‡¶ó‡¶á‡¶® ‡¶π‡¶¨‡ßá ‡¶®‡¶æ‡•§</p>
  </section>

  <!-- DASHBOARD -->
  <section id="view-dashboard" class="section hide">
    <h2>Welcome to Sarkar Telecom</h2>
    <div class="row">
      <div class="field"><label>User</label><input id="dbUser" disabled/></div>
      <div class="field"><label>Role</label><input id="dbRole" disabled/></div>
      <div class="field"><label>Balance</label><input id="dbBal" disabled/></div>
      <div class="field"><label>Weekly Total (BD)</label><input id="dbWeekly" disabled/></div>
      <div class="field"><label>Reward Tier</label><input id="dbTier" disabled/></div>
    </div>
    <div class="row">
      <button class="btn" onclick="go('#/order')">‚ûï Create Order</button>
      <button class="btn outline" onclick="go('#/history')">üìë Order History</button>
      <button class="btn outline" onclick="go('#/profile')">üë§ Profile</button>
      <button class="btn outline" onclick="go('#/users')">üë• Users</button>
      <button class="btn outline" onclick="go('#/admin')">üõ† Admin</button>
    </div>
  </section>

  <!-- ORDER CREATE -->
  <section id="view-order" class="section hide">
    <h2>Create Order</h2>
    <div class="field">
      <label>Gift Recipient (Number / Profile ID)</label>
      <input id="recipient" type="number" inputmode="numeric" placeholder="Enter Profile ID or Number" oninput="checkOrderForm()"/>
    </div>
    <div class="row gift-grid" id="giftGrid"></div>
    <div class="row">
      <button id="btnConfirm" class="btn" disabled>Order Confirm</button>
      <button class="btn outline" onclick="go('#/history')">View Order History</button>
      <span class="small">Your balance: <b id="orderBal">üíé 0</b></span>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="view-history" class="section hide">
    <h2>Order History</h2>
    <div class="row">
      <div class="field"><label>Search</label><input id="histSearch" placeholder="Order ID / Client ID / Amount / Time"/></div>
      <div class="field">
        <label>Status</label>
        <select id="histStatus">
          <option value="">All</option>
          <option value="waiting">Waiting</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
      </div>
      <div class="field"><label>Weekly Total (BD)</label><input id="histWeekly" disabled/></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Order ID</th><th>Client ID</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
        <tbody id="histBody"></tbody>
      </table>
    </div>
    <div id="histPager" class="row"></div>
    <div class="row">
      <button class="btn" onclick="go('#/order')">‚ûï Create New Order</button>
      <div class="pill" id="tierBadge">Tier: ‚Äì</div>
    </div>
  </section>

  <!-- USERS -->
  <section id="view-users" class="section hide">
    <h2>Registered Users</h2>
    <div class="row">
      <div class="field"><label>Find user</label><input id="userSearch" placeholder="Email / Name / Phone"/></div>
      <div class="field"><label>Role</label>
        <select id="userRoleFilter">
          <option value="">All</option>
          <option value="admin">Admin</option>
          <option value="user">User</option>
          <option value="pending">Pending</option>
        </select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Logo</th><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Balance</th><th>Weekly</th><th>Tier</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
    <div class="small">Only admins can approve/reject/edit/role/balance.</div>
  </section>

  <!-- ADMIN -->
  <section id="view-admin" class="section hide">
    <h2>Admin Panel</h2>
    <div class="row">
      <div class="field"><label>Admin Balance</label><input id="adminBal" disabled/></div>
      <div class="field"><label>Pending Registrations</label><input id="adminPend" disabled/></div>
      <div class="field"><label>Weekly Reset (BD)</label><input id="adminResetInfo" disabled/></div>
    </div>
    <div class="row">
      <button id="btnManualReset" class="btn">Manual Weekly Reset</button>
      <button class="btn outline" onclick="go('#/users')">Manage Users</button>
    </div>
    <div class="section">
      <h2>Manage All Orders</h2>
      <div class="row">
        <div class="field w100"><label>Search Orders</label><input id="admOrderSearch" placeholder="Order ID / Client ID / Email / Amount / Time"/></div>
      </div>
      <div class="table-wrap">
        <table>
          <thead><tr><th>Order ID</th><th>User</th><th>Client ID</th><th>Amount</th><th>Status</th><th>Time</th><th>Action</th></tr></thead>
          <tbody id="admOrdersBody"></tbody>
        </table>
      </div>
      <div id="admPager" class="row"></div>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="view-profile" class="section hide">
    <h2>Profile</h2>
    <div class="row">
      <div class="field">
        <label>Logo</label>
        <input id="avatarFile" type="file" accept="image/*"/>
        <div class="small">Square image best</div>
        <img id="profAvatar" alt="avatar" style="width:72px;height:72px;border-radius:50%;border:1px solid var(--line);object-fit:cover;margin-top:8px"/>
      </div>
      <div class="field"><label>Name</label><input id="profName"/></div>
      <div class="field"><label>Email (read-only)</label><input id="profEmail" disabled/></div>
      <div class="field"><label>Phone</label><input id="profPhone" placeholder="+880..."/></div>
      <div class="field"><label>Password</label><input id="profPass" type="password" placeholder="Change password"/></div>
    </div>
    <div class="row">
      <button id="btnSaveProfile" class="btn">Save</button>
      <button class="btn outline" onclick="go('#/dashboard')">Back</button>
    </div>
  </section>

  <!-- LOGOUT -->
  <section id="view-logout" class="section hide center">
    <h2>Logging out‚Ä¶</h2>
    <p class="small">You will be redirected to Login.</p>
  </section>
</main>

<footer>
  <div class="small">¬© 2025 Sarkar Telecom</div>
  <div class="right">
    <span id="fReward" class="pill">Tier: ‚Äì</span>
    <span id="fBalance" class="pill">üíé 0</span>
  </div>
</footer>

<script>
/* ================== HARD-CODED CONFIG ================== */
const API = 'https://sheetdb.io/api/v1/olia09hyw73k1';
const SHEETS = { users:'Users', orders:'Orders', settings:'Settings' };

/* ================== UTIL (TIME / ID) ================== */
function now(){ return Date.now(); }
function bdNow(){ return new Date(Date.now() + 6*3600*1000); }
function lastThursday22BD(ms=bdNow().getTime()){
  const d = new Date(ms);
  const day = d.getUTCDay(); // 0..6
  const diffDays = (((day - 4) + 7) % 7);
  const lastThu = new Date(ms - diffDays*86400000);
  lastThu.setUTCHours(22,0,0,0);
  if (lastThu.getTime() > ms) lastThu.setTime(lastThu.getTime()-7*86400000);
  return lastThu.getTime();
}
function uid(){ return 'ORD' + Math.random().toString(36).slice(2,6).toUpperCase() + Date.now().toString().slice(-6); }

/* ================== LOCAL STORAGE KEYS ================== */
const LS = {
  current:'st_current',
};

/* ================== API HELPERS (SheetDB) ================== */
async function apiGet(url){
  const r = await fetch(url, {headers:{'Accept':'application/json'}});
  if(!r.ok) throw new Error('GET failed'); return r.json();
}
async function apiPost(url, data){
  const r = await fetch(url, {method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({data})});
  if(!r.ok) throw new Error('POST failed'); return r.json();
}
async function apiPatch(url, data){
  const r = await fetch(url, {method:'PATCH',headers:{'Content-Type':'application/json'},body:JSON.stringify({data})});
  if(!r.ok) throw new Error('PATCH failed'); return r.json();
}
async function apiDelete(url){
  const r = await fetch(url, {method:'DELETE'}); if(!r.ok) throw new Error('DELETE failed'); return r.json();
}

/* ================== AUTH (with persistence) ================== */
function getCurrent(){ try{ return JSON.parse(localStorage.getItem(LS.current)) }catch(e){ return null } }
function setCurrent(u){ localStorage.setItem(LS.current, JSON.stringify(u)); syncHeaderFooter(); }
function clearCurrent(){ localStorage.removeItem(LS.current); syncHeaderFooter(); }

async function login(email, pass){
  const res = await apiGet(`${API}/search?sheet=${SHEETS.users}&email=${encodeURIComponent(email)}`);
  const u = (res||[])[0];
  if(!u) throw new Error('User not found');
  if(String(u.pass)!==String(pass)) throw new Error('Wrong password');
  if(u.role!=='admin' && String(u.approved).toLowerCase()!=='true') throw new Error('Pending admin approval.');
  // normalize numeric
  u.balance = Number(u.balance||0);
  setCurrent(u);
  return u;
}

async function registerUser({email, pass, name, phone}){
  const exists = await apiGet(`${API}/search?sheet=${SHEETS.users}&email=${encodeURIComponent(email)}`);
  if(exists.length) throw new Error('Email already exists.');
  const row = {
    email, pass, name, phone,
    role:'user', approved:false, balance:0, avatar:''
  };
  await apiPost(`${API}?sheet=${SHEETS.users}`, row);
  return true;
}

function logout(){
  clearCurrent();
  go('#/login');
  document.getElementById('view-logout').classList.remove('hide');
  setTimeout(()=> go('#/login'), 1200);
}

/* ================== ROUTING ================== */
const VIEWS = ['login','register','dashboard','order','history','users','admin','profile','logout'];
function show(view){ VIEWS.forEach(v=>document.getElementById('view-'+v).classList.add('hide')); document.getElementById('view-'+view).classList.remove('hide'); }
function go(hash){ location.hash = hash; }
window.addEventListener('hashchange', onRoute);
async function onRoute(){
  const h = location.hash || '#/login';
  const route = h.split('?')[0].replace('#/','');
  const cur = getCurrent();
  const authOnly = ['dashboard','order','history','users','admin','profile','logout'];
  if(authOnly.includes(route) && !cur){ alert('Please login first'); return go('#/login'); }
  if(route==='admin' && cur?.role!=='admin'){ alert('Admin access only'); return go('#/dashboard'); }
  show(route);
  if(route==='dashboard') await renderDashboard();
  else if(route==='order') await renderOrder();
  else if(route==='history') await renderHistory();
  else if(route==='users') await renderUsers();
  else if(route==='admin') await renderAdmin();
  else if(route==='profile') await renderProfile();
  else if(route==='logout') logout();
}

/* ================== HEADER / FOOTER ================== */
function syncHeaderFooter(){
  const cur = getCurrent();
  const hdrUser = document.getElementById('hdrUser');
  const hdrRole = document.getElementById('hdrRole');
  const hdrBalance = document.getElementById('hdrBalance');
  const hdrName = document.getElementById('hdrName');
  const hdrAvatar = document.getElementById('hdrAvatar');
  const fBalance = document.getElementById('fBalance');
  const fReward = document.getElementById('fReward');
  if(!cur){
    hdrUser.textContent='Guest'; hdrRole.textContent='‚Äî'; hdrBalance.textContent='üíé 0';
    hdrName.textContent='Not logged in';
    hdrAvatar.src='data:image/svg+xml;base64,PHN2ZyBoZWlnaHQ9IjQ4IiB3aWR0aD0iNDgiIHZpZXdCb3g9IjAgMCA1MCA1MCIgZmlsbD0iI2ZmZiIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48Y2lyY2xlIGN4PSIyNSIgY3k9IjE4IiByPSIxMCIgZmlsbD0iI2JiYiIvPjxwYXRoIGQ9Ik0xMiA0MGMwLTggMjYtOCAyNiAwIiBmaWxsPSIjYmJiIi8+PC9zdmc+';
    fBalance.textContent='üíé 0'; fReward.textContent='Tier: ‚Äì';
    return;
  }
  hdrUser.textContent = cur.email;
  hdrRole.textContent = cur.role;
  hdrBalance.textContent = 'üíé ' + (Number(cur.balance||0)).toLocaleString();
  hdrName.textContent = cur.name || cur.email;
  hdrAvatar.src = cur.avatar || hdrAvatar.src;
  fBalance.textContent = 'üíé ' + (Number(cur.balance||0)).toLocaleString();
  // weekly+tier client-side (derived)
  const weekly = window._weeklyTotal || 0;
  const tier = tierFrom(weekly);
  fReward.textContent = `Tier: ${tier.level} (${tier.rate}%)`;
}

/* ================== SIDEBAR TOGGLE ================== */
const drawer = document.getElementById('drawer');
const scrim = document.getElementById('scrim');
document.getElementById('menuBtn').onclick = ()=> drawer.classList.toggle('open');
scrim.onclick = ()=> drawer.classList.remove('open');

/* ================== TIERS ================== */
const TIERS = [
  {min:800000, level:5, rate:3.5},
  {min:80000,  level:4, rate:2.6},
  {min:40000,  level:3, rate:2.1},
  {min:20000,  level:2, rate:1.6},
  {min:5000,   level:1, rate:1.0},
  {min:0,      level:0, rate:0},
];
function tierFrom(total){ for(const t of TIERS){ if(total>=t.min) return t; } return TIERS[TIERS.length-1]; }

/* ================== DASHBOARD ================== */
async function computeWeeklyFor(email){
  const startBD = lastThursday22BD();
  const all = await apiGet(`${API}?sheet=${SHEETS.orders}`);
  const mine = all.filter(o => String(o.user_email)===String(email) && String(o.status).toLowerCase()==='completed' && Number(o.timestamp||0)>=startBD);
  return mine.reduce((a,b)=> a + Number(b.amount||0), 0);
}
async function renderDashboard(){
  const u = getCurrent(); if(!u) return;
  const w = await computeWeeklyFor(u.email);
  window._weeklyTotal = w;
  const t = tierFrom(w);
  document.getElementById('dbUser').value = u.name || u.email;
  document.getElementById('dbRole').value = u.role;
  document.getElementById('dbBal').value  = 'üíé ' + Number(u.balance||0).toLocaleString();
  document.getElementById('dbWeekly').value = w.toLocaleString();
  document.getElementById('dbTier').value = `Level ${t.level} (${t.rate}%)`;
  syncHeaderFooter();
}

/* ================== ORDER CREATE ================== */
const amounts = [10,50,100,200,500,1000,2000,5000,10000,20000];
let selectedAmt = null;
async function renderOrder(){
  const u = getCurrent(); if(!u) return;
  selectedAmt = null;
  document.getElementById('recipient').value='';
  document.getElementById('orderBal').textContent = 'üíé ' + Number(u.balance||0).toLocaleString();
  const grid = document.getElementById('giftGrid');
  grid.innerHTML='';
  amounts.forEach(a=>{
    const div=document.createElement('div'); div.className='gift'; div.dataset.amount=a;
    div.innerHTML=`<div class="price">üíé ${a}</div>`;
    div.onclick=()=>{ [...grid.children].forEach(c=>c.classList.remove('selected')); div.classList.add('selected'); selectedAmt=a; checkOrderForm(); };
    grid.appendChild(div);
  });
  checkOrderForm();
}
function checkOrderForm(){
  const rec = document.getElementById('recipient').value.trim();
  document.getElementById('btnConfirm').disabled = !(rec && selectedAmt);
}
document.getElementById('btnConfirm').onclick = async ()=>{
  const u = getCurrent(); if(!u) return;
  const rec = document.getElementById('recipient').value.trim();
  const amt = Number(selectedAmt||0);
  if(!rec || !amt) return;

  // fresh user from DB to ensure latest balance
  const res = await apiGet(`${API}/search?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`);
  const me = res[0]; if(!me) return alert('User not found.');
  const curBal = Number(me.balance||0);
  if(curBal < amt) return alert('Insufficient balance.');

  // deduct balance
  await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`, { balance: curBal - amt });

  // create order (WAITING)
  const order = { id:uid(), user_email:u.email, client_id:rec, amount:amt, status:'waiting', timestamp: now() };
  await apiPost(`${API}?sheet=${SHEETS.orders}`, order);

  // update local current user balance
  u.balance = curBal - amt; setCurrent(u);

  alert(`Order submitted!\nID: ${order.id}\nAmount: üíé ${amt}`);
  go('#/history');
};

/* ================== AUTO-CANCEL (>5m) + REFUND ================== */
async function sweepAutoCancel(){
  const five = 5*60*1000, t = now();
  const all = await apiGet(`${API}?sheet=${SHEETS.orders}`);
  const waits = all.filter(o=> String(o.status).toLowerCase()==='waiting' && (t - Number(o.timestamp||0))>five );
  for(const o of waits){
    // refund to user
    const u = (await apiGet(`${API}/search?sheet=${SHEETS.users}&email=${encodeURIComponent(o.user_email)}`))[0];
    if(u){
      await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(o.user_email)}`, { balance: Number(u.balance||0) + Number(o.amount||0) });
    }
    // set cancelled
    await apiPatch(`${API}?sheet=${SHEETS.orders}&id=${encodeURIComponent(o.id)}`, { status:'cancelled' });
  }
}

/* ================== HISTORY ================== */
let histPage=1, histSize=10;
async function renderHistory(){
  await sweepAutoCancel(); // ensure stale orders are cancelled
  const cur = getCurrent(); if(!cur) return;
  const orders = await apiGet(`${API}?sheet=${SHEETS.orders}`);
  const mine = orders.filter(o=> String(o.user_email)===String(cur.email)).sort((a,b)=> Number(b.timestamp)-Number(a.timestamp));

  const search = (document.getElementById('histSearch').value||'').toLowerCase();
  const status = document.getElementById('histStatus').value;
  const filtered = mine.filter(o=>{
    const blob = `${o.id} ${o.client_id} ${o.amount} ${new Date(Number(o.timestamp)).toLocaleString()}`.toLowerCase();
    const okS = !status || String(o.status).toLowerCase()===status;
    return (!search || blob.includes(search)) && okS;
  });

  const total=filtered.length, pages=Math.max(1, Math.ceil(total/histSize));
  if(histPage>pages) histPage=pages;
  const start=(histPage-1)*histSize, end=start+histSize, slice=filtered.slice(start,end);

  const tbody=document.getElementById('histBody');
  tbody.innerHTML = slice.map(o=>`
    <tr>
      <td>${o.id}</td>
      <td>${o.client_id}</td>
      <td>üíé ${Number(o.amount||0).toLocaleString()}</td>
      <td><span class="status ${String(o.status).toLowerCase()}">${String(o.status).toUpperCase()}</span></td>
      <td>${new Date(Number(o.timestamp)).toLocaleString()}</td>
    </tr>
  `).join('');

  const pager=document.getElementById('histPager'); pager.innerHTML='';
  for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.className='btn ' + (i===histPage?'':'outline'); b.textContent=' '+i+' '; b.onclick=()=>{histPage=i; renderHistory();}; pager.appendChild(b); }

  const w = await computeWeeklyFor(cur.email);
  window._weeklyTotal = w;
  document.getElementById('histWeekly').value = w.toLocaleString();
  document.getElementById('tierBadge').textContent = `Tier: ${tierFrom(w).level}`;
}
document.getElementById('histSearch').oninput = ()=>{histPage=1;renderHistory();};
document.getElementById('histStatus').onchange = ()=>{histPage=1;renderHistory();};

/* ================== USERS (ADMIN TOOLS) ================== */
function adminUserButtons(u){
  const pending = String(u.approved).toLowerCase()!=='true';
  const isAdmin = String(u.role)==='admin';
  return `
    ${pending? `<button class="btn good" data-act="approve">Approve</button>
                <button class="btn danger" data-act="reject">Reject</button>` : ``}
    <button class="btn outline" data-act="edit">Edit</button>
    <button class="btn" data-act="addbal">Add Balance</button>
    <button class="btn outline" data-act="role">${isAdmin?'Set User':'Make Admin'}</button>
  `;
}
async function renderUsers(){
  const cur=getCurrent(); const isAdmin = cur?.role==='admin';
  const q=(document.getElementById('userSearch').value||'').toLowerCase();
  const rf=document.getElementById('userRoleFilter').value;

  const users = await apiGet(`${API}?sheet=${SHEETS.users}`);
  const tbody=document.getElementById('usersBody'); tbody.innerHTML='';

  for(const u of users){
    const name=(u.name||''); const phone=(u.phone||''); const email=u.email;
    const approved = String(u.approved).toLowerCase()==='true';
    const role = approved? u.role : 'pending';
    const matches = (!q || `${email} ${name} ${phone}`.toLowerCase().includes(q)) &&
                    (!rf || (rf==='pending'? !approved : String(u.role)===rf));
    if(!matches) continue;

    // weekly (derived)
    const w = await computeWeeklyFor(email);
    const tier = tierFrom(w);

    const tr=document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${u.avatar||'https://via.placeholder.com/36'}" style="width:36px;height:36px;border-radius:50%;object-fit:cover;border:1px solid #222"/></td>
      <td>${name||'-'}</td>
      <td>${email}</td>
      <td>${phone||'-'}</td>
      <td>${role}</td>
      <td>üíé ${Number(u.balance||0).toLocaleString()}</td>
      <td>${w.toLocaleString()}</td>
      <td>Lvl ${tier.level}</td>
      <td class="nowrap" id="cell-${email}">${isAdmin? adminUserButtons(u): '<span class="small">View only</span>'}</td>
    `;
    tbody.appendChild(tr);
    if(isAdmin) attachUserActions(u);
  }
}
document.getElementById('userSearch').oninput=renderUsers;
document.getElementById('userRoleFilter').onchange=renderUsers;

function attachUserActions(u){
  const cell=document.getElementById(`cell-${u.email}`);
  cell.querySelectorAll('button').forEach(b=>{
    b.onclick=async ()=>{
      const act=b.dataset.act;
      if(act==='approve'){ await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`, {approved:true}); }
      else if(act==='reject'){ await apiDelete(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`); }
      else if(act==='edit'){
        const name=prompt('Name', u.name||''); const phone=prompt('Phone', u.phone||''); const pass=prompt('Password (leave blank to keep)','');
        const data={}; if(name!==null) data.name=name; if(phone!==null) data.phone=phone; if(pass) data.pass=pass;
        if(Object.keys(data).length) await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`, data);
      }
      else if(act==='addbal'){
        const add = Number(prompt('Add diamonds to user:', '0'))||0;
        if(add>0){ await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`, { balance: Number(u.balance||0) + add }); }
      }
      else if(act==='role'){
        const newRole = String(u.role)==='admin' ? 'user' : 'admin';
        await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(u.email)}`, { role:newRole });
      }
      await renderUsers(); await renderAdmin(); syncHeaderFooter();
    };
  });
}

/* ================== ADMIN ORDERS ================== */
let admPage=1, admSize=10;
async function renderAdmin(){
  // Admin meta (optional settings)
  try{
    const settings = await apiGet(`${API}?sheet=${SHEETS.settings}`);
    const s = Object.fromEntries(settings.map(x=>[x.key,x.value]));
    document.getElementById('adminBal').value = 'üíé ' + (Number(s.AdminBalance||0)).toLocaleString();
    document.getElementById('adminResetInfo').value = 'Last reset (BD): ' + (s.LastResetBD? new Date(Number(s.LastResetBD)).toLocaleString() : '‚Äî');
  }catch(e){
    document.getElementById('adminBal').value='‚Äî';
    document.getElementById('adminResetInfo').value='‚Äî';
  }
  const allUsers = await apiGet(`${API}?sheet=${SHEETS.users}`);
  const pending = allUsers.filter(u=> String(u.approved).toLowerCase()!=='true' && String(u.role)==='user').length;
  document.getElementById('adminPend').value = pending + ' pending';

  await sweepAutoCancel();

  const q=(document.getElementById('admOrderSearch').value||'').toLowerCase();
  const orders = (await apiGet(`${API}?sheet=${SHEETS.orders}`)).sort((a,b)=> Number(b.timestamp)-Number(a.timestamp));
  const filtered = orders.filter(o=>{
    const blob = `${o.id} ${o.client_id} ${o.amount} ${o.user_email} ${new Date(Number(o.timestamp)).toLocaleString()}`.toLowerCase();
    return !q || blob.includes(q);
  });

  const total=filtered.length, pages=Math.max(1, Math.ceil(total/admSize));
  if(admPage>pages) admPage=pages;
  const start=(admPage-1)*admSize, end=start+admSize, slice=filtered.slice(start,end);

  const tbody=document.getElementById('admOrdersBody');
  tbody.innerHTML = slice.map(o=>`
    <tr>
      <td>${o.id}</td>
      <td>${o.user_email}</td>
      <td>${o.client_id}</td>
      <td>üíé ${Number(o.amount||0).toLocaleString()}</td>
      <td><span class="status ${String(o.status).toLowerCase()}">${String(o.status).toUpperCase()}</span></td>
      <td>${new Date(Number(o.timestamp)).toLocaleString()}</td>
      <td class="nowrap">
        <button class="btn good" onclick="admSetStatus('${o.id}','completed')">Complete</button>
        <button class="btn danger" onclick="admSetStatus('${o.id}','cancelled')">Cancel</button>
        <button class="btn wait" onclick="admSetStatus('${o.id}','waiting')">Waiting</button>
      </td>
    </tr>
  `).join('');

  const pager=document.getElementById('admPager'); pager.innerHTML='';
  for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.className='btn ' + (i===admPage?'':'outline'); b.textContent=' '+i+' '; b.onclick=()=>{admPage=i; renderAdmin();}; pager.appendChild(b); }

  document.getElementById('btnManualReset').onclick = async ()=>{
    if(confirm('Reset weekly window now (BD)?')) {
      try{
        // save anchor in Settings sheet (optional)
        await apiPatch(`${API}?sheet=${SHEETS.settings}&key=LastResetBD`, { value:String(lastThursday22BD(bdNow().getTime())) });
      }catch(e){}
      await renderAdmin(); await renderUsers(); await renderDashboard(); await renderHistory(); syncHeaderFooter();
    }
  };
}
document.getElementById('admOrderSearch').oninput=()=>{admPage=1;renderAdmin();};

async function admSetStatus(id, status){
  // fetch order
  const o = (await apiGet(`${API}/search?sheet=${SHEETS.orders}&id=${encodeURIComponent(id)}`))[0];
  if(!o) return alert('Order not found');
  const prev = String(o.status).toLowerCase();
  if(prev===status) return;

  // refund / re-deduct
  const user = (await apiGet(`${API}/search?sheet=${SHEETS.users}&email=${encodeURIComponent(o.user_email)}`))[0];
  if(user){
    const bal = Number(user.balance||0), amt = Number(o.amount||0);
    if(status==='cancelled' && prev!=='cancelled'){
      await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(o.user_email)}`, { balance: bal + amt });
      if(getCurrent()?.email===user.email){ const cur=getCurrent(); cur.balance=bal+amt; setCurrent(cur); }
    }
    if(status==='waiting' && prev==='cancelled'){
      if(bal<amt) return alert('User balance insufficient to revert to waiting.');
      await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(o.user_email)}`, { balance: bal - amt });
      if(getCurrent()?.email===user.email){ const cur=getCurrent(); cur.balance=bal-amt; setCurrent(cur); }
    }
  }
  // set status
  await apiPatch(`${API}?sheet=${SHEETS.orders}&id=${encodeURIComponent(id)}`, { status });
  await renderAdmin(); await renderHistory(); syncHeaderFooter();
}

/* ================== PROFILE ================== */
async function renderProfile(){
  const u=getCurrent(); if(!u) return;
  document.getElementById('profAvatar').src = u.avatar || 'https://via.placeholder.com/72';
  document.getElementById('profName').value = u.name || '';
  document.getElementById('profEmail').value = u.email;
  document.getElementById('profPhone').value = u.phone || '';
  document.getElementById('profPass').value = '';
}
document.getElementById('avatarFile').addEventListener('change', async function(){
  const file=this.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=async ()=>{
    const cur=getCurrent(); if(!cur) return;
    await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(cur.email)}`, { avatar: reader.result });
    cur.avatar = reader.result; setCurrent(cur);
    document.getElementById('profAvatar').src = reader.result;
    syncHeaderFooter();
  };
  reader.readAsDataURL(file);
});
document.getElementById('btnSaveProfile').onclick = async ()=>{
  const name=document.getElementById('profName').value.trim();
  const phone=document.getElementById('profPhone').value.trim();
  const pass=document.getElementById('profPass').value;
  const cur=getCurrent(); if(!cur) return;
  const data={ name, phone }; if(pass) data.pass=pass;
  await apiPatch(`${API}?sheet=${SHEETS.users}&email=${encodeURIComponent(cur.email)}`, data);
  cur.name=name; cur.phone=phone; if(pass) cur.pass=pass; setCurrent(cur);
  alert('Profile updated.'); syncHeaderFooter();
};

/* ================== LOGIN / REGISTER BUTTONS ================== */
document.getElementById('btnLogin').onclick = async ()=>{
  const email=document.getElementById('loginEmail').value.trim().toLowerCase();
  const pass=document.getElementById('loginPass').value;
  try{
    const u = await login(email, pass);
    alert('Login success!');
    go('#/dashboard');
  }catch(e){ alert(e.message||'Login failed'); }
};
document.getElementById('btnRegister').onclick = async ()=>{
  const email=document.getElementById('regEmail').value.trim().toLowerCase();
  const pass=document.getElementById('regPass').value;
  const name=document.getElementById('regName').value.trim();
  const phone=document.getElementById('regPhone').value.trim();
  if(!email || !pass || !name) return alert('Fill required fields.');
  try{
    await registerUser({email,pass,name,phone});
    alert('Registered! Await admin approval.'); go('#/login');
  }catch(e){ alert(e.message||'Registration failed'); }
};

/* ================== LIVE SYNC (reload view on storage change) ================== */
window.addEventListener('storage', ()=>{
  syncHeaderFooter();
  const route=(location.hash||'#/login').replace('#/','');
  if(route==='history') renderHistory();
  if(route==='admin') renderAdmin();
  if(route==='users') renderUsers();
  if(route==='dashboard') renderDashboard();
  if(route==='order') renderOrder();
});

/* ================== BOOT ================== */
document.getElementById('menuBtn').addEventListener('click', ()=> drawer.classList.toggle('open'));
scrim.addEventListener('click', ()=> drawer.classList.remove('open'));

(async function boot(){
  syncHeaderFooter();
  // keep user logged-in across refresh (localStorage already does that)
  onRoute();
})();
</script>
</body>
</html>