<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Diamond Recharge</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { background:#121212; color:#fff; font-family:Arial, sans-serif; margin:0; }
    header, footer { background:#1f1f1f; padding:10px; text-align:center; }
    nav { background:#222; padding:10px; text-align:center; }
    nav button { margin:5px; }
    .hidden { display:none; }
    .card { background:#1f1f1f; margin:10px; padding:20px; border-radius:10px; }
    .btn { background:#444; color:#fff; border:none; padding:10px; border-radius:5px; cursor:pointer; }
    .btn:hover { background:#666; }
    .status-waiting { background:#ff9800; padding:5px 10px; border-radius:5px; }
    .status-completed { background:#4caf50; padding:5px 10px; border-radius:5px; }
    .status-cancelled { background:#f44336; padding:5px 10px; border-radius:5px; }
  </style>
</head>
<body>

<header>
  <h1>ðŸ’Ž Diamond Recharge</h1>
  <div id="userInfo"></div>
</header>

<nav>
  <button onclick="showPage('login')">Login</button>
  <button onclick="showPage('register')">Register</button>
  <button onclick="showPage('dashboard')">Dashboard</button>
  <button onclick="showPage('orders')">Order</button>
  <button onclick="showPage('history')">Order History</button>
  <button onclick="showPage('profile')">Profile</button>
  <button onclick="showPage('admin')">Admin</button>
  <button onclick="logout()">Logout</button>
</nav>

<main>
  <!-- Login -->
  <section id="login" class="card">
    <h2>Login</h2>
    <input id="loginEmail" placeholder="Email"><br><br>
    <input id="loginPass" type="password" placeholder="Password"><br><br>
    <button class="btn" onclick="login()">Login</button>
  </section>

  <!-- Register -->
  <section id="register" class="card hidden">
    <h2>Register</h2>
    <input id="regName" placeholder="Name"><br><br>
    <input id="regEmail" placeholder="Email"><br><br>
    <input id="regPhone" placeholder="Phone"><br><br>
    <input id="regPass" type="password" placeholder="Password"><br><br>
    <button class="btn" onclick="register()">Register</button>
  </section>

  <!-- Dashboard -->
  <section id="dashboard" class="card hidden">
    <h2>Dashboard</h2>
    <p>Welcome! Manage everything from here.</p>
    <button class="btn" onclick="showPage('orders')">Make Order</button>
    <button class="btn" onclick="showPage('history')">View History</button>
    <button class="btn" onclick="showPage('profile')">Profile</button>
    <button class="btn" onclick="showPage('admin')">Admin Panel</button>
  </section>

  <!-- Orders -->
  <section id="orders" class="card hidden">
    <h2>Make Order</h2>
    <input id="orderAmount" type="number" placeholder="Enter diamonds"><br><br>
    <button class="btn" onclick="makeOrder()">Submit Order</button>
  </section>

  <!-- Order History -->
  <section id="history" class="card hidden">
    <h2>Order History</h2>
    <div id="orderList"></div>
  </section>

  <!-- Profile -->
  <section id="profile" class="card hidden">
    <h2>Profile</h2>
    <input id="profName" placeholder="Name"><br><br>
    <input id="profPhone" placeholder="Phone"><br><br>
    <input id="profAvatar" placeholder="Avatar URL"><br><br>
    <button class="btn" onclick="updateProfile()">Update Profile</button>
  </section>

  <!-- Admin -->
  <section id="admin" class="card hidden">
    <h2>Admin Panel</h2>
    <div id="adminUsers"></div>
    <div id="adminOrders"></div>
  </section>
</main>

<footer>
  <p>ðŸ’Ž Balance: <span id="footBalance">0</span> | Reward: <span id="footReward">N/A</span></p>
  <p>&copy; 2025 Diamond Recharge</p>
</footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-app.js";
  import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword,
           signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-auth.js";
  import { getFirestore, doc, setDoc, getDoc, getDocs, updateDoc,
           addDoc, collection, query, where } from "https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore.js";

  // ðŸ”¹ à¦†à¦ªà¦¨à¦¾à¦° Firebase Config (à¦†à¦ªà¦¨à¦¿ à¦†à¦—à§‡ à¦¦à¦¿à§Ÿà§‡à¦›à§‡à¦¨ à¦¸à§‡à¦Ÿà¦¾à¦‡ à¦¬à¦¸à¦¾à¦¨à§‹ à¦¹à¦²à§‹)
  const firebaseConfig = {
    apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
    authDomain: "diamond-recharge-f7f59.firebaseapp.com",
    projectId: "diamond-recharge-f7f59",
    storageBucket: "diamond-recharge-f7f59.appspot.com",
    messagingSenderId: "657717928489",
    appId: "1:657717928489:web:70431ebc9afb7002d4b238",
    measurementId: "G-TDK78BQ8SQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;

  // ðŸ”¹ Show Page
  function showPage(id) {
    document.querySelectorAll("main section").forEach(sec => sec.classList.add("hidden"));
    document.getElementById(id).classList.remove("hidden");
  }

  // ðŸ”¹ Register
  async function register() {
    const email = regEmail.value, pass = regPass.value;
    const name = regName.value, phone = regPhone.value;
    try {
      const userCred = await createUserWithEmailAndPassword(auth, email, pass);
      await setDoc(doc(db, "users", userCred.user.uid), {
        email, name, phone, role:"user", approved:false,
        balance:100, weeklyDiamonds:0, avatar:""
      });
      alert("Registered! Wait for admin approval.");
    } catch(e){ alert(e.message); }
  }

  // ðŸ”¹ Login
  async function login() {
    const email = loginEmail.value, pass = loginPass.value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
    } catch(e){ alert("Login failed: " + e.message); }
  }

  // ðŸ”¹ Logout
  async function logout(){ await signOut(auth); }

  // ðŸ”¹ Make Order
  async function makeOrder(){
    const amount = parseInt(orderAmount.value);
    if(!currentUser) return;
    const userDoc = await getDoc(doc(db,"users",currentUser.uid));
    const data = userDoc.data();
    if(amount>data.balance){ alert("Not enough balance!"); return; }
    await addDoc(collection(db,"orders"),{
      clientId:currentUser.uid, amount, status:"WAITING",
      userEmail:data.email, timestamp:Date.now(),
      autoCancelAt: Date.now()+5*60*1000
    });
    await updateDoc(doc(db,"users",currentUser.uid), { balance:data.balance-amount });
    alert("Order placed!");
    loadOrders();
  }

  // ðŸ”¹ Load Orders
  async function loadOrders(){
    if(!currentUser) return;
    orderList.innerHTML="";
    const q = query(collection(db,"orders"), where("clientId","==",currentUser.uid));
    const snap = await getDocs(q);
    snap.forEach(docu=>{
      const d=docu.data();
      const st = d.status=="WAITING"?"status-waiting":d.status=="COMPLETED"?"status-completed":"status-cancelled";
      orderList.innerHTML += `<p>#${docu.id} - ${d.amount} ðŸ’Ž <span class="${st}">${d.status}</span></p>`;
    });
  }

  // ðŸ”¹ Update Profile
  async function updateProfile(){
    if(!currentUser) return;
    await updateDoc(doc(db,"users",currentUser.uid), {
      name:profName.value, phone:profPhone.value, avatar:profAvatar.value
    });
    alert("Profile updated!");
  }

  // ðŸ”¹ Admin Panel
  async function loadAdmin(){
    if(!currentUser) return;
    adminUsers.innerHTML="<h3>Users</h3>";
    const users = await getDocs(collection(db,"users"));
    users.forEach(u=>{
      const d=u.data();
      adminUsers.innerHTML+=`<p>${d.email} | Role:${d.role} | Bal:${d.balance} | Approved:${d.approved}</p>`;
    });

    adminOrders.innerHTML="<h3>Orders</h3>";
    const orders = await getDocs(collection(db,"orders"));
    orders.forEach(o=>{
      const d=o.data();
      adminOrders.innerHTML+=`<p>${d.userEmail} - ${d.amount} ðŸ’Ž [${d.status}]</p>`;
    });
  }

  // ðŸ”¹ Auth listener
  onAuthStateChanged(auth, async user=>{
    if(user){
      currentUser=user;
      const uDoc=await getDoc(doc(db,"users",user.uid));
      if(!uDoc.exists()) return;
      const u=uDoc.data();
      userInfo.innerHTML=`Logged in as ${u.name} (${u.role})`;
      footBalance.innerText=u.balance;
      footReward.innerText=u.weeklyDiamonds;
      showPage("dashboard");
      loadOrders();
      if(u.role=="admin") loadAdmin();
    } else {
      currentUser=null;
      userInfo.innerHTML="Not logged in";
      showPage("login");
    }
  });

  window.showPage=showPage;
  window.register=register;
  window.login=login;
  window.logout=logout;
  window.makeOrder=makeOrder;
  window.updateProfile=updateProfile;
</script>
</body>
</html>