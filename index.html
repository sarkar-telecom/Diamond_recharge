<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sarkar Telecom ‚Äî Diamond Portal</title>
<meta name="color-scheme" content="dark light">
<style>
  :root{
    --bg:#0f1115;--panel:#161a22;--muted:#aab0bd;--line:#232937;--brand:#4cafef;
    --ok:#2ecc71;--warn:#f1c40f;--bad:#e74c3c;--text:#e9eef7;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;background:var(--bg);color:var(--text);-webkit-font-smoothing:antialiased}
  a{color:inherit}
  /* Header */
  header{
    position:fixed;top:0;left:0;right:0;height:60px;background:var(--panel);
    display:flex;align-items:center;justify-content:space-between;padding:0 12px;
    border-bottom:1px solid var(--line);z-index:1001
  }
  .left{display:flex;align-items:center;gap:10px}
  .brand{margin:0;font-size:16px;color:var(--brand);white-space:nowrap}
  .hamb{border:none;background:transparent;color:#fff;font-size:26px;cursor:pointer;line-height:1}
  .right{display:flex;align-items:center;gap:10px}
  .user-pill{display:flex;align-items:center;gap:10px;background:#121620;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .user-pill img{width:28px;height:28px;border-radius:50%;object-fit:cover;background:#222}
  .user-meta{display:flex;flex-direction:column;line-height:1.1}
  .user-meta .name{font-size:12px}
  .user-meta .role{font-size:11px;color:var(--muted)}
  .hud{display:flex;gap:8px;flex-wrap:wrap}
  .chip{padding:5px 10px;border-radius:999px;border:1px solid var(--line);background:#121620;font-size:12px;color:#dfe6f3}
  /* Sidebar */
  .backdrop{position:fixed;inset:0;background:rgba(0,0,0,.35);backdrop-filter:saturate(120%) blur(2px);opacity:0;pointer-events:none;transition:.2s;z-index:1000}
  .backdrop.show{opacity:1;pointer-events:auto}
  .sidebar{
    position:fixed;top:0;left:-260px;width:260px;height:100vh;background:var(--panel);
    border-right:1px solid var(--line);z-index:1001;transition:left .25s ease; padding-top:60px;overflow-y:auto
  }
  .sidebar.open{left:0}
  .side-link{display:block;padding:12px 16px;border-bottom:1px solid var(--line);color:#dbe5f7;text-decoration:none;font-size:14px}
  .side-link:hover{background:#1b2130}
  /* Main */
  main{padding:14px;max-width:1100px;margin:76px auto 90px}
  .page{display:none}
  .page.active{display:block}
  h2.section{margin:6px 0 14px 0;font-size:18px;color:var(--brand);text-align:center}
  .sub{font-size:12px;color:var(--muted)}
  /* Cards / grid */
  .card{background:var(--panel);border:1px solid var(--line);border-radius:14px;padding:14px}
  .grid{display:grid;gap:12px}
  @media(min-width:768px){
    .grid.cols-2{grid-template-columns:1fr 1fr}
    .grid.cols-3{grid-template-columns:repeat(3,1fr)}
  }
  /* Forms */
  input,select,button,textarea{
    font:inherit;border-radius:10px;border:1px solid var(--line);background:#121620;color:var(--text);padding:10px
  }
  label{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .grow{flex:1}
  .btn{background:var(--brand);border:none;color:#00101c;cursor:pointer;font-weight:700}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.warn{background:#f5c14f}
  .btn.ok{background:#66e095}
  .btn.bad{background:#ff7575}
  .btn.ghost{background:#0f131c;border:1px solid var(--line);color:#dbe5f7}
  .right-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{padding:6px 10px;border:1px solid var(--line);background:#121620;border-radius:999px}
  /* Gift buttons */
  .gift-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
  @media(min-width:520px){ .gift-grid{grid-template-columns:repeat(5,1fr)} }
  .gift{background:#121620;border:2px solid transparent;border-radius:12px;padding:14px;text-align:center;cursor:pointer}
  .gift .amt{font-weight:800}
  .gift:hover{background:#161c29}
  .gift.selected{border-color:var(--brand);background:#162030}
  /* Tables */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2b3447;text-align:center}
  th{background:#121620;color:var(--brand);position:sticky;top:0}
  /* Status pill */
  .status{display:inline-block;padding:5px 8px;border-radius:8px;font-size:12px;color:#000;font-weight:800}
  .waiting{background:var(--warn);color:#000}
  .completed{background:var(--ok);color:#000}
  .cancelled{background:var(--bad);color:#fff}
  /* Pager */
  .pager{display:flex;justify-content:center;gap:8px;margin-top:10px}
  /* Footer */
  footer{
    position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--line);
    padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;z-index:1001
  }
  .foot-left{font-size:12px;color:var(--muted)}
  .foot-right{display:flex;gap:8px;flex-wrap:wrap}
  /* Utility */
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
  .center{text-align:center}
  .hide{display:none !important}
</style>
</head>
<body>

<!-- Backdrop for drawer -->
<div id="backdrop" class="backdrop"></div>

<!-- Header -->
<header>
  <div class="left">
    <button class="hamb" id="hamb">‚ò∞</button>
    <h1 class="brand">Sarkar Telecom</h1>
  </div>
  <div class="right">
    <div class="hud">
      <span class="chip" id="hudBalance">Balance: üíé 0</span>
      <span class="chip" id="hudWeekly">Weekly: 0</span>
      <span class="chip" id="hudTier">Tier: L0 (0%)</span>
    </div>
    <div class="user-pill" id="userPill">
      <img id="userAvatar" alt="user"/>
      <div class="user-meta">
        <span class="name" id="userName">Guest</span>
        <span class="role" id="userRole">Not logged in</span>
      </div>
    </div>
  </div>
</header>

<!-- Sidebar -->
<nav class="sidebar" id="sidebar">
  <a href="#dashboard" class="side-link" data-page="dashboard">üè† Dashboard</a>
  <a href="#order" class="side-link" data-page="order">‚ûï Create Order</a>
  <a href="#history" class="side-link" data-page="history">üìë Order History</a>
  <a href="#admin-orders" class="side-link admin-only" data-page="adminOrders">üõ† Manage Orders</a>
  <a href="#admin-users" class="side-link admin-only" data-page="adminUsers">üë• User Management</a>
  <a href="#profile" class="side-link" data-page="profile">üë§ Profile</a>
  <a href="#login" class="side-link" data-page="login" id="loginLink">üîê Login / Register</a>
  <a href="#logout" class="side-link" id="logoutLink">üö™ Logout</a>
</nav>

<!-- Main -->
<main id="main">

  <!-- Dashboard -->
  <section id="page-dashboard" class="page active">
    <div class="card">
      <h2 class="section">Welcome to Sarkar Telecom</h2>
      <div class="grid cols-3">
        <div class="card">
          <label>Total Balance</label>
          <div class="mt8"><span id="dashBalance" class="pill">üíé 0</span></div>
        </div>
        <div class="card">
          <label>Weekly Diamonds (Thu 10 PM BD ‚Üí Thu 10 PM BD)</label>
          <div class="mt8"><span id="dashWeekly" class="pill">0</span></div>
        </div>
        <div class="card">
          <label>Reward Tier</label>
          <div class="mt8"><span id="dashTier" class="pill">L0 (0%)</span></div>
        </div>
      </div>
      <div class="right-actions mt16">
        <button class="btn" data-page="order">Create Order</button>
        <button class="btn ghost" data-page="history">View Order History</button>
        <button class="btn ghost admin-only" data-page="adminOrders">Admin: Manage Orders</button>
      </div>
    </div>
  </section>

  <!-- Order -->
  <section id="page-order" class="page">
    <div class="card">
      <h2 class="section">Gifting Order</h2>
      <div class="grid cols-2">
        <div class="card">
          <label>Gift Recipient (Number / Profile ID)</label>
          <input id="recipientInput" type="text" placeholder="Enter Profile ID or Number" class="mt8"/>
        </div>
        <div class="card">
          <label>Selected Amount (üíé)</label>
          <input id="selectedAmount" type="text" disabled class="mt8" value="0"/>
        </div>
      </div>
      <div class="mt12">
        <label>Select a Gift</label>
        <div class="gift-grid mt8" id="giftGrid"></div>
      </div>
      <div class="right-actions mt16">
        <button class="btn" id="confirmOrderBtn" disabled>Order Confirm</button>
      </div>
      <div class="mt12 sub">
        Note: Orders auto-cancel after 5 minutes if not completed by admin. Cancel refunds the client balance immediately.
      </div>
    </div>
  </section>

  <!-- Order History -->
  <section id="page-history" class="page">
    <div class="card">
      <h2 class="section">Order History</h2>
      <div class="row">
        <input id="histSearch" class="grow" placeholder="Search by Order ID, Client ID, Amount, Time‚Ä¶" />
        <select id="histStatus">
          <option value="">All Status</option>
          <option value="waiting">Waiting</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button class="btn" data-page="order">‚ûï Create Order</button>
      </div>
      <div class="mt12">
        <div class="row">
          <span class="pill">Weekly Diamonds: <b id="histWeekly">0</b></span>
          <span class="pill">Reward Tier: <b id="histTier">L0 (0%)</b></span>
        </div>
      </div>
      <div class="table-wrap mt12">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Client ID</th>
              <th>Amount (üíé)</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="pager mt12">
        <button class="btn ghost" id="histPrev">Prev</button>
        <span id="histPageInfo" class="pill">Page 1</span>
        <button class="btn ghost" id="histNext">Next</button>
      </div>
    </div>
  </section>

  <!-- Admin: Manage Orders -->
  <section id="page-adminOrders" class="page">
    <div class="card">
      <h2 class="section">Admin ‚Äî Manage All Orders</h2>
      <div class="row">
        <input id="adminOrderSearch" class="grow" placeholder="Search by Order ID, Client ID, Email, Amount, Time‚Ä¶" />
        <select id="adminOrderStatus">
          <option value="">All Status</option>
          <option value="waiting">Waiting</option>
          <option value="completed">Completed</option>
          <option value="cancelled">Cancelled</option>
        </select>
        <button id="manualSweep" class="btn warn">Run Auto-Cancel Sweep</button>
      </div>
      <div class="table-wrap mt12">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>User Email</th>
              <th>Client ID</th>
              <th>Amount (üíé)</th>
              <th>Status</th>
              <th>Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminOrdersBody"></tbody>
        </table>
      </div>
      <div class="pager mt12">
        <button class="btn ghost" id="adminOrdersPrev">Prev</button>
        <span id="adminOrdersPageInfo" class="pill">Page 1</span>
        <button class="btn ghost" id="adminOrdersNext">Next</button>
      </div>
    </div>
  </section>

  <!-- Admin: Manage Users -->
  <section id="page-adminUsers" class="page">
    <div class="card">
      <h2 class="section">Admin ‚Äî User Management</h2>
      <div class="row">
        <input id="userSearch" class="grow" placeholder="Search by name, email, phone‚Ä¶" />
        <button id="addUserBtn" class="btn">Add New User</button>
      </div>
      <div class="table-wrap mt12">
        <table>
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Status</th>
              <th>Balance (üíé)</th>
              <th>Weekly</th>
              <th>Tier</th>
              <th>+ / ‚àí Balance</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminUsersBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Profile -->
  <section id="page-profile" class="page">
    <div class="card">
      <h2 class="section">Profile</h2>
      <div class="grid cols-2">
        <div class="card">
          <label>Avatar</label>
          <div class="row mt8">
            <img id="profAvatarPreview" style="width:72px;height:72px;border-radius:50%;object-fit:cover;background:#222"/>
            <input id="profAvatarInput" type="file" accept="image/*"/>
          </div>
        </div>
        <div class="card">
          <label>Name</label>
          <input id="profName" class="mt8" placeholder="Your Name"/>
          <label class="mt8">Phone</label>
          <input id="profPhone" placeholder="+8801..."/>
          <label class="mt8">Change Password</label>
          <input id="profPass" type="password" placeholder="New Password"/>
        </div>
      </div>
      <div class="right-actions mt16">
        <button class="btn" id="saveProfileBtn">Save Profile</button>
      </div>
    </div>
  </section>

  <!-- Login / Register -->
  <section id="page-login" class="page">
    <div class="card">
      <h2 class="section">Login / Register</h2>
      <div class="grid cols-2">
        <div class="card">
          <h3 class="section" style="margin-top:0">Login</h3>
          <label>Email</label>
          <input id="loginEmail" placeholder="email@example.com" class="mt8"/>
          <label class="mt8">Password</label>
          <input id="loginPass" type="password" placeholder="password"/>
          <div class="mt12">
            <button id="doLogin" class="btn">Login</button>
            <button id="forgotPass" class="btn ghost mt8">Forgot password?</button>
          </div>
          <div class="mt8 sub">No account? Go to Register ‚Üí</div>
        </div>
        <div class="card">
          <h3 class="section" style="margin-top:0">Register</h3>
          <label>Email</label>
          <input id="regEmail" placeholder="email@example.com" class="mt8"/>
          <label class="mt8">Password</label>
          <input id="regPass" type="password" placeholder="password"/>
          <label class="mt8">Name</label>
          <input id="regName" placeholder="Your name"/>
          <label class="mt8">Phone</label>
          <input id="regPhone" placeholder="+8801..."/>
          <div class="mt12">
            <button id="doRegister" class="btn">Register (Needs Admin Approval)</button>
          </div>
          <div class="mt8 sub">
            After registering, an admin must approve your account before you can log in.
          </div>
        </div>
      </div>
    </div>
  </section>

</main>

<!-- Footer -->
<footer>
  <div class="foot-left">¬© 2025 Sarkar Telecom. All rights reserved.</div>
  <div class="foot-right">
    <span class="chip" id="footBalance">Balance: üíé 0</span>
    <span class="chip" id="footWeekly">Weekly: 0</span>
    <span class="chip" id="footTier">Tier: L0 (0%)</span>
  </div>
</footer>

<!-- Firebase (Modular v10 CDN) -->
<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
  import {
    getAuth, setPersistence, browserLocalPersistence,
    onAuthStateChanged, signInWithEmailAndPassword, createUserWithEmailAndPassword,
    sendPasswordResetEmail, signOut, updatePassword
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
  import {
    getFirestore, doc, getDoc, setDoc, updateDoc, onSnapshot,
    collection, addDoc, serverTimestamp, query, where, orderBy, limit, getDocs,
    runTransaction, writeBatch, Timestamp
  } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";
  import { getStorage, ref as sRef, uploadBytes, getDownloadURL } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-storage.js";

  /* ========= Config (Your given config) ========= */
  const firebaseConfig = {
    apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
    authDomain: "diamond-recharge-f7f59.firebaseapp.com",
    projectId: "diamond-recharge-f7f59",
    storageBucket: "diamond-recharge-f7f59.firebasestorage.app",
    messagingSenderId: "657717928489",
    appId: "1:657717928489:web:70431ebc9afb7002d4b238",
    measurementId: "G-TDK78BQ8SQ"
  };

  /* ========= Init ========= */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db   = getFirestore(app);
  const storage = getStorage(app);
  await setPersistence(auth, browserLocalPersistence);

  /* ========= UI Helpers ========= */
  const $ = id => document.getElementById(id);
  const sidebar = $('sidebar'), backdrop = $('backdrop');
  const pages = {
    dashboard:'page-dashboard', order:'page-order', history:'page-history',
    adminOrders:'page-adminOrders', adminUsers:'page-adminUsers', profile:'page-profile', login:'page-login'
  };
  const giftAmounts = [10,50,100,200,500,1000,2000,5000,10000,20000];

  function showSidebar(open){
    sidebar.classList.toggle('open', open);
    backdrop.classList.toggle('show', open);
  }
  $('hamb').addEventListener('click', ()=> showSidebar(true));
  backdrop.addEventListener('click', ()=> showSidebar(false));
  document.querySelectorAll('.side-link[data-page], .btn[data-page]').forEach(el=>{
    el.addEventListener('click', (e)=>{
      e.preventDefault();
      const page = el.getAttribute('data-page');
      showPage(page);
      showSidebar(false);
    });
  });
  function showPage(key){
    Object.values(pages).forEach(id=>$(id).classList.remove('active'));
    const id = pages[key] || pages.dashboard;
    $(id).classList.add('active');
  }

  function tierInfo(total){
    if(total>=800000) return {level:5, pct:3.5};
    if(total>=80000)  return {level:4, pct:2.6};
    if(total>=40000)  return {level:3, pct:2.1};
    if(total>=20000)  return {level:2, pct:1.6};
    if(total>=5000)   return {level:1, pct:1.0};
    return {level:0, pct:0};
  }
  // BD time boundary: last Thursday 22:00
  function bdNow(){ const d=new Date(); return new Date(d.getTime()+d.getTimezoneOffset()*60000+6*3600000); }
  function currentBoundary(){
    const d = bdNow(); const day=d.getDay(); // 0 Sun..4 Thu
    const diffToThu = (day - 4 + 7) % 7;
    const lastThu = new Date(d.getFullYear(), d.getMonth(), d.getDate()-diffToThu, 22,0,0,0);
    return lastThu.getTime();
  }

  /* ========= State ========= */
  let me = null;          // auth user
  let meDoc = null;       // users/{uid}
  let unsubUser = null;
  let unsubMyOrders = null;
  let unsubAllOrders = null;
  let unsubUsersAdmin = null;

  /* ========= Render HUD from user + weekly ========= */
  async function computeWeeklyAndRender(){
    if(!me) return;
    const startEpoch = currentBoundary();
    const qRef = query(
      collection(db,'orders'),
      where('userId','==', me.uid),
      where('status','==','completed'),
      where('ts','>=', Timestamp.fromMillis(startEpoch))
    );
    let weekly = 0;
    const snap = await getDocs(qRef);
    snap.forEach(d=> weekly += (d.data().amount||0));

    const info = tierInfo(weekly);

    // Header/Foot/Dashboard
    const bal = meDoc?.balance||0;
    $('hudBalance').textContent = `Balance: üíé ${bal.toLocaleString()}`;
    $('hudWeekly').textContent = `Weekly: ${weekly.toLocaleString()}`;
    $('hudTier').textContent    = `Tier: L${info.level} (${info.pct}%)`;

    $('footBalance').textContent = `Balance: üíé ${bal.toLocaleString()}`;
    $('footWeekly').textContent  = `Weekly: ${weekly.toLocaleString()}`;
    $('footTier').textContent    = `Tier: L${info.level} (${info.pct}%)`;

    $('dashBalance').textContent = `üíé ${bal.toLocaleString()}`;
    $('dashWeekly').textContent  = weekly.toLocaleString();
    $('dashTier').textContent    = `L${info.level} (${info.pct}%)`;

    // History header badges
    $('histWeekly').textContent  = weekly.toLocaleString();
    $('histTier').textContent    = `L${info.level} (${info.pct}%)`;
  }

  function renderUserHeader(){
    const avatar = meDoc?.avatar || '';
    $('userAvatar').src = avatar || 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="%23222"/><text x="50%" y="54%" font-size="20" fill="%23aaa" text-anchor="middle">üë§</text></svg>';
    $('userName').textContent = meDoc ? (meDoc.name || me.email) : 'Guest';
    $('userRole').textContent = meDoc ? `${me.email} (${meDoc.role||'user'})` : 'Not logged in';
    // Admin links
    document.querySelectorAll('.admin-only').forEach(el=>{
      el.style.display = (meDoc && meDoc.role==='admin') ? 'inline-block' : 'none';
    });
    $('loginLink').style.display = me ? 'none':'block';
    $('logoutLink').style.display = me ? 'block':'none';
  }

  /* ========= Gifts UI ========= */
  function renderGifts(){
    const grid = $('giftGrid'); if(!grid) return;
    grid.innerHTML='';
    giftAmounts.forEach(amt=>{
      const d = document.createElement('div');
      d.className='gift'; d.dataset.amount=String(amt);
      d.innerHTML = `<div class="amt">üíé ${amt.toLocaleString()}</div>`;
      d.addEventListener('click', ()=>{
        document.querySelectorAll('.gift').forEach(g=>g.classList.remove('selected'));
        d.classList.add('selected'); $('selectedAmount').value = amt;
        enableOrderConfirmCheck();
      });
      grid.appendChild(d);
    });
  }
  function enableOrderConfirmCheck(){
    const recip = $('recipientInput').value.trim();
    const amt = Number($('selectedAmount').value || 0);
    const bal = meDoc?.balance||0;
    $('confirmOrderBtn').disabled = !(me && meDoc && meDoc.status==='active' && recip && amt>0 && bal>=amt);
  }
  $('recipientInput')?.addEventListener('input', enableOrderConfirmCheck);

  /* ========= Orders ========= */
  function uid(){ return 'ORD' + Date.now().toString(36) + Math.random().toString(36).slice(2,6).toUpperCase(); }

  async function createOrder(){
    if(!me || !meDoc) return alert('Login first.');
    if(meDoc.status!=='active') return alert('You are not approved yet.');
    const clientId = $('recipientInput').value.trim();
    const amt = Number($('selectedAmount').value||0);
    if(!clientId) return alert('Enter client ID/number.');
    if(!amt) return alert('Select a diamond amount.');
    if((meDoc.balance||0) < amt) return alert('Insufficient balance.');

    const ordersCol = collection(db,'orders');
    const userRef = doc(db,'users', me.uid);

    // Transaction: deduct balance, create order
    await runTransaction(db, async (trx)=>{
      const userSnap = await trx.get(userRef);
      if(!userSnap.exists()) throw new Error('User doc missing.');
      const bal = userSnap.data().balance||0;
      if(bal < amt) throw new Error('Insufficient balance.');
      trx.update(userRef, { balance: bal - amt });

      const orderRef = doc(ordersCol); // custom id
      trx.set(orderRef, {
        id: orderRef.id,
        userId: me.uid,
        userEmail: me.email,
        clientId,
        amount: amt,
        status: 'waiting',
        ts: serverTimestamp(),
        expiresAt: Timestamp.fromMillis(Date.now()+5*60*1000),
        refunded: false
      });
    });

    // reset form, go to history
    $('recipientInput').value=''; $('selectedAmount').value='0';
    document.querySelectorAll('.gift').forEach(g=>g.classList.remove('selected'));
    $('confirmOrderBtn').disabled = true;
    showPage('history');
  }
  $('confirmOrderBtn').addEventListener('click', createOrder);

  // Auto-cancel sweep (admin cancels globally; user cancels own expired)
  async function autoCancelSweepGlobal(){
    if(!meDoc || meDoc.role!=='admin') return;
    const qRef = query(collection(db,'orders'), where('status','==','waiting'), orderBy('ts','desc'), limit(200));
    const snap = await getDocs(qRef);
    const batch = writeBatch(db);
    let changed=0;
    const now = Date.now();
    snap.forEach(d=>{
      const o=d.data();
      const exp = (o.expiresAt?.toMillis?.() ?? 0);
      if(exp && now>exp){
        // refund user balance if not refunded
        const userRef = doc(db,'users', o.userId);
        batch.update(doc(db,'orders', d.id), { status:'cancelled', refunded:true });
        batch.update(userRef, { balance: (o._bal_noop||0) }); // placeholder: we will use transaction per doc
        changed++;
      }
    });
    // Because we need to add exact refund amounts, do per-order transaction:
    for (const d of snap.docs){
      const o=d.data();
      const exp = (o.expiresAt?.toMillis?.() ?? 0);
      if(exp && now>exp && o.status==='waiting'){
        await runTransaction(db, async (trx)=>{
          const oRef = doc(db,'orders', d.id);
          const fresh = await trx.get(oRef);
          const curr = fresh.data();
          if(curr.status!=='waiting') return;
          const uRef = doc(db,'users', curr.userId);
          const uSnap = await trx.get(uRef);
          if(!uSnap.exists()) return;
          const ubal = uSnap.data().balance||0;
          trx.update(uRef, { balance: ubal + (curr.amount||0) });
          trx.update(oRef, { status:'cancelled', refunded:true });
        });
      }
    }
  }
  $('manualSweep').addEventListener('click', autoCancelSweepGlobal);
  // Also run periodically (only for admins)
  setInterval(()=>{ if(meDoc?.role==='admin') autoCancelSweepGlobal().catch(()=>{}); }, 15000);

  /* ========= Order History (my orders) ========= */
  let histPage=1, histPageSize=10;
  let myOrders = [];
  function matchFilter(order, text, status){
    const t = text.toLowerCase();
    const fields = [
      order.id, order.clientId, String(order.amount),
      (order.ts?.toDate?.()||new Date()).toLocaleString().toLowerCase()
    ].join(' ').toLowerCase();
    if(t && !fields.includes(t)) return false;
    if(status && order.status!==status) return false;
    return true;
  }
  function renderHistory(){
    if(!me) return;
    const text = $('histSearch').value.trim();
    const status = $('histStatus').value;
    const all = [...myOrders].sort((a,b)=> (b.ts?.toMillis?.()||0)-(a.ts?.toMillis?.()||0));
    const filtered = all.filter(o=>matchFilter(o,text,status));

    const totalPages = Math.max(1, Math.ceil(filtered.length/histPageSize));
    histPage = Math.min(histPage, totalPages);
    const start = (histPage-1)*histPageSize;
    const pageData = filtered.slice(start, start+histPageSize);

    const tbody = $('histBody'); tbody.innerHTML='';
    pageData.forEach(o=>{
      const tr = document.createElement('tr');
      const dt = o.ts?.toDate?.() || new Date();
      tr.innerHTML = `
        <td>${o.id}</td>
        <td>${o.clientId}</td>
        <td>${(o.amount||0).toLocaleString()}</td>
        <td><span class="status ${o.status}">${o.status}</span></td>
        <td>${dt.toLocaleString()}</td>
      `;
      tbody.appendChild(tr);
    });
    $('histPageInfo').textContent = `Page ${histPage} / ${totalPages}`;
    $('histPrev').disabled = histPage<=1;
    $('histNext').disabled = histPage>=totalPages;
  }
  $('histPrev').addEventListener('click', ()=>{ histPage=Math.max(1,histPage-1); renderHistory(); });
  $('histNext').addEventListener('click', ()=>{ histPage=histPage+1; renderHistory(); });
  $('histSearch').addEventListener('input', ()=>{ histPage=1; renderHistory(); });
  $('histStatus').addEventListener('change', ()=>{ histPage=1; renderHistory(); });

  /* ========= Admin Orders ========= */
  let adminOrdersPage=1, adminOrdersPageSize=10;
  let allOrders = [];
  function renderAdminOrders(){
    if(!(meDoc && meDoc.role==='admin')) return;
    const text = $('adminOrderSearch').value.trim().toLowerCase();
    const status = $('adminOrderStatus').value;
    const filtered = allOrders
      .filter(o=>{
        const fields = [
          o.id, o.clientId, String(o.amount), o.userEmail,
          (o.ts?.toDate?.()||new Date()).toLocaleString().toLowerCase()
        ].join(' ').toLowerCase();
        if(text && !fields.includes(text)) return false;
        if(status && o.status!==status) return false;
        return true;
      })
      .sort((a,b)=> (b.ts?.toMillis?.()||0)-(a.ts?.toMillis?.()||0));

    const totalPages = Math.max(1, Math.ceil(filtered.length/adminOrdersPageSize));
    adminOrdersPage = Math.min(adminOrdersPage, totalPages);
    const start = (adminOrdersPage-1)*adminOrdersPageSize;
    const pageData = filtered.slice(start, start+adminOrdersPageSize);

    const tbody = $('adminOrdersBody'); tbody.innerHTML='';
    pageData.forEach(o=>{
      const dt = o.ts?.toDate?.()||new Date();
      const disabledC = (o.status==='completed')?'disabled':'';
      const disabledX = (o.status==='cancelled')?'disabled':'';
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${o.id}</td>
        <td>${o.userEmail||''}</td>
        <td>${o.clientId}</td>
        <td>${(o.amount||0).toLocaleString()}</td>
        <td><span class="status ${o.status}">${o.status}</span></td>
        <td>${dt.toLocaleString()}</td>
        <td class="row">
          <button class="btn ok" data-act="complete" data-id="${o.id}" ${disabledC}>Complete</button>
          <button class="btn bad" data-act="cancel" data-id="${o.id}" ${disabledX}>Cancel</button>
        </td>
      `;
      tbody.appendChild(tr);
    });

    tbody.querySelectorAll('button[data-act]').forEach(btn=>{
      btn.addEventListener('click', async ()=>{
        const id = btn.getAttribute('data-id');
        const act = btn.getAttribute('data-act');
        if(act==='complete') await adminSetOrderStatus(id,'completed');
        if(act==='cancel')   await adminSetOrderStatus(id,'cancelled');
      });
    });

    $('adminOrdersPageInfo').textContent = `Page ${adminOrdersPage} / ${totalPages}`;
    $('adminOrdersPrev').disabled = adminOrdersPage<=1;
    $('adminOrdersNext').disabled = adminOrdersPage>=totalPages;
  }
  $('adminOrdersPrev').addEventListener('click', ()=>{ adminOrdersPage=Math.max(1,adminOrdersPage-1); renderAdminOrders(); });
  $('adminOrdersNext').addEventListener('click', ()=>{ adminOrdersPage=adminOrdersPage+1; renderAdminOrders(); });
  $('adminOrderSearch').addEventListener('input', ()=>{ adminOrdersPage=1; renderAdminOrders(); });
  $('adminOrderStatus').addEventListener('change', ()=>{ adminOrdersPage=1; renderAdminOrders(); });

  async function adminSetOrderStatus(orderId, newStatus){
    if(!(meDoc && meDoc.role==='admin')) return alert('Admin only.');
    const oRef = doc(db,'orders', orderId);
    await runTransaction(db, async (trx)=>{
      const oSnap = await trx.get(oRef);
      if(!oSnap.exists()) throw new Error('Order not found.');
      const o = oSnap.data();
      if(o.status===newStatus) return;
      const userRef = doc(db,'users', o.userId);

      if(newStatus==='cancelled'){
        if(o.status==='waiting' && !o.refunded){
          const uSnap = await trx.get(userRef);
          const bal = uSnap.data().balance||0;
          trx.update(userRef, { balance: bal + (o.amount||0) });
          trx.update(oRef, { status:'cancelled', refunded:true });
        }else{
          trx.update(oRef, { status:'cancelled' });
        }
      }else if(newStatus==='completed'){
        // no wallet change; weekly is computed from completed orders
        trx.update(oRef, { status:'completed' });
      }
    });
  }

  /* ========= Admin Users ========= */
  function renderAdminUsers(users){
    if(!(meDoc && meDoc.role==='admin')) return;
    const text = $('userSearch').value.trim().toLowerCase();
    const tbody = $('adminUsersBody'); tbody.innerHTML='';
    users
      .filter(x=>{
        const f = [x.name,x.email,x.phone,x.role,x.status].join(' ').toLowerCase();
        return !text || f.includes(text);
      })
      .forEach(x=>{
        const tr = document.createElement('tr');
        tr.innerHTML = `
          <td><img src="${x.avatar||$('userAvatar').src}" style="width:36px;height:36px;border-radius:50%;object-fit:cover"/></td>
          <td><input data-k="name" data-id="${x.id}" value="${x.name||''}"/></td>
          <td><input data-k="email" data-id="${x.id}" value="${x.email||''}" disabled/></td>
          <td><input data-k="phone" data-id="${x.id}" value="${x.phone||''}"/></td>
          <td>
            <select data-k="role" data-id="${x.id}">
              <option ${x.role==='user'?'selected':''}>user</option>
              <option ${x.role==='admin'?'selected':''}>admin</option>
            </select>
          </td>
          <td>
            <select data-k="status" data-id="${x.id}">
              <option ${x.status==='active'?'selected':''}>active</option>
              <option ${x.status==='pending'?'selected':''}>pending</option>
              <option ${x.status==='blocked'?'selected':''}>blocked</option>
            </select>
          </td>
          <td>üíé ${(x.balance||0).toLocaleString()}</td>
          <td>${(x.weekly||0).toLocaleString()}</td>
          <td>L${x.tier||0}</td>
          <td class="row">
            <input type="number" style="width:100px" placeholder="Amount" data-k="delta" data-id="${x.id}"/>
            <button class="btn" data-act="add" data-id="${x.id}">Add</button>
            <button class="btn bad" data-act="sub" data-id="${x.id}">Sub</button>
          </td>
          <td class="row">
            <button class="btn ok" data-act="save" data-id="${x.id}">Save</button>
          </td>
        `;
        tbody.appendChild(tr);
      });

    // Balance add/sub
    tbody.querySelectorAll('button[data-act="add"],button[data-act="sub"]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const uid = b.getAttribute('data-id');
        const deltaInput = tbody.querySelector(`input[data-k="delta"][data-id="${uid}"]`);
        const amt = Number(deltaInput.value||0);
        if(amt<=0) return alert('Enter amount.');
        const act = b.getAttribute('data-act');
        let delta = act==='add' ? amt : -amt;
        await adjustBalance(uid, delta);
        deltaInput.value='';
      });
    });

    // Save row
    tbody.querySelectorAll('button[data-act="save"]').forEach(b=>{
      b.addEventListener('click', async ()=>{
        const uid = b.getAttribute('data-id');
        const name  = tbody.querySelector(`input[data-k="name"][data-id="${uid}"]`)?.value || '';
        const phone = tbody.querySelector(`input[data-k="phone"][data-id="${uid}"]`)?.value || '';
        const role  = tbody.querySelector(`select[data-k="role"][data-id="${uid}"]`)?.value || 'user';
        const status= tbody.querySelector(`select[data-k="status"][data-id="${uid}"]`)?.value || 'pending';
        await updateDoc(doc(db,'users',uid), { name, phone, role, status });
        alert('Saved.');
      });
    });
  }

  async function adjustBalance(clientUid, delta){
    if(!(meDoc && meDoc.role==='admin')) return alert('Admin only.');
    await runTransaction(db, async (trx)=>{
      const adminRef = doc(db,'users', me.uid);
      const userRef  = doc(db,'users', clientUid);
      const aSnap = await trx.get(adminRef);
      const cSnap = await trx.get(userRef);
      if(!cSnap.exists()) throw new Error('User not found.');
      const aBal = aSnap.data().balance||0;
      const cBal = cSnap.data().balance||0;
      if(delta>0){
        if(aBal<delta) throw new Error('Admin insufficient balance.');
        trx.update(adminRef, { balance: aBal - delta });
        trx.update(userRef,  { balance: cBal + delta });
      }else{
        const take = -delta;
        if(cBal<take) throw new Error('Client insufficient balance.');
        trx.update(userRef,  { balance: cBal - take });
        trx.update(adminRef, { balance: aBal + take });
      }
    });
  }

  $('addUserBtn').addEventListener('click', async ()=>{
    if(!(meDoc && meDoc.role==='admin')) return alert('Admin only.');
    const email = prompt('Email?'); if(!email) return;
    // Create an inactive user shell (no auth). Admin can later share temp password manually.
    const id = 'shell_'+Date.now();
    await setDoc(doc(db,'users',id), {
      id, email: email.toLowerCase(), name:'New User', phone:'', role:'user', status:'pending',
      balance:0, avatar:''
    });
    alert('Shell user created (pending). Ask user to Register with same email, then approve.');
  });

  /* ========= Profile ========= */
  function loadProfileForm(){
    if(!meDoc) return;
    $('profName').value = meDoc.name||'';
    $('profPhone').value = meDoc.phone||'';
    $('profPass').value = '';
    $('profAvatarPreview').src = meDoc.avatar || $('userAvatar').src;
  }
  $('profAvatarInput').addEventListener('change', async (e)=>{
    const f = e.target.files?.[0]; if(!f || !me) return;
    const r = new FileReader();
    r.onload = ()=>{ $('profAvatarPreview').src = r.result; };
    r.readAsDataURL(f);

    const path = `avatars/${me.uid}/${Date.now()}_${f.name}`;
    const rf = sRef(storage, path);
    await uploadBytes(rf, f);
    const url = await getDownloadURL(rf);
    await updateDoc(doc(db,'users', me.uid), { avatar: url });
  });
  $('saveProfileBtn').addEventListener('click', async ()=>{
    if(!me) return;
    const name = $('profName').value.trim();
    const phone= $('profPhone').value.trim();
    const pass = $('profPass').value.trim();
    if(name || phone) await updateDoc(doc(db,'users',me.uid), { name, phone });
    if(pass) await updatePassword(me, pass).catch(err=>alert(err.message));
    alert('Profile updated.');
  });

  /* ========= Auth ========= */
  $('doLogin').addEventListener('click', async ()=>{
    const email = $('loginEmail').value.trim().toLowerCase();
    const pass  = $('loginPass').value;
    try{
      await signInWithEmailAndPassword(auth, email, pass);
      showPage('dashboard');
    }catch(e){ alert(e.message); }
  });
  $('forgotPass').addEventListener('click', async ()=>{
    const email = $('loginEmail').value.trim().toLowerCase();
    if(!email) return alert('Enter your email above first.');
    await sendPasswordResetEmail(auth, email).then(()=> alert('Password reset email sent.'));
  });
  $('doRegister').addEventListener('click', async ()=>{
    const email = $('regEmail').value.trim().toLowerCase();
    const pass  = $('regPass').value;
    const name  = $('regName').value.trim();
    const phone = $('regPhone').value.trim();
    if(!email||!pass) return alert('Email and password are required.');
    try{
      const cred = await createUserWithEmailAndPassword(auth,email,pass);
      const u = cred.user;
      await setDoc(doc(db,'users', u.uid), {
        id:u.uid, email, name, phone, role:'user', status:'pending', balance:0, avatar:''
      });
      alert('Registered! Awaiting admin approval.');
      await signOut(auth);
      showPage('login');
    }catch(e){ alert(e.message); }
  });
  $('logoutLink').addEventListener('click', async (e)=>{
    e.preventDefault();
    await signOut(auth);
    showPage('login');
  });

  // Route guard + live subscriptions
  onAuthStateChanged(auth, async (user)=>{
    me = user;
    // Cleanup
    unsubUser && unsubUser(); unsubUser=null;
    unsubMyOrders && unsubMyOrders(); unsubMyOrders=null;
    unsubAllOrders && unsubAllOrders(); unsubAllOrders=null;
    unsubUsersAdmin && unsubUsersAdmin(); unsubUsersAdmin=null;

    if(!user){
      meDoc = null;
      renderUserHeader();
      computeWeeklyAndRender();
      showPage('login');
      return;
    }
    // Ensure user doc exists
    const uRef = doc(db,'users', user.uid);
    const uSnap = await getDoc(uRef);
    if(!uSnap.exists()){
      await setDoc(uRef, { id:user.uid, email:user.email, name:'', phone:'', role:'user', status:'pending', balance:0, avatar:'' });
    }

    // Subscribe my user doc
    unsubUser = onSnapshot(uRef, async (snap)=>{
      meDoc = snap.data();
      renderUserHeader();
      renderGifts();
      enableOrderConfirmCheck();
      loadProfileForm();
      await computeWeeklyAndRender();

      if(meDoc.status!=='active'){
        showPage('login');
      }else{
        // If just logged in and active, land dashboard
        if(document.querySelector('#page-login.active')) showPage('dashboard');
      }
    });

    // My orders (history)
    const myQ = query(collection(db,'orders'), where('userId','==', user.uid));
    unsubMyOrders = onSnapshot(myQ, (snap)=>{
      myOrders = snap.docs.map(d=> ({id:d.id, ...d.data()}));
      // if the client's own expired waiting order found, auto-cancel & refund
      myOrders.forEach(async o=>{
        if(o.status==='waiting' && (o.expiresAt?.toMillis?.()||0) < Date.now()){
          // cancel only own order
          await runTransaction(db, async (trx)=>{
            const ref = doc(db,'orders', o.id);
            const fresh = await trx.get(ref);
            const cur=fresh.data();
            if(cur.status!=='waiting') return;
            const uRef = doc(db,'users', me.uid);
            const uSnap = await trx.get(uRef);
            const bal = uSnap.data().balance||0;
            trx.update(uRef, { balance: bal + (cur.amount||0) });
            trx.update(ref, { status:'cancelled', refunded:true });
          }).catch(()=>{});
        }
      });
      renderHistory();
      computeWeeklyAndRender();
    });

    // Admin views
    if((meDoc?.role||'user')==='admin'){
      const allQ = query(collection(db,'orders'));
      unsubAllOrders = onSnapshot(allQ, (snap)=>{
        allOrders = snap.docs.map(d=> ({id:d.id, ...d.data()}));
        renderAdminOrders();
      });

      // Users table: need weekly & tier computed; we‚Äôll compute per user by query completed orders in boundary
      unsubUsersAdmin = onSnapshot(collection(db,'users'), async (snap)=>{
        let users = snap.docs.map(d=> ({id:d.id, ...d.data()}));
        const start = Timestamp.fromMillis(currentBoundary());
        // compute weekly for each user (simple, may cost reads for many users)
        for (let u of users){
          const qRef = query(collection(db,'orders'),
            where('userId','==', u.id),
            where('status','==','completed'),
            where('ts','>=', start)
          );
          let w=0; const r=await getDocs(qRef); r.forEach(x=> w+=(x.data().amount||0));
          const info = tierInfo(w);
          u.weekly = w; u.tier = info.level;
        }
        renderAdminUsers(users);
      });
    }
  });

  /* ========= Init UI ========= */
  function init(){
    renderGifts();
    // nav buttons already wired
  }
  init();
</script>
</body>
</html>