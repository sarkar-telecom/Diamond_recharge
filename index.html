<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sarkar Telecom ‚Ä¢ Diamond Recharge</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#0f1216; --panel:#151a21; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --card:#1c2230; --border:#2a3443;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto}
  a{color:var(--brand);text-decoration:none}
  /* Appbar */
  .appbar{position:sticky;top:0;z-index:50;background:#0b0e13;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:10px 12px}
  .brand{font-weight:800;font-size:18px;color:#a5d8ff}
  .hamb{font-size:22px;cursor:pointer}
  .spacer{flex:1}
  .chip{background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .btn{background:#3b82f6;border:0;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#2a3342}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.small{padding:6px 10px;border-radius:10px}
  /* Layout */
  main{padding:14px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(2,minmax(0,1fr))}
  .three{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media(max-width:820px){.two,.three{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .title{font-size:18px;font-weight:800;margin:0 0 10px}
  .muted{color:var(--muted)}
  .footer{position:sticky;bottom:0;background:#0b0e13;border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  /* Drawer */
  .drawer{position:fixed;inset:0;pointer-events:none}
  .drawer .scrim{position:absolute;inset:0;background:#0008;opacity:0;transition:.2s}
  .drawer .side{position:absolute;top:0;bottom:0;left:0;width:290px;background:#0d1117;border-right:1px solid var(--border);transform:translateX(-100%);transition:.2s;overflow:auto}
  .drawer.show{pointer-events:auto}
  .drawer.show .scrim{opacity:1}
  .drawer.show .side{transform:none}
  .nav a{display:block;padding:14px 16px;border-bottom:1px solid #111825;color:#dbeafe}
  .nav a.active{background:#111827}
  /* Forms */
  input,select,textarea{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
  label{display:block;margin:8px 0 6px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700}
  .b-wait{background:#3b2e06;color:#facc15}
  .b-ok{background:#063116;color:#34d399}
  .b-bad{background:#3b0b0b;color:#f87171}
  .hide{display:none !important}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top;text-align:left}
  th{color:#cbd5e1}
  .amounts .btn{background:#1d4ed8}
  .btn.outline{background:transparent;border:1px solid var(--border)}
  /* Mobile tweaks */
  @media(max-width:480px){
    .chip{padding:5px 8px}
    .btn{padding:9px 12px}
    th,td{padding:8px}
  }
</style>
</head>
<body>

<!-- App Bar -->
<div class="appbar">
  <span class="hamb" id="openMenu">‚ò∞</span>
  <div class="brand">Sarkar <span style="color:#60a5fa">Telecom</span></div>
  <div class="spacer"></div>
  <div id="hdrUser" class="row hide">
    <span id="hdrEmail" class="chip">‚Äî</span>
    <span id="hdrTier" class="chip">Tier 0 (0%)</span>
    <span id="hdrBal" class="chip">üíé 0</span>
    <button class="btn small" id="newOrderBtn">New Order</button>
  </div>
  <div id="hdrAnon" class="row">
    <button class="btn small" onclick="showPage('login')">Login</button>
    <button class="btn small secondary" onclick="showPage('register')">Register</button>
  </div>
</div>

<!-- Drawer -->
<div class="drawer" id="drawer">
  <div class="scrim" id="closeMenu"></div>
  <aside class="side">
    <div class="brand" style="padding:16px 16px 8px">Sarkar Telecom</div>
    <nav class="nav">
      <a href="#/dashboard" data-page="dashboard" class="active">üè† Dashboard</a>
      <a href="#/create" data-page="create">‚ûï Create Order</a>
      <a href="#/orders" data-page="orders">üßæ Order History</a>
      <a href="#/profile" data-page="profile">üë§ Profile</a>
      <a href="#/admin-orders" data-page="adminOrders" id="linkAdminOrders" class="hide">üõ†Ô∏è Admin: Orders</a>
      <a href="#/admin-users" data-page="adminUsers" id="linkAdminUsers" class="hide">üë• Admin: Users</a>
      <a href="#/admin-settings" data-page="adminSettings" id="linkAdminSettings" class="hide">‚öôÔ∏è Admin: Settings</a>
      <a href="#/login" data-page="login" id="linkLoginAnon" class="">üîê Login</a>
      <a href="#/logout" data-page="logout" id="linkLogout" class="hide">üö™ Logout</a>
    </nav>
  </aside>
</div>

<!-- PAGES -->
<main>
  <!-- Dashboard -->
  <section id="page-dashboard" class="page">
    <div class="grid two">
      <div class="panel">
        <h3 class="title">Welcome</h3>
        <div class="muted">Manage diamond gifting with real-time balance & rewards.</div>
        <div class="row" style="margin-top:12px;gap:8px;">
          <button class="btn" onclick="showPage('create')">Create Order</button>
          <button class="btn secondary" onclick="showPage('orders')">View History</button>
          <button class="btn ghost" onclick="autoCancelSweep()">Auto-cancel overdue</button>
        </div>
      </div>
      <div class="panel">
        <h3 class="title">Account</h3>
        <div class="grid">
          <div>Email: <b id="accEmail">‚Äî</b></div>
          <div>Phone: <b id="accPhone">‚Äî</b></div>
          <div>Role: <b id="accRole">‚Äî</b></div>
          <div>Approved: <b id="accApproved">‚Äî</b></div>
          <div>Weekly Diamonds: <b id="accWeek">0</b></div>
          <div>Tier: <b id="accTier">0 (0%)</b></div>
          <div>Balance: <b id="accBal">0</b></div>
        </div>
      </div>
    </div>
    <div class="panel" style="margin-top:12px">
      <h3 class="title">Tips</h3>
      <ul>
        <li>Orders auto-cancel in <b id="tipAutoCancel">5</b> minutes if not completed.</li>
        <li>Admin pages let you manage Orders, Users & Settings from phone.</li>
      </ul>
    </div>
  </section>

  <!-- Login -->
  <section id="page-login" class="page hide">
    <div class="panel" style="max-width:460px;margin:auto">
      <h3 class="title">Login</h3>
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="user@email.com">
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="btn outline" onclick="sendReset()">Forgot password?</button>
        <button class="btn secondary" onclick="showPage('register')">Create account</button>
      </div>
      <div class="muted" id="loginMsg" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Register -->
  <section id="page-register" class="page hide">
    <div class="panel" style="max-width:520px;margin:auto">
      <h3 class="title">Register</h3>
      <div class="grid two">
        <div>
          <label>Name</label>
          <input id="regName" placeholder="Your name">
        </div>
        <div>
          <label>Phone</label>
          <input id="regPhone" placeholder="+880...">
        </div>
      </div>
      <label>Email</label>
      <input id="regEmail" type="email">
      <label>Password</label>
      <input id="regPass" type="password">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="doRegister()">Create account</button>
        <button class="btn secondary" onclick="showPage('login')">Back to Login</button>
      </div>
      <p class="muted" style="margin-top:10px">Admin approval required before use.</p>
      <div class="muted" id="regMsg"></div>
    </div>
  </section>

  <!-- Create Order -->
  <section id="page-create" class="page hide">
    <div class="panel">
      <h3 class="title">Create Order</h3>
      <label>Gift Recipient (Number / Profile ID)</label>
      <input id="clientId" placeholder="58848454">
      <div class="muted" style="margin:6px 0">Your available balance: üíé <span id="availableBal">0</span></div>
      <div class="row amounts" id="quickAmounts" style="flex-wrap:wrap;margin:8px 0"></div>
      <label>Amount</label>
      <input id="amount" type="number" min="1" step="1" value="50">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createOrder()">Submit</button>
        <button class="btn secondary" onclick="showPage('orders')">Go to History</button>
      </div>
      <div id="createMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Order History -->
  <section id="page-orders" class="page hide">
    <div class="panel">
      <h3 class="title">Order History</h3>
      <table id="ordersTable">
        <thead>
          <tr><th>ID</th><th>Client</th><th>Amount</th><th>Time</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Profile -->
  <section id="page-profile" class="page hide">
    <div class="panel grid two">
      <div>
        <h3 class="title">Profile</h3>
        <label>Name</label><input id="pfName">
        <label>Phone</label><input id="pfPhone">
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="saveProfile()">Save</button>
          <button class="btn outline" onclick="sendReset()">Reset password via email</button>
        </div>
        <div id="pfMsg" class="muted" style="margin-top:8px"></div>
      </div>
      <div>
        <h3 class="title">Account</h3>
        <div class="grid">
          <div>Email: <b id="pfEmail">‚Äî</b></div>
          <div>Role: <b id="pfRole">‚Äî</b></div>
          <div>Approved: <b id="pfApproved">‚Äî</b></div>
          <div>Balance: <b id="pfBalance">‚Äî</b></div>
          <div>Weekly Diamonds: <b id="pfWeekly">‚Äî</b></div>
          <div>Tier: <b id="pfTier">0 (0%)</b></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin: Orders -->
  <section id="page-adminOrders" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Orders</h3>
      <div class="row">
        <button class="btn ghost" onclick="autoCancelSweep(true)">Auto-cancel overdue</button>
      </div>
      <table id="adminOrdersTbl" style="margin-top:10px">
        <thead>
          <tr><th>ID</th><th>Client</th><th>Amount</th><th>User</th><th>Status</th><th>Time</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Admin: Users -->
  <section id="page-adminUsers" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Users</h3>
      <table id="adminUsersTbl">
        <thead>
          <tr><th>Email</th><th>Name</th><th>Phone</th><th>Role</th><th>Approved</th><th>Balance</th><th>Weekly</th><th>Tier</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Admin: Settings -->
  <section id="page-adminSettings" class="page hide">
    <div class="panel" style="max-width:680px">
      <h3 class="title">Admin: Settings (Firestore ‚Üí settings/app)</h3>
      <label>Auto-cancel minutes</label>
      <input id="stAutoCancel" type="number" min="1" value="5">
      <label class="row" style="margin-top:8px">Quick amounts (comma separated)
        <small class="muted">(e.g. 10,50,100,200,500,1000)</small>
      </label>
      <textarea id="stQuick" rows="2" placeholder="10,50,100,200,500,1000"></textarea>
      <label class="row" style="margin-top:8px">Reward tiers (JSON array: [{min:5000,pct:1.0},...])</label>
      <textarea id="stTiers" rows="4"></textarea>
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="saveSettings()">Save Settings</button>
        <div id="stMsg" class="muted"></div>
      </div>
    </div>
  </section>

  <!-- Logout -->
  <section id="page-logout" class="page hide">
    <div class="panel"><h3 class="title">Logging out‚Ä¶</h3></div>
  </section>
</main>

<!-- Footer -->
<div class="footer">
  <span>¬© 2025 Sarkar Telecom</span>
  <span class="spacer"></span>
  <span class="chip">Week: <span id="ftWeek">0</span></span>
  <span class="chip">Tier: <span id="ftTier">0 (0%)</span></span>
  <span class="chip">üíé <span id="ftBal">0</span></span>
</div>

<!-- Firebase compat CDN (single-file friendly) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>

<script>
/*** ========= CONFIG ========= ***/
// ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞ ‡¶ï‡¶®‡¶´‡¶ø‡¶ó (‡¶Ü‡¶™‡¶®‡¶ø ‡¶Ü‡¶ó‡ßá ‡¶Ø‡ßá‡¶ü‡¶æ ‡¶¶‡¶ø‡ßü‡ßá‡¶õ‡ßá‡¶® ‚Äì Í∑∏ÎåÄÎ°ú ‡¶¨‡¶∏‡¶æ‡¶®‡ßã ‡¶π‡¶≤‡ßã)
const firebaseConfig = {
  apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com", // storage ‡¶¨‡ßç‡¶Ø‡¶¨‡¶π‡¶æ‡¶∞ ‡¶ï‡¶∞‡¶≤‡ßá .appspot.com ‡¶¶‡¶∞‡¶ï‡¶æ‡¶∞
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};

// ‡¶°‡¶ø‡¶´‡¶≤‡ßç‡¶ü ‡¶∏‡ßá‡¶ü‡¶ø‡¶Ç‡¶∏ (Firestore ‚Üí settings/app ‡¶®‡¶æ ‡¶•‡¶æ‡¶ï‡¶≤‡ßá ‡¶è‡¶ó‡ßÅ‡¶≤‡ßã ‡¶á‡¶â‡¶ú ‡¶π‡¶¨‡ßá)
const DEFAULT_SETTINGS = {
  autoCancelMin: 5,
  quickAmounts: [10,50,100,200,500,1000],
  rewardTiers: [ // weeklyDiamonds ‡¶≠‡¶ø‡¶§‡ßç‡¶§‡¶ø‡¶ï
    {min:5000, pct:1.0, level:1},
    {min:20000, pct:1.6, level:2},
    {min:40000, pct:2.1, level:3},
    {min:80000, pct:2.6, level:4},
    {min:800000, pct:3.5, level:5},
  ]
};
/*** ====== INIT ====== ***/
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); // refresh ‡¶ï‡¶∞‡¶≤‡ßá logout ‡¶π‡¶¨‡ßá ‡¶®‡¶æ
const db = firebase.firestore();

/*** ========= STATE ========= ***/
let me = null;       // auth user
let myDoc = null;    // users/{uid} live data
let settings = {...DEFAULT_SETTINGS};
let myWaitingSum = 0;
let unsubUser = null, unsubMyOrders = null, unsubAdminOrders = null, unsubAdminUsers = null, unsubSettings = null;

/*** ========= HELPERS ========= ***/
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
const fmt = n => new Intl.NumberFormat().format(n||0);
function toast(el,msg){ el.textContent=msg; setTimeout(()=>el.textContent='',4000); }
function tierFromWeekly(total){
  let best = {level:0,pct:0};
  (settings.rewardTiers||[]).forEach(t=>{ if(total>=t.min && (t.level||0)>(best.level||0)) best = t; });
  return best;
}

/*** ========= NAV / UI ========= ***/
function pageId(key){ return `page-${key}`; }
function showPage(key){
  $$('.page').forEach(p=>p.classList.add('hide'));
  $('#'+pageId(key))?.classList.remove('hide');
  $$('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.page===key));
  if(key==='logout') doLogout();
  if(key==='orders') loadMyOrders();
  if(key==='adminOrders') loadAdminOrders();
  if(key==='adminUsers') loadAdminUsers();
  if(key==='adminSettings') loadSettingsUI();
}
$('#openMenu').onclick=()=>$('#drawer').classList.add('show');
$('#closeMenu').onclick=()=>$('#drawer').classList.remove('show');
$$('.nav a').forEach(a=>a.onclick=()=>$('#drawer').classList.remove('show'));
$('#newOrderBtn').onclick=()=>showPage('create');
window.addEventListener('hashchange',()=>{
  const key = (location.hash.replace('#/','')||'dashboard');
  showPage(key);
});

/*** ========= SETTINGS (live) ========= ***/
function subscribeSettings(){
  unsubSettings && unsubSettings();
  unsubSettings = db.collection('settings').doc('app').onSnapshot(s=>{
    if(s.exists){ settings = {...DEFAULT_SETTINGS, ...s.data()}; }
    else{ settings = {...DEFAULT_SETTINGS}; }
    $('#tipAutoCancel').textContent = settings.autoCancelMin;
    renderQuickAmounts();
  });
}
subscribeSettings();
function renderQuickAmounts(){
  const wrap = $('#quickAmounts');
  wrap.innerHTML = '';
  (settings.quickAmounts||DEFAULT_SETTINGS.quickAmounts).forEach(n=>{
    const b=document.createElement('button');
    b.className='btn small'; b.textContent=`üíé ${fmt(n)}`;
    b.onclick=()=>{ $('#amount').value=n; };
    wrap.appendChild(b);
  });
}
function loadSettingsUI(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  $('#stAutoCancel').value = settings.autoCancelMin||5;
  $('#stQuick').value = (settings.quickAmounts||[]).join(',');
  $('#stTiers').value = JSON.stringify(settings.rewardTiers||[],null,2);
}
async function saveSettings(){
  if(myDoc?.role!=='admin') return;
  try{
    const quick = $('#stQuick').value.split(',').map(s=>Number(s.trim())).filter(Boolean);
    const tiers = JSON.parse($('#stTiers').value || '[]');
    const autoCancelMin = Number($('#stAutoCancel').value||5);
    await db.collection('settings').doc('app').set({quickAmounts:quick, rewardTiers:tiers, autoCancelMin},{merge:true});
    toast($('#stMsg'),'Saved ‚úì');
  }catch(e){ toast($('#stMsg'),'Error: '+e.message); }
}

/*** ========= AUTH ========= ***/
auth.onAuthStateChanged(async u=>{
  me = u||null;
  unsubUser && unsubUser(); unsubUser=null;
  unsubMyOrders && unsubMyOrders(); unsubMyOrders=null;

  if(!me){
    myDoc=null; myWaitingSum=0;
    $('#hdrAnon').classList.remove('hide');
    $('#hdrUser').classList.add('hide');
    $('#linkLogout').classList.add('hide');
    $('#linkLoginAnon').classList.remove('hide');
    $('#linkAdminOrders').classList.add('hide');
    $('#linkAdminUsers').classList.add('hide');
    $('#linkAdminSettings').classList.add('hide');
    showPage('login');
    return;
  }
  // ensure user doc
  const ref = db.collection('users').doc(me.uid);
  const snap = await ref.get();
  if(!snap.exists){
    await ref.set({
      email: me.email, name: me.displayName||'', phone:'', role:'user',
      approved:false, balance:0, weeklyDiamonds:0, tier:0
    },{merge:true});
  }
  // live user
  unsubUser = ref.onSnapshot(s=>{
    myDoc = {...s.data(), id:s.id};
    // compute tier (derived) if not stored
    const t = tierFromWeekly(myDoc.weeklyDiamonds||0);
    // header/footer + account
    $('#hdrAnon').classList.add('hide');
    $('#hdrUser').classList.remove('hide');
    $('#hdrEmail').textContent = me.email||'';
    $('#hdrBal').textContent = 'üíé '+fmt( (myDoc.balance||0) - (myWaitingSum||0) );
    $('#hdrTier').textContent = `Tier ${t.level||0} (${t.pct||0}%)`;
    $('#availableBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );

    $('#accEmail').textContent=me.email||'';
    $('#accPhone').textContent=myDoc.phone||'';
    $('#accRole').textContent=myDoc.role||'user';
    $('#accApproved').textContent=String(!!myDoc.approved);
    $('#accWeek').textContent=fmt(myDoc.weeklyDiamonds||0);
    $('#accTier').textContent = `${t.level||0} (${t.pct||0}%)`;
    $('#accBal').textContent=fmt(myDoc.balance||0);

    $('#pfEmail').textContent=me.email||'';
    $('#pfRole').textContent=myDoc.role||'user';
    $('#pfApproved').textContent=String(!!myDoc.approved);
    $('#pfBalance').textContent=fmt(myDoc.balance||0);
    $('#pfWeekly').textContent=fmt(myDoc.weeklyDiamonds||0);
    $('#pfTier').textContent=`${t.level||0} (${t.pct||0}%)`;
    $('#pfName').value = myDoc.name||'';
    $('#pfPhone').value = myDoc.phone||'';

    $('#ftWeek').textContent = fmt(myDoc.weeklyDiamonds||0);
    $('#ftTier').textContent = `${t.level||0} (${t.pct||0}%)`;
    $('#ftBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );

    // admin links
    const isAdmin = myDoc.role==='admin';
    $('#linkAdminOrders').classList.toggle('hide', !isAdmin);
    $('#linkAdminUsers').classList.toggle('hide', !isAdmin);
    $('#linkAdminSettings').classList.toggle('hide', !isAdmin);
    $('#linkLogout').classList.remove('hide');
    $('#linkLoginAnon').classList.add('hide');

    if(!myDoc.approved){
      $('#loginMsg').textContent='Your account is pending admin approval.';
      showPage('profile');
    }else{
      const hash = location.hash.replace('#/','') || 'dashboard';
      showPage(hash);
    }
    computeWaitingHold();
  });
});

async function doLogin(){
  const email = $('#loginEmail').value.trim();
  const pass = $('#loginPass').value;
  try{ await auth.signInWithEmailAndPassword(email, pass); $('#loginMsg').textContent=''; }
  catch(e){ toast($('#loginMsg'), 'Login failed: '+e.message); }
}
async function sendReset(){
  const email = me?.email || $('#loginEmail').value.trim();
  if(!email) return toast($('#loginMsg'),'Enter your email first');
  try{ await auth.sendPasswordResetEmail(email); alert('Reset mail sent to '+email); }
  catch(e){ alert('Error: '+e.message); }
}
async function doRegister(){
  const name=$('#regName').value.trim();
  const phone=$('#regPhone').value.trim();
  const email=$('#regEmail').value.trim();
  const pass=$('#regPass').value;
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({
      email,name,phone,role:'user',approved:false,balance:0,weeklyDiamonds:0,tier:0
    },{merge:true});
    alert('Account created. Wait for admin approval.');
    showPage('profile');
  }catch(e){ toast($('#regMsg'),'Register failed: '+e.message); }
}
async function doLogout(){ await auth.signOut(); }

/*** ========= PROFILE ========= ***/
async function saveProfile(){
  const name=$('#pfName').value.trim();
  const phone=$('#pfPhone').value.trim();
  try{
    await db.collection('users').doc(me.uid).update({name,phone});
    toast($('#pfMsg'),'Profile updated.');
  }catch(e){ toast($('#pfMsg'),'Error: '+e.message); }
}

/*** ========= HOLD (WAITING sum) ========= ***/
async function computeWaitingHold(){
  if(!me) return;
  const qs = await db.collection('orders')
    .where('uid','==',me.uid).where('status','==','WAITING').get();
  myWaitingSum = qs.docs.reduce((a,d)=>a+(d.data().amount||0),0);
  // header/foot refresh
  if(myDoc){
    $('#hdrBal').textContent = 'üíé '+fmt( (myDoc.balance||0) - (myWaitingSum||0) );
    $('#availableBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );
    $('#ftBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );
  }
}

/*** ========= ORDER FLOW ========= ***/
async function createOrder(){
  if(!me) return alert('Login first');
  if(!myDoc?.approved) return alert('You are not approved yet.');
  const clientId = $('#clientId').value.trim();
  const amount = parseInt($('#amount').value||'0',10);
  const avail = (myDoc.balance||0) - (myWaitingSum||0);
  if(!clientId) return alert('Enter client/profile ID');
  if(amount<=0) return alert('Enter a valid amount');
  if(amount>avail) return alert('Insufficient balance');

  try{
    const mins = settings.autoCancelMin||5;
    const autoCancelAt = new Date(Date.now()+mins*60*1000);
    await db.collection('orders').add({
      clientId, amount, status:'WAITING',
      userEmail: me.email, uid: me.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      autoCancelAt: firebase.firestore.Timestamp.fromDate(autoCancelAt),
      settled:false
    });
    $('#createMsg').textContent='Order placed ‚úì';
    computeWaitingHold();
    showPage('orders');
  }catch(e){
    toast($('#createMsg'),'Error: '+e.message);
  }
}

// My orders (live)
function loadMyOrders(){
  unsubMyOrders && unsubMyOrders();
  const tbody = $('#ordersTable tbody');
  tbody.innerHTML = '';
  unsubMyOrders = db.collection('orders')
    .where('uid','==',me.uid)
    .orderBy('timestamp','desc')
    .limit(100)
    .onSnapshot(snap=>{
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data(); const id=doc.id;
        const ts=d.timestamp?.toDate?.()||new Date();
        const badge = d.status==='WAITING'?'b-wait': d.status==='COMPLETED'?'b-ok':'b-bad';
        const act = d.status==='WAITING'
          ? `<button class="btn small outline" onclick="cancelOwnOrder('${id}')">Cancel</button>`
          : `<button class="btn small outline" onclick="showPage('create')">Re-order</button>`;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${id.slice(-6)}</td>
          <td>${d.clientId||''}</td>
          <td>üíé ${fmt(d.amount)}</td>
          <td>${ts.toLocaleString()}</td>
          <td><span class="badge ${badge}">${d.status}</span></td>
          <td>${act}</td>
        `;
        tbody.appendChild(tr);
      });
    });
  autoCancelSweep(false);
}
async function cancelOwnOrder(id){
  try{ await db.collection('orders').doc(id).update({status:'CANCELLED'}); }
  catch(e){ alert('Cancel failed: '+e.message); }
}

// Auto-cancel overdue (admin = all, user = own)
async function autoCancelSweep(adminScope){
  if(!me) return;
  const isAdmin = myDoc?.role==='admin' && adminScope;
  // Firestore: query WAITING & autoCancelAt<=now
  const q = db.collection('orders')
    .where('status','==','WAITING')
    .where('autoCancelAt','<=',firebase.firestore.Timestamp.now());
  const snap = await q.get();
  const batch = db.batch();
  snap.forEach(doc=>{
    const d=doc.data();
    if(isAdmin || d.uid===me.uid) batch.update(doc.ref,{status:'CANCELLED'});
  });
  if(!snap.empty) await batch.commit();
}

/*** ========= ADMIN: ORDERS ========= ***/
function loadAdminOrders(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  unsubAdminOrders && unsubAdminOrders();
  const tbody = $('#adminOrdersTbl tbody');
  tbody.innerHTML='';
  unsubAdminOrders = db.collection('orders').orderBy('timestamp','desc').limit(200)
    .onSnapshot(snap=>{
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data(); const id=doc.id;
        const badge = d.status==='WAITING'?'b-wait': d.status==='COMPLETED'?'b-ok':'b-bad';
        const ts=d.timestamp?.toDate?.()||new Date();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${id.slice(-6)}</td>
          <td>${d.clientId}</td>
          <td>üíé ${fmt(d.amount)}</td>
          <td>${d.userEmail}</td>
          <td><span class="badge ${badge}">${d.status}</span></td>
          <td>${ts.toLocaleString()}</td>
          <td>
            <button class="btn small" onclick="adminComplete('${id}')">Complete</button>
            <button class="btn small outline" onclick="adminCancel('${id}')">Cancel</button>
          </td>`;
        tbody.appendChild(tr);
      });
    });
}
async function adminCancel(id){
  try{ await db.collection('orders').doc(id).update({status:'CANCELLED'}); }
  catch(e){ alert('Cancel failed: '+e.message); }
}
async function adminComplete(id){
  const ref = db.collection('orders').doc(id);
  await db.runTransaction(async tr=>{
    const o = await tr.get(ref);
    if(!o.exists) throw new Error('Order not found');
    const d=o.data();
    if(d.status!=='WAITING') return;
    tr.update(ref,{status:'COMPLETED', settled:true});
    // update user balance & weekly
    const uref = db.collection('users').doc(d.uid);
    const u = await tr.get(uref);
    const ub = (u.data().balance||0) - (d.amount||0);
    const w = (u.data().weeklyDiamonds||0) + (d.amount||0);
    const t = tierFromWeekly(w);
    tr.update(uref,{balance:ub, weeklyDiamonds:w, tier:t.level});
  });
}

/*** ========= ADMIN: USERS ========= ***/
function loadAdminUsers(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  unsubAdminUsers && unsubAdminUsers();
  const tbody = $('#adminUsersTbl tbody');
  tbody.innerHTML='';
  unsubAdminUsers = db.collection('users').orderBy('email').onSnapshot(snap=>{
    tbody.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data(); const id=doc.id;
      const t = tierFromWeekly(d.weeklyDiamonds||0);
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d.email||''}</td>
        <td><input value="${d.name||''}" data-id="${id}" data-key="name" onblur="editUser(this)"></td>
        <td><input value="${d.phone||''}" data-id="${id}" data-key="phone" onblur="editUser(this)"></td>
        <td>
          <select data-id="${id}" data-key="role" onchange="editUser(this)">
            <option value="user" ${d.role==='user'?'selected':''}>user</option>
            <option value="admin" ${d.role==='admin'?'selected':''}>admin</option>
          </select>
        </td>
        <td>
          <select data-id="${id}" data-key="approved" onchange="editUser(this)">
            <option value="true" ${d.approved?'selected':''}>true</option>
            <option value="false" ${!d.approved?'selected':''}>false</option>
          </select>
        </td>
        <td>üíé ${fmt(d.balance||0)}</td>
        <td>${fmt(d.weeklyDiamonds||0)}</td>
        <td>${t.level||0}</td>
        <td><button class="btn small outline" onclick="impersonate('${id}')">Impersonate</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}
async function editUser(el){
  const id=el.dataset.id, key=el.dataset.key;
  let val = el.value;
  if(key==='approved') val = (val==='true');
  try{ await db.collection('users').doc(id).update({[key]:val}); }
  catch(e){ alert('Update failed: '+e.message); }
}
function impersonate(uid){
  alert('Open Firestore ‚Üí users/'+uid+' to view details.\n(Full impersonation requires backend; skipped.)');
}

/*** ========= ROUTER START ========= ***/
document.addEventListener('DOMContentLoaded', ()=>{
  const key = (location.hash.replace('#/','')||'dashboard');
  showPage(key);
});
</script>
</body>
</html>