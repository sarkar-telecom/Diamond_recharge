<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sarkar Telecom ‚Ä¢ Diamond Recharge</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#0f1216; --surface:#121821; --panel:#161b22; --muted:#8aa0b7; --text:#e8eef6;
    --brand:#5db2ff; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --card:#1b2430; --line:#263244;
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto}
  a{color:var(--brand);text-decoration:none}

  /* Appbar */
  .appbar{position:sticky;top:0;z-index:40;background:#0b1118d0;backdrop-filter:saturate(1.2) blur(6px);
    border-bottom:1px solid var(--line);display:flex;align-items:center;gap:10px;padding:10px 12px}
  .brand{font-weight:800;font-size:18px;color:#bfe1ff;letter-spacing:.3px}
  .hamb{font-size:22px;cursor:pointer;padding:6px 8px;border-radius:10px;border:1px solid transparent}
  .hamb:hover{background:#0d1520;border-color:#132033}
  .spacer{flex:1}
  .chip{background:var(--card);border:1px solid var(--line);padding:6px 10px;border-radius:999px;color:#cfe7ff}
  .btn{background:#2b6de9;border:0;color:white;padding:10px 14px;border-radius:12px;font-weight:700;cursor:pointer}
  .btn.secondary{background:#243244}
  .btn.ghost{background:transparent;border:1px solid var(--line);color:var(--text)}
  .btn.small{padding:6px 10px;border-radius:10px;font-weight:600}
  button:disabled{opacity:.55;cursor:not-allowed}

  /* Drawer */
  .drawer{position:fixed;inset:0;pointer-events:none}
  .drawer .scrim{position:absolute;inset:0;background:#000a;opacity:0;transition:.2s}
  .drawer .side{position:absolute;top:0;bottom:0;left:0;width:280px;background:#0e1522;border-right:1px solid var(--line);
    transform:translateX(-100%);transition:.2s;overflow:auto;padding-top:10px}
  .drawer.show{pointer-events:auto}
  .drawer.show .scrim{opacity:1}
  .drawer.show .side{transform:none}
  .nav a{display:block;padding:13px 16px;border-bottom:1px solid #121b2d;color:#d7ecff}
  .nav a.active{background:#121a2a}
  .adminOnly{display:none}

  /* Layout */
  main{padding:16px;max-width:1100px;margin:0 auto}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(2,minmax(0,1fr))}
  .three{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media(max-width:780px){.two,.three{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:16px}
  .title{font-size:18px;font-weight:800;margin:0 0 10px}
  .muted{color:var(--muted)}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .hide{display:none !important}
  .avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;border:1px solid var(--line);background:#172030}

  /* Forms & tables */
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--line);background:var(--card);color:var(--text)}
  label{display:block;margin:8px 0 6px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--line);vertical-align:top;text-align:left}
  th{color:#c9def5}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:800;font-size:12px}
  .b-wait{background:#3b2e06;color:#facc15}
  .b-ok{background:#063116;color:#34d399}
  .b-bad{background:#3b0b0b;color:#f87171}

  /* Amount buttons */
  .amounts{display:flex;flex-wrap:wrap;gap:8px}
  .amounts .btn{background:#1e293b}
  .amounts .btn.sel{background:#2b6de9}

  /* Footer */
  .footer{position:sticky;bottom:0;background:#0b1118d0;border-top:1px solid var(--line);padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
</style>
</head>
<body>

<!-- Top App Bar -->
<div class="appbar">
  <span class="hamb" id="openMenu">‚ò∞</span>
  <div class="brand">Sarkar <span style="color:#60a5fa">Telecom</span></div>
  <div class="spacer"></div>

  <!-- Auth HUD (when logged in) -->
  <div id="hdrUser" class="row hide">
    <span id="hdrEmail" class="chip">‚Äî</span>
    <span id="hdrTier" class="chip">Tier L0</span>
    <span id="hdrBal" class="chip">üíé 0</span>
    <img id="hdrAvatar" class="avatar" src="" alt="">
    <button class="btn small" id="newOrderBtn">New Order</button>
  </div>

  <!-- When logged out -->
  <div id="hdrAnon" class="row">
    <button class="btn small" onclick="showPage('login')">Login</button>
    <button class="btn small secondary" onclick="showPage('register')">Register</button>
  </div>
</div>

<!-- Sidebar Drawer -->
<div class="drawer" id="drawer">
  <div class="scrim" id="closeMenu"></div>
  <aside class="side">
    <div class="brand" style="padding:14px 16px">Sarkar Telecom</div>
    <nav class="nav">
      <a href="#/dashboard" data-page="dashboard" class="active">üè† Dashboard</a>
      <a href="#/create" data-page="create">‚ûï Create Order</a>
      <a href="#/orders" data-page="orders">üßæ Order History</a>
      <a href="#/profile" data-page="profile">üë§ Profile</a>
      <a href="#/admin-orders" data-page="adminOrders" id="linkAdminOrders" class="adminOnly">üõ†Ô∏è Admin: Orders</a>
      <a href="#/admin-users" data-page="adminUsers" id="linkAdminUsers" class="adminOnly">üë• Admin: Users</a>
      <a href="#/settings" data-page="settings" id="linkSettings" class="adminOnly">‚öôÔ∏è Admin: Settings</a>
      <a href="#/login" data-page="login" id="linkLoginAnon">üîê Login</a>
      <a href="#/logout" data-page="logout" id="linkLogout" class="hide">üö™ Logout</a>
    </nav>
  </aside>
</div>

<!-- PAGES -->
<main style="padding:16px;max-width:1100px;margin:0 auto;">
  <!-- Dashboard -->
  <section id="page-dashboard" class="page">
    <div class="grid two">
      <div class="panel">
        <h3 class="title">Welcome</h3>
        <div class="muted">Manage diamond gifting with live updates.</div>
        <div class="row" style="margin-top:12px;gap:8px;">
          <button class="btn" onclick="showPage('create')">Create Order</button>
          <button class="btn secondary" onclick="showPage('orders')">View History</button>
          <button class="btn ghost adminOnly" onclick="autoCancelSweep(true)">Auto-cancel overdue (All)</button>
        </div>
      </div>
      <div class="panel">
        <h3 class="title">Account</h3>
        <div class="grid">
          <div>Email: <b id="accEmail">‚Äî</b></div>
          <div>Phone: <b id="accPhone">‚Äî</b></div>
          <div>Role: <b id="accRole">‚Äî</b></div>
          <div>Approved: <b id="accApproved">‚Äî</b></div>
          <div>Weekly Diamonds: <b id="accWeek">0</b></div>
          <div>Balance: <b id="accBal">0</b></div>
          <div>Tier: <b id="accTier">L0</b></div>
        </div>
      </div>
    </div>
    <div class="panel" style="margin-top:12px">
      <h3 class="title">Tips</h3>
      <ul>
        <li>Orders auto-cancel in <b>5 minutes</b> if not completed.</li>
        <li>Admins can manage status and balances in Admin pages.</li>
      </ul>
    </div>
  </section>

  <!-- Login -->
  <section id="page-login" class="page hide">
    <div class="panel" style="max-width:460px;margin:auto">
      <h3 class="title">Login</h3>
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="user@email.com">
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="btn ghost" onclick="sendReset()">Forgot password?</button>
        <button class="btn secondary" onclick="showPage('register')">Create account</button>
      </div>
      <div class="muted" id="loginMsg" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Register -->
  <section id="page-register" class="page hide">
    <div class="panel" style="max-width:520px;margin:auto">
      <h3 class="title">Register</h3>
      <div class="grid two">
        <div>
          <label>Name</label>
          <input id="regName" placeholder="Your name">
        </div>
        <div>
          <label>Phone</label>
          <input id="regPhone" placeholder="+880...">
        </div>
      </div>
      <label>Email</label>
      <input id="regEmail" type="email">
      <label>Password</label>
      <input id="regPass" type="password">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="doRegister()">Create account</button>
        <button class="btn secondary" onclick="showPage('login')">Back to Login</button>
      </div>
      <p class="muted" style="margin-top:10px">Admin approval required before you can use the site.</p>
      <div class="muted" id="regMsg"></div>
    </div>
  </section>

  <!-- Create Order -->
  <section id="page-create" class="page hide">
    <div class="panel">
      <h3 class="title">Create Order</h3>
      <label>Gift Recipient (Number / Profile ID)</label>
      <input id="clientId" placeholder="58848454">
      <div class="muted" style="margin:6px 0">Available balance: üíé <span id="availableBal">0</span></div>
      <div class="amounts" style="margin:8px 0" id="amountBtns"></div>
      <label>Amount</label>
      <input id="amount" type="number" min="1" step="1" value="50">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createOrder()">Submit</button>
        <button class="btn secondary" onclick="showPage('orders')">Go to History</button>
      </div>
      <div id="createMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Order History -->
  <section id="page-orders" class="page hide">
    <div class="panel">
      <h3 class="title">Order History</h3>
      <table id="ordersTable">
        <thead>
          <tr><th>ID</th><th>Client</th><th>Amount</th><th>Time</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Profile -->
  <section id="page-profile" class="page hide">
    <div class="panel grid two">
      <div>
        <h3 class="title">Profile</h3>
        <label>Name</label><input id="pfName">
        <label>Phone</label><input id="pfPhone">
        <label>Avatar</label><input id="pfAvatar" type="file" accept="image/*">
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="saveProfile()">Save</button>
          <button class="btn ghost" onclick="sendReset()">Reset password via email</button>
        </div>
        <div id="pfMsg" class="muted" style="margin-top:8px"></div>
      </div>
      <div>
        <h3 class="title">Account</h3>
        <div class="grid">
          <div>Email: <b id="pfEmail">‚Äî</b></div>
          <div>Role: <b id="pfRole">‚Äî</b></div>
          <div>Approved: <b id="pfApproved">‚Äî</b></div>
          <div>Balance: <b id="pfBalance">‚Äî</b></div>
          <div>Weekly Diamonds: <b id="pfWeekly">‚Äî</b></div>
          <div>Tier: <b id="pfTier">L0</b></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin: Orders -->
  <section id="page-adminOrders" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Orders</h3>
      <div class="row">
        <button class="btn ghost" onclick="autoCancelSweep(true)">Auto-cancel overdue</button>
      </div>
      <table id="adminOrdersTbl" style="margin-top:10px">
        <thead>
          <tr><th>ID</th><th>Client</th><th>Amount</th><th>User</th><th>Status</th><th>Time</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Admin: Users -->
  <section id="page-adminUsers" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Users</h3>
      <table id="adminUsersTbl">
        <thead>
          <tr><th>Email</th><th>Name</th><th>Phone</th><th>Role</th><th>Approved</th><th>Balance</th><th>Weekly</th><th>Tier</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Admin: Settings -->
  <section id="page-settings" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Settings</h3>
      <div class="row" style="flex-wrap:wrap;gap:8px">
        <button class="btn" onclick="resetWeeklyTotals()">Reset Weekly Totals</button>
        <button class="btn ghost" onclick="recomputeAllTiers()">Recompute All Tiers</button>
      </div>
      <p class="muted" style="margin-top:10px">No Cloud Functions needed ‚Äî these run client-side with admin role.</p>
    </div>
  </section>

  <!-- Logout dummy -->
  <section id="page-logout" class="page hide">
    <div class="panel"><h3 class="title">Logging out‚Ä¶</h3></div>
  </section>
</main>

<!-- Footer -->
<div class="footer">
  <span>¬© 2025 Sarkar Telecom</span>
  <span class="spacer"></span>
  <span class="chip">Week: <span id="ftWeek">0</span></span>
  <span class="chip">Tier: <span id="ftTier">L0</span></span>
  <span class="chip">üíé <span id="ftBal">0</span></span>
</div>

<!-- Firebase compat SDKs (for single-file simplicity) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

<script>
/*** ========= CONFIG ========= ***/
const AUTO_CANCEL_MIN = 5; // minutes
const GIFT_AMOUNTS = [10,50,100,200,500,1000,2000,5000,10000,20000];

// === Your Firebase Config (as provided) ===
const firebaseConfig = {
  apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.firebasestorage.app",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};
/*** ===== END CONFIG ===== ***/

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL);
const db = firebase.firestore();
const storage = firebase.storage();

/* ========= Helpers ========= */
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function fmt(n){return new Intl.NumberFormat().format(n||0)}
function pageId(key){ return `page-${key}`; }
function toast(el,msg){ el.textContent=msg; setTimeout(()=>el.textContent='',4000); }
function tierInfo(total){
  if(total>=800000) return {level:5, pct:3.5};
  if(total>=80000)  return {level:4, pct:2.6};
  if(total>=40000)  return {level:3, pct:2.1};
  if(total>=20000)  return {level:2, pct:1.6};
  if(total>=5000)   return {level:1, pct:1.0};
  return {level:0, pct:0};
}

/* ========= Drawer (sidebar) ========= */
const drawer = $('#drawer');
$('#openMenu').onclick = ()=> drawer.classList.add('show');
$('#closeMenu').onclick = ()=> drawer.classList.remove('show');
$$('.nav a').forEach(a=> a.addEventListener('click', ()=> drawer.classList.remove('show')));
document.addEventListener('keydown', (e)=>{ if(e.key==='Escape') drawer.classList.remove('show'); });

/* ========= Router ========= */
function showPage(key){
  $$('.page').forEach(p=>p.classList.add('hide'));
  $('#'+pageId(key))?.classList.remove('hide');
  $$('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.page===key));
  if(key==='logout') doLogout();
  if(key==='orders') loadMyOrdersLive();
  if(key==='adminOrders') loadAdminOrdersLive();
  if(key==='adminUsers') loadAdminUsersLive();
}
window.addEventListener('hashchange', ()=>{
  const key = (location.hash.replace('#/','')||'dashboard');
  showPage(key);
});
$('#newOrderBtn').onclick=()=>showPage('create');

/* ========= State ========= */
let me=null;       // firebase auth user
let myDoc=null;    // users/{uid} snapshot data
let myWaitingSum=0;

let unsubUser=null, unsubMyWait=null, unsubMyOrders=null, unsubAdminOrders=null, unsubAdminUsers=null;

/* ========= Amount buttons ========= */
function renderAmountButtons(){
  const wrap = $('#amountBtns'); wrap.innerHTML='';
  GIFT_AMOUNTS.forEach(a=>{
    const b=document.createElement('button');
    b.className='btn small';
    b.textContent='üíé '+fmt(a);
    b.onclick=()=>{
      $$('#amountBtns .btn').forEach(x=>x.classList.remove('sel'));
      b.classList.add('sel');
      $('#amount').value=a;
    };
    wrap.appendChild(b);
  });
}
renderAmountButtons();

/* ========= Auth Watcher ========= */
auth.onAuthStateChanged(async u=>{
  cleanupSubscriptions();
  me=u||null;
  if(!me){
    myDoc=null; myWaitingSum=0;
    $('#hdrAnon').classList.remove('hide');
    $('#hdrUser').classList.add('hide');
    $('#linkLogout').classList.add('hide');
    $('#linkLoginAnon').classList.remove('hide');
    $$('.adminOnly').forEach(x=>x.style.display='none');
    showPage('login');
    clearTables();
    return;
  }

  // ensure user doc exists
  const uref = db.collection('users').doc(me.uid);
  const first = await uref.get();
  if(!first.exists){
    await uref.set({
      email: me.email, name: me.displayName||'', phone:'', role:'user',
      approved:false, balance:0, weeklyDiamonds:0, tier:0, avatar:'',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
  }

  // live user doc
  unsubUser = uref.onSnapshot(s=>{
    myDoc = {...s.data(), id:s.id};
    refreshHeaderFooter();
    // admin visibility
    const isAdmin = myDoc.role==='admin';
    $$('.adminOnly').forEach(x=>x.style.display = isAdmin?'block':'none');
    $('#linkLogout').classList.remove('hide');
    $('#linkLoginAnon').classList.add('hide');

    // route
    const target = (location.hash.replace('#/','')||'dashboard');
    showPage(target);
  });

  // live waiting sum (hold)
  unsubMyWait = db.collection('orders')
    .where('uid','==',me.uid)
    .where('status','==','WAITING')
    .onSnapshot(snap=>{
      myWaitingSum = snap.docs.reduce((a,d)=>a+(d.data().amount||0),0);
      refreshHeaderFooter();
    });
});

function cleanupSubscriptions(){
  unsubUser && unsubUser(); unsubUser=null;
  unsubMyWait && unsubMyWait(); unsubMyWait=null;
  unsubMyOrders && unsubMyOrders(); unsubMyOrders=null;
  unsubAdminOrders && unsubAdminOrders(); unsubAdminOrders=null;
  unsubAdminUsers && unsubAdminUsers(); unsubAdminUsers=null;
}
function clearTables(){
  $('#ordersTable tbody').innerHTML='';
  $('#adminOrdersTbl tbody').innerHTML='';
  $('#adminUsersTbl tbody').innerHTML='';
}

/* ========= UI Fill ========= */
function refreshHeaderFooter(){
  if(!me || !myDoc) return;
  $('#hdrAnon').classList.add('hide');
  $('#hdrUser').classList.remove('hide');

  $('#hdrEmail').textContent = me.email||'';
  $('#hdrBal').textContent = 'üíé '+fmt( (myDoc.balance||0) - (myWaitingSum||0) );
  $('#availableBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );
  $('#accEmail').textContent=me.email||'';
  $('#accPhone').textContent=myDoc.phone||'';
  $('#accRole').textContent=myDoc.role||'user';
  $('#accApproved').textContent=String(!!myDoc.approved);
  $('#accWeek').textContent=fmt(myDoc.weeklyDiamonds||0);
  $('#accBal').textContent=fmt(myDoc.balance||0);
  $('#accTier').textContent='L'+(myDoc.tier||0);

  $('#pfEmail').textContent=me.email||'';
  $('#pfRole').textContent=myDoc.role||'user';
  $('#pfApproved').textContent=String(!!myDoc.approved);
  $('#pfBalance').textContent=fmt(myDoc.balance||0);
  $('#pfWeekly').textContent=fmt(myDoc.weeklyDiamonds||0);
  $('#pfTier').textContent='L'+(myDoc.tier||0);
  $('#pfName').value = myDoc.name||'';
  $('#pfPhone').value = myDoc.phone||'';
  $('#hdrAvatar').src = myDoc.avatar || 'https://i.imgur.com/2QfG8z7.png';

  $('#ftWeek').textContent = fmt(myDoc.weeklyDiamonds||0);
  $('#ftTier').textContent = 'L'+(myDoc.tier||0);
  $('#ftBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );
}

/* ========= Auth actions ========= */
async function doLogin(){
  const email = $('#loginEmail').value.trim();
  const pass = $('#loginPass').value;
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    $('#loginMsg').textContent='';
  }catch(e){
    console.error(e); toast($('#loginMsg'), 'Login failed: '+e.message);
  }
}
async function sendReset(){
  const email = me?.email || $('#loginEmail').value.trim();
  if(!email){ toast($('#loginMsg'),'Enter your email first'); return; }
  try{ await auth.sendPasswordResetEmail(email); alert('Reset mail sent to '+email); }
  catch(e){ alert('Error: '+e.message); }
}
async function doRegister(){
  const name=$('#regName').value.trim();
  const phone=$('#regPhone').value.trim();
  const email=$('#regEmail').value.trim();
  const pass=$('#regPass').value;
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({
      email,name,phone,role:'user',approved:false,balance:0,weeklyDiamonds:0,tier:0,avatar:'',
      createdAt: firebase.firestore.FieldValue.serverTimestamp()
    },{merge:true});
    alert('Account created. Wait for admin approval.');
    showPage('profile');
  }catch(e){
    toast($('#regMsg'),'Register failed: '+e.message);
  }
}
async function doLogout(){ await auth.signOut(); }

/* ========= Profile ========= */
async function saveProfile(){
  const name=$('#pfName').value.trim();
  const phone=$('#pfPhone').value.trim();
  try{
    await db.collection('users').doc(me.uid).update({name,phone});
    const file = $('#pfAvatar').files[0];
    if(file){
      const ref = storage.ref(`avatars/${me.uid}/${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await db.collection('users').doc(me.uid).update({avatar:url});
    }
    toast($('#pfMsg'),'Profile updated.');
  }catch(e){ toast($('#pfMsg'),'Error: '+e.message); }
}

/* ========= Create order ========= */
function setupAmountSync(){
  $('#amount').addEventListener('input', ()=>{
    // deselect buttons when manual change
    $$('#amountBtns .btn').forEach(x=>x.classList.remove('sel'));
  });
}
setupAmountSync();

async function createOrder(){
  if(!myDoc?.approved) { alert('Your account is not approved yet.'); return; }
  const clientId = $('#clientId').value.trim();
  const amount = parseInt($('#amount').value||'0',10);
  const avail = (myDoc.balance||0) - (myWaitingSum||0);
  if(!clientId) return alert('Enter client/profile ID');
  if(amount<=0) return alert('Enter a valid amount');
  if(amount>avail) return alert('Insufficient balance');

  try{
    const autoCancelAt = new Date(Date.now()+AUTO_CANCEL_MIN*60*1000);
    await db.collection('orders').add({
      clientId, amount, status:'WAITING',
      userEmail: me.email, uid: me.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      autoCancelAt: firebase.firestore.Timestamp.fromDate(autoCancelAt),
      settled:false
    });
    $('#createMsg').textContent='Order placed ‚úì';
    $('#clientId').value=''; $('#amount').value='50';
    $$('#amountBtns .btn').forEach(x=>x.classList.remove('sel'));
    showPage('orders');
  }catch(e){
    toast($('#createMsg'),'Error: '+e.message);
  }
}

/* ========= Live: my orders ========= */
function loadMyOrdersLive(){
  unsubMyOrders && unsubMyOrders();
  const tbody = $('#ordersTable tbody');
  tbody.innerHTML = '';
  unsubMyOrders = db.collection('orders')
    .where('uid','==',me.uid)
    .orderBy('timestamp','desc')
    .limit(200)
    .onSnapshot(snap=>{
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data(); const id=doc.id;
        const ts=d.timestamp?.toDate?.()||new Date();
        const badge = d.status==='WAITING'?'b-wait': d.status==='COMPLETED'?'b-ok':'b-bad';
        const btn = d.status==='WAITING'
          ? `<button class="btn small ghost" onclick="cancelOwnOrder('${id}')">Cancel</button>`
          : `<button class="btn small ghost" onclick="showPage('create')">Re-order</button>`;
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${id.slice(-6)}</td>
          <td>${d.clientId||''}</td>
          <td>üíé ${fmt(d.amount)}</td>
          <td>${ts.toLocaleString()}</td>
          <td><span class="badge ${badge}">${d.status}</span></td>
          <td>${btn}</td>`;
        tbody.appendChild(tr);
      });
    });
  // also sweep own overdue (non-admin scope)
  autoCancelSweep(false);
}
async function cancelOwnOrder(id){
  try{
    await db.collection('orders').doc(id).update({status:'CANCELLED'});
  }catch(e){ alert('Cancel failed: '+e.message); }
}

/* ========= Auto-cancel overdue ========= */
async function autoCancelSweep(adminScope){
  const isAdmin = myDoc?.role==='admin';
  const q = db.collection('orders')
    .where('status','==','WAITING')
    .where('autoCancelAt','<=',firebase.firestore.Timestamp.now());
  const snap = await q.get();
  const batch = db.batch();
  snap.forEach(doc=>{
    const d=doc.data();
    if(isAdmin || adminScope || d.uid===me?.uid){
      batch.update(doc.ref,{status:'CANCELLED'});
    }
  });
  if(!snap.empty) await batch.commit();
}
// periodic sweep (client-side)
setInterval(()=>{ if(me) autoCancelSweep(false); }, 15000);

/* ========= Admin: Orders (live) ========= */
function loadAdminOrdersLive(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  unsubAdminOrders && unsubAdminOrders();
  const tbody = $('#adminOrdersTbl tbody');
  tbody.innerHTML='';
  unsubAdminOrders = db.collection('orders').orderBy('timestamp','desc').limit(300)
    .onSnapshot(snap=>{
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data(); const id=doc.id;
        const badge = d.status==='WAITING'?'b-wait': d.status==='COMPLETED'?'b-ok':'b-bad';
        const ts=d.timestamp?.toDate?.()||new Date();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${id.slice(-6)}</td>
          <td>${d.clientId}</td>
          <td>üíé ${fmt(d.amount)}</td>
          <td>${d.userEmail}</td>
          <td><span class="badge ${badge}">${d.status}</span></td>
          <td>${ts.toLocaleString()}</td>
          <td class="row">
            <button class="btn small" onclick="adminComplete('${id}')">Complete</button>
            <button class="btn small ghost" onclick="adminCancel('${id}')">Cancel</button>
          </td>`;
        tbody.appendChild(tr);
      });
    });
}
async function adminCancel(id){
  try{ await db.collection('orders').doc(id).update({status:'CANCELLED'}); }
  catch(e){ alert('Cancel failed: '+e.message); }
}
async function adminComplete(id){
  const ref = db.collection('orders').doc(id);
  try{
    await db.runTransaction(async tr=>{
      const o = await tr.get(ref);
      if(!o.exists) throw new Error('Order not found');
      const d=o.data();
      if(d.status!=='WAITING') return;
      tr.update(ref,{status:'COMPLETED', settled:true});
      // deduct balance + add weekly + tier
      const uref = db.collection('users').doc(d.uid);
      const u = await tr.get(uref);
      const user = u.data()||{};
      const newBal = (user.balance||0) - (d.amount||0);
      const newWeekly = (user.weeklyDiamonds||0) + (d.amount||0);
      const t = tierInfo(newWeekly);
      tr.update(uref,{balance:newBal, weeklyDiamonds:newWeekly, tier:t.level});
    });
  }catch(e){ alert('Complete failed: '+e.message); }
}

/* ========= Admin: Users (live) ========= */
function loadAdminUsersLive(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  unsubAdminUsers && unsubAdminUsers();
  const tbody = $('#adminUsersTbl tbody');
  tbody.innerHTML='';
  unsubAdminUsers = db.collection('users').orderBy('email').onSnapshot(snap=>{
    tbody.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data(); const id=doc.id;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d.email||''}</td>
        <td><input value="${d.name||''}" data-id="${id}" data-key="name" onblur="editUser(this)"></td>
        <td><input value="${d.phone||''}" data-id="${id}" data-key="phone" onblur="editUser(this)"></td>
        <td>
          <select data-id="${id}" data-key="role" onchange="editUser(this)">
            <option value="user" ${d.role==='user'?'selected':''}>user</option>
            <option value="admin" ${d.role==='admin'?'selected':''}>admin</option>
          </select>
        </td>
        <td>
          <select data-id="${id}" data-key="approved" onchange="editUser(this)">
            <option value="true" ${d.approved?'selected':''}>true</option>
            <option value="false" ${!d.approved?'selected':''}>false</option>
          </select>
        </td>
        <td>üíé ${fmt(d.balance||0)}</td>
        <td>${fmt(d.weeklyDiamonds||0)}</td>
        <td>L${d.tier||0}</td>
        <td class="row">
          <input type="number" placeholder="Amount" style="width:110px" data-id="${id}" id="delta-${id}">
          <button class="btn small" onclick="addBal('${id}')">Add</button>
          <button class="btn small ghost" onclick="subBal('${id}')">Sub</button>
        </td>
      `;
      tbody.appendChild(tr);
    });
  });
}
async function editUser(el){
  const id=el.dataset.id, key=el.dataset.key;
  let val = el.value;
  if(key==='approved') val = (val==='true');
  try{ await db.collection('users').doc(id).update({[key]:val}); }
  catch(e){ alert('Update failed: '+e.message); }
}
async function addBal(uid){
  const amt = Number( (document.getElementById('delta-'+uid)?.value)||0 );
  if(amt<=0) return alert('Enter amount');
  try{
    await db.runTransaction(async tr=>{
      const u = await tr.get(db.collection('users').doc(uid));
      if(!u.exists) throw new Error('User not found');
      const cur = u.data().balance||0;
      tr.update(u.ref,{balance: cur+amt});
    });
  }catch(e){ alert('Balance add failed: '+e.message); }
}
async function subBal(uid){
  const amt = Number( (document.getElementById('delta-'+uid)?.value)||0 );
  if(amt<=0) return alert('Enter amount');
  try{
    await db.runTransaction(async tr=>{
      const u = await tr.get(db.collection('users').doc(uid));
      if(!u.exists) throw new Error('User not found');
      const cur = u.data().balance||0;
      if(cur<amt) throw new Error('Insufficient balance');
      tr.update(u.ref,{balance: cur-amt});
    });
  }catch(e){ alert('Balance sub failed: '+e.message); }
}

/* ========= Admin: Settings actions ========= */
async function resetWeeklyTotals(){
  if(!confirm('Reset weekly totals for all users?')) return;
  try{
    const snap = await db.collection('users').get();
    const batch = db.batch();
    snap.forEach(doc=> batch.update(doc.ref,{weeklyDiamonds:0,tier:0}));
    await batch.commit();
    alert('Weekly totals reset.');
  }catch(e){ alert('Failed: '+e.message); }
}
async function recomputeAllTiers(){
  try{
    const snap = await db.collection('users').get();
    const batch = db.batch();
    snap.forEach(doc=>{
      const d=doc.data(); const t=tierInfo(d.weeklyDiamonds||0);
      batch.update(doc.ref,{tier:t.level});
    });
    await batch.commit();
    alert('Tiers recomputed.');
  }catch(e){ alert('Failed: '+e.message); }
}
</script>
</body>
</html>