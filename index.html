<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Diamond Recharge</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #121212;
      color: #f1f1f1;
    }
    header, footer {
      background: #1f1f1f;
      padding: 10px;
      text-align: center;
    }
    .sidebar {
      width: 220px;
      background: #1c1c1c;
      position: fixed;
      top: 0; left: -220px;
      height: 100%;
      transition: left 0.3s;
      padding-top: 50px;
    }
    .sidebar.active { left: 0; }
    .sidebar a {
      display: block;
      padding: 12px;
      text-decoration: none;
      color: #f1f1f1;
    }
    .toggle-btn {
      font-size: 20px;
      cursor: pointer;
      background: none;
      border: none;
      color: #fff;
      position: absolute;
      top: 10px;
      left: 10px;
    }
    .page {
      display: none;
      padding: 20px;
    }
    .page.active { display: block; }
    .btn {
      background: #6200ea;
      color: #fff;
      border: none;
      padding: 10px 15px;
      margin: 5px;
      cursor: pointer;
      border-radius: 6px;
    }
    .btn:hover { background: #3700b3; }
    .order-btn {
      display: inline-block;
      background: #333;
      padding: 10px 15px;
      margin: 5px;
      border-radius: 5px;
      cursor: pointer;
    }
    .status {
      padding: 3px 8px;
      border-radius: 4px;
      font-size: 12px;
    }
    .waiting { background: orange; }
    .completed { background: green; }
    .cancelled { background: red; }
  </style>
</head>
<body>
  <header>
    <button class="toggle-btn" onclick="toggleSidebar()">â˜°</button>
    <h2 id="siteTitle">ðŸ’Ž Diamond Recharge</h2>
    <div id="headerUser"></div>
  </header>

  <div class="sidebar" id="sidebar">
    <a href="#" onclick="showPage('loginPage')">Login</a>
    <a href="#" onclick="showPage('dashboardPage')">Dashboard</a>
    <a href="#" onclick="showPage('orderPage')">Order</a>
    <a href="#" onclick="showPage('historyPage')">Order History</a>
    <a href="#" onclick="showPage('profilePage')">Profile</a>
    <a href="#" onclick="logout()">Logout</a>
  </div>

  <main>
    <!-- Login -->
    <section id="loginPage" class="page active">
      <h2>Login</h2>
      <input id="loginEmail" type="email" placeholder="Email"><br>
      <input id="loginPassword" type="password" placeholder="Password"><br>
      <button class="btn" onclick="login()">Login</button>
      <div id="loginMsg"></div>
    </section>

    <!-- Dashboard -->
    <section id="dashboardPage" class="page">
      <h2>Dashboard</h2>
      <p>Welcome <span id="dashName"></span>!</p>
      <p>Balance: <span id="dashBalance">0</span> ðŸ’Ž</p>
      <p>Weekly Orders: <span id="dashWeekly">0</span></p>
      <p>Reward Tier: <span id="dashTier">-</span></p>
    </section>

    <!-- Order -->
    <section id="orderPage" class="page">
      <h2>Place Order</h2>
      <div id="orderButtons"></div>
      <button class="btn" onclick="submitOrder()">Submit Order</button>
      <div id="orderMsg"></div>
    </section>

    <!-- History -->
    <section id="historyPage" class="page">
      <h2>Order History</h2>
      <table border="1" width="100%" id="historyTable">
        <tr><th>ID</th><th>Amount</th><th>Status</th><th>Time</th></tr>
      </table>
    </section>

    <!-- Profile -->
    <section id="profilePage" class="page">
      <h2>Profile</h2>
      <p>Email: <span id="profileEmail"></span></p>
      <p>Name: <input id="profileName"></p>
      <p>Phone: <input id="profilePhone"></p>
      <button class="btn" onclick="updateProfile()">Update</button>
      <div id="profileMsg"></div>
    </section>
  </main>

  <footer>
    <p>Balance: <span id="footBalance">0</span> | Weekly: <span id="footWeekly">0</span></p>
    <p>Â© 2025 Diamond Recharge</p>
  </footer>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";
  import { getFirestore, doc, getDoc, setDoc, updateDoc, addDoc, collection, query, where, getDocs, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase Config
  const firebaseConfig = {
    apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
    authDomain: "diamond-recharge-f7f59.firebaseapp.com",
    projectId: "diamond-recharge-f7f59",
    storageBucket: "diamond-recharge-f7f59.firebasestorage.app",
    messagingSenderId: "657717928489",
    appId: "1:657717928489:web:70431ebc9afb7002d4b238",
    measurementId: "G-TDK78BQ8SQ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  let currentUser = null;
  let orderAmount = 0;

  // Sidebar toggle
  window.toggleSidebar = function(){
    document.getElementById("sidebar").classList.toggle("active");
  }

  // Show page
  window.showPage = function(id){
    document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
    document.getElementById(id).classList.add('active');
  }

  // Login
  window.login = async function(){
    let email = document.getElementById("loginEmail").value;
    let pass = document.getElementById("loginPassword").value;
    try {
      await signInWithEmailAndPassword(auth, email, pass);
      document.getElementById("loginMsg").innerText = "Login success!";
    } catch(e){
      document.getElementById("loginMsg").innerText = "Login failed: " + e.message;
    }
  }

  // Logout
  window.logout = async function(){
    await signOut(auth);
    showPage("loginPage");
  }

  // Profile Update
  window.updateProfile = async function(){
    if(!currentUser) return;
    let name = document.getElementById("profileName").value;
    let phone = document.getElementById("profilePhone").value;
    await updateDoc(doc(db,"users",currentUser.uid), {name, phone});
    document.getElementById("profileMsg").innerText="Updated!";
  }

  // Submit Order
  window.submitOrder = async function(){
    if(!currentUser) return;
    if(orderAmount<=0){ alert("Select amount"); return; }
    let userDoc = await getDoc(doc(db,"users",currentUser.uid));
    if(!userDoc.exists() || !userDoc.data().approved){
      document.getElementById("orderMsg").innerText="You are not approved!";
      return;
    }
    let bal = userDoc.data().balance || 0;
    if(bal < orderAmount){
      document.getElementById("orderMsg").innerText="Insufficient balance!";
      return;
    }
    await addDoc(collection(db,"orders"), {
      userEmail: currentUser.email,
      amount: orderAmount,
      status: "WAITING",
      timestamp: serverTimestamp()
    });
    await updateDoc(doc(db,"users",currentUser.uid), {
      balance: bal - orderAmount,
      weeklyDiamonds: (userDoc.data().weeklyDiamonds||0)+orderAmount
    });
    document.getElementById("orderMsg").innerText="Order placed!";
    loadOrders();
  }

  // Load Orders
  async function loadOrders(){
    if(!currentUser) return;
    let q = query(collection(db,"orders"), where("userEmail","==",currentUser.email));
    let snap = await getDocs(q);
    let table = document.getElementById("historyTable");
    table.innerHTML = "<tr><th>ID</th><th>Amount</th><th>Status</th><th>Time</th></tr>";
    snap.forEach(docu=>{
      let d = docu.data();
      let statusClass = d.status=="WAITING"?"waiting":d.status=="COMPLETED"?"completed":"cancelled";
      table.innerHTML += `<tr><td>${docu.id}</td><td>${d.amount}</td><td><span class="status ${statusClass}">${d.status}</span></td><td>${d.timestamp?.toDate()}</td></tr>`;
    });
  }

  // Auth State
  onAuthStateChanged(auth, async(user)=>{
    if(user){
      currentUser=user;
      let udoc = await getDoc(doc(db,"users",user.uid));
      if(udoc.exists()){
        let data=udoc.data();
        document.getElementById("dashName").innerText=data.name||user.email;
        document.getElementById("dashBalance").innerText=data.balance||0;
        document.getElementById("dashWeekly").innerText=data.weeklyDiamonds||0;
        document.getElementById("dashTier").innerText=data.rewardTier||"-";
        document.getElementById("profileEmail").innerText=user.email;
        document.getElementById("profileName").value=data.name||"";
        document.getElementById("profilePhone").value=data.phone||"";
        document.getElementById("footBalance").innerText=data.balance||0;
        document.getElementById("footWeekly").innerText=data.weeklyDiamonds||0;
      }
      loadOrders();
      showPage("dashboardPage");
    } else {
      currentUser=null;
      showPage("loginPage");
    }
  });

  // Create order buttons
  let orderList=[10,50,100,200,500,1000,2000,5000,10000,20000];
  let orderDiv=document.getElementById("orderButtons");
  orderList.forEach(a=>{
    let btn=document.createElement("div");
    btn.className="order-btn";
    btn.innerText=a;
    btn.onclick=()=>{ orderAmount=a; document.querySelectorAll(".order-btn").forEach(b=>b.style.background="#333"); btn.style.background="#6200ea"; };
    orderDiv.appendChild(btn);
  });
</script>
</body>
</html>