<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1.0"/>
<title>Sarkar Telecom ‚Äî All-in-One Portal</title>
<style>
  :root{
    --bg:#121212;--panel:#1e1e1e;--muted:#aaa;--line:#333;--brand:#4cafef;
    --ok:#2ecc71;--warn:#f1c40f;--bad:#e74c3c;--text:#f1f1f1;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:Arial,Helvetica,sans-serif;background:var(--bg);color:var(--text);overflow-x:hidden}
  a{color:inherit}
  /* Header */
  header{
    position:fixed;top:0;left:0;right:0;height:56px;background:var(--panel);
    display:flex;align-items:center;justify-content:space-between;
    padding:0 12px;border-bottom:1px solid var(--line);z-index:2000
  }
  .left{display:flex;align-items:center;gap:10px}
  .brand{margin:0;font-size:16px;color:var(--brand);white-space:nowrap}
  .hamb{border:none;background:transparent;color:#fff;font-size:24px;cursor:pointer;line-height:1}
  .right{display:flex;align-items:center;gap:10px}
  .user-pill{display:flex;align-items:center;gap:10px;background:#191919;border:1px solid var(--line);padding:6px 10px;border-radius:999px}
  .user-pill img{width:28px;height:28px;border-radius:50%;object-fit:cover;background:#222}
  .user-meta{display:flex;flex-direction:column;line-height:1.1}
  .user-meta .name{font-size:12px}
  .user-meta .role{font-size:11px;color:var(--muted)}
  .hud{display:flex;gap:10px;font-size:12px;color:var(--muted)}
  .chip{padding:3px 8px;border-radius:999px;border:1px solid var(--line);background:#191919}
  /* Sidebar + overlay */
  .overlay{position:fixed;inset:0;background:#0008;opacity:0;pointer-events:none;transition:.2s;z-index:1800}
  .overlay.show{opacity:1;pointer-events:auto}
  .sidebar{
    position:fixed;top:0;left:-260px;width:260px;height:100vh;background:var(--panel);
    border-right:1px solid var(--line);z-index:1900;transition:left .25s ease; padding-top:56px;overflow-y:auto
  }
  .sidebar.open{left:0}
  .side-link{display:block;padding:12px 16px;border-bottom:1px solid var(--line);color:#ddd;text-decoration:none;font-size:14px}
  .side-link:hover{background:#2a2a2a}
  /* Main wrapper */
  main{padding:16px;max-width:1100px;margin:72px auto 84px}
  .page{display:none}
  .page.active{display:block}
  h2.section{margin:6px 0 14px 0;font-size:18px;color:var(--brand);text-align:center}
  /* Cards / panels */
  .card{background:var(--panel);border:1px solid var(--line);border-radius:12px;padding:14px}
  .grid{display:grid;gap:12px}
  @media(min-width:768px){ .grid.cols-2{grid-template-columns:1fr 1fr} .grid.cols-3{grid-template-columns:repeat(3,1fr)} }
  /* Forms */
  input,select,button,textarea{
    font:inherit;border-radius:8px;border:1px solid var(--line);background:#181818;color:var(--text);padding:10px
  }
  label{font-size:13px;color:var(--muted)}
  .row{display:flex;gap:10px;flex-wrap:wrap}
  .grow{flex:1}
  .btn{background:var(--brand);border:none;color:#fff;cursor:pointer}
  .btn:disabled{opacity:.6;cursor:not-allowed}
  .btn.warn{background:#d29400}
  .btn.ok{background:var(--ok)}
  .btn.bad{background:var(--bad)}
  .btn.ghost{background:#222;border:1px solid var(--line);color:#ddd}
  /* Gift grid */
  .gift-grid{display:grid;grid-template-columns:repeat(3,1fr);gap:12px}
  .gift{background:#181818;border:2px solid transparent;border-radius:12px;padding:18px;text-align:center;cursor:pointer}
  .gift .amt{font-weight:bold}
  .gift:hover{background:#222}
  .gift.selected{border-color:var(--brand);background:#202020}
  /* Status pill */
  .status{display:inline-block;padding:5px 8px;border-radius:8px;font-size:12px;color:#000;font-weight:bold}
  .waiting{background:var(--warn);color:#000}
  .completed{background:var(--ok);color:#000}
  .cancelled{background:var(--bad);color:#fff}
  /* Tables */
  .table-wrap{overflow:auto}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid #2b2b2b;text-align:center}
  th{background:#181818;color:var(--brand);position:sticky;top:0}
  /* Footer */
  footer{
    position:fixed;left:0;right:0;bottom:0;background:var(--panel);border-top:1px solid var(--line);
    padding:10px 12px;display:flex;justify-content:space-between;align-items:center;gap:10px;flex-wrap:wrap;z-index:1500
  }
  .foot-left{font-size:12px;color:var(--muted)}
  .foot-right{display:flex;gap:8px;flex-wrap:wrap}
  /* Login/Register gate */
  .center{text-align:center}
  .hide{display:none !important}
  /* Utilities */
  .mt8{margin-top:8px}.mt12{margin-top:12px}.mt16{margin-top:16px}.mt20{margin-top:20px}
  .inline{display:inline-flex;gap:8px;align-items:center}
  .right-actions{display:flex;gap:8px;flex-wrap:wrap;justify-content:flex-end}
  .pill{padding:6px 10px;border:1px solid var(--line);background:#191919;border-radius:999px}
</style>
</head>
<body>

<!-- Header -->
<header>
  <div class="left">
    <button class="hamb" id="hamb">‚ò∞</button>
    <h1 class="brand">Sarkar Telecom</h1>
  </div>
  <div class="right">
    <div class="hud">
      <span class="chip" id="hudBalance">Balance: üíé 0</span>
      <span class="chip" id="hudTier">Tier: L0 (0%)</span>
    </div>
    <div class="user-pill" id="userPill">
      <img id="userAvatar" alt="user"/>
      <div class="user-meta">
        <span class="name" id="userName">Guest</span>
        <span class="role" id="userRole">Not logged in</span>
      </div>
    </div>
  </div>
</header>

<!-- Sidebar + overlay -->
<div class="overlay" id="overlay"></div>
<nav class="sidebar" id="sidebar">
  <a href="#dashboard" class="side-link" data-page="dashboard">üè† Dashboard</a>
  <a href="#order" class="side-link" data-page="order">‚ûï Create Order</a>
  <a href="#history" class="side-link" data-page="history">üìë Order History</a>
  <a href="#admin-orders" class="side-link admin-only" data-page="adminOrders">üõ† Manage Orders</a>
  <a href="#admin-users" class="side-link admin-only" data-page="adminUsers">üë• Manage Users</a>
  <a href="#profile" class="side-link" data-page="profile">üë§ Profile</a>
  <a href="#login" class="side-link" data-page="login" id="loginLink">üîê Login / Register</a>
  <a href="#logout" class="side-link" id="logoutLink">üö™ Logout</a>
</nav>

<!-- Main -->
<main id="main">
  <!-- Dashboard -->
  <section id="page-dashboard" class="page active">
    <div class="card">
      <h2 class="section">Welcome to Sarkar Telecom</h2>
      <div class="grid cols-3">
        <div class="card">
          <label>Total Balance</label>
          <div class="mt8"><span id="dashBalance" class="pill">üíé 0</span></div>
        </div>
        <div class="card">
          <label>Weekly Diamonds (Thu 10 PM BD ‚Üí Thu 10 PM BD)</label>
          <div class="mt8"><span id="dashWeekly" class="pill">0</span></div>
        </div>
        <div class="card">
          <label>Reward Tier</label>
          <div class="mt8"><span id="dashTier" class="pill">L0 (0%)</span></div>
        </div>
      </div>
      <div class="right-actions mt16">
        <button class="btn" data-page="order">Create Order</button>
        <button class="btn ghost" data-page="history">View Order History</button>
        <button class="btn ghost admin-only" data-page="adminOrders">Admin: Manage Orders</button>
      </div>
    </div>
  </section>

  <!-- Create Order -->
  <section id="page-order" class="page">
    <div class="card">
      <h2 class="section">Gifting Order</h2>
      <div class="grid cols-2">
        <div class="card">
          <label>Gift Recipient (Number / Profile ID)</label>
          <input id="recipientInput" type="number" placeholder="Enter Profile ID or Number" class="mt8"/>
        </div>
        <div class="card">
          <label>Selected Amount (üíé)</label>
          <input id="selectedAmount" type="text" disabled class="mt8" value="0"/>
        </div>
      </div>
      <div class="mt12">
        <label>Select a Gift</label>
        <div class="gift-grid mt8" id="giftGrid"></div>
      </div>
      <div class="right-actions mt16">
        <button class="btn" id="confirmOrderBtn" disabled>Order Confirm</button>
      </div>
      <div class="mt12" style="font-size:12px;color:var(--muted)">
        Note: Orders auto-cancel after 5 minutes if not marked completed by admin. Cancel refunds the client balance immediately.
      </div>
    </div>
  </section>

  <!-- Order History -->
  <section id="page-history" class="page">
    <div class="card">
      <h2 class="section">Order History</h2>
      <div class="table-wrap mt12">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>Client ID</th>
              <th>Amount (üíé)</th>
              <th>Status</th>
              <th>Time</th>
            </tr>
          </thead>
          <tbody id="histBody"></tbody>
        </table>
      </div>
      <div class="right-actions mt16">
        <button class="btn" data-page="order">‚ûï Create Order</button>
      </div>
    </div>
  </section>

  <!-- Admin: Manage Orders -->
  <section id="page-adminOrders" class="page">
    <div class="card">
      <h2 class="section">Admin ‚Äî Manage All Orders</h2>
      <div class="table-wrap mt12">
        <table>
          <thead>
            <tr>
              <th>Order ID</th>
              <th>User Email</th>
              <th>Client ID</th>
              <th>Amount (üíé)</th>
              <th>Status</th>
              <th>Time</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody id="adminOrdersBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Admin: Manage Users -->
  <section id="page-adminUsers" class="page">
    <div class="card">
      <h2 class="section">Admin ‚Äî Manage Users</h2>
      <div class="table-wrap mt12">
        <table>
          <thead>
            <tr>
              <th>Avatar</th>
              <th>Name</th>
              <th>Email</th>
              <th>Phone</th>
              <th>Role</th>
              <th>Status</th>
              <th>Balance (üíé)</th>
              <th>Weekly</th>
              <th>Tier</th>
              <th>+ / ‚àí Balance</th>
              <th>Save</th>
            </tr>
          </thead>
          <tbody id="adminUsersBody"></tbody>
        </table>
      </div>
    </div>
  </section>

  <!-- Profile -->
  <section id="page-profile" class="page">
    <div class="card">
      <h2 class="section">Profile</h2>
      <div class="grid cols-2">
        <div class="card">
          <label>Avatar</label>
          <div class="row mt8">
            <img id="profAvatarPreview" style="width:72px;height:72px;border-radius:50%;object-fit:cover;background:#222"/>
            <input id="profAvatarInput" type="file" accept="image/*"/>
          </div>
        </div>
        <div class="card">
          <label>Name</label>
          <input id="profName" class="mt8" placeholder="Your Name"/>
          <label class="mt8">Phone</label>
          <input id="profPhone" placeholder="+8801..."/>
          <label class="mt8">Change Password</label>
          <input id="profPass" type="password" placeholder="New Password"/>
        </div>
      </div>
      <div class="right-actions mt16">
        <button class="btn" id="saveProfileBtn">Save Profile</button>
      </div>
    </div>
  </section>

  <!-- Login / Register -->
  <section id="page-login" class="page">
    <div class="card">
      <h2 class="section">Login / Register</h2>
      <div class="grid cols-2">
        <div class="card">
          <h3 class="section" style="margin-top:0">Login</h3>
          <label>Email</label>
          <input id="loginEmail" placeholder="email@example.com" class="mt8"/>
          <label class="mt8">Password</label>
          <input id="loginPass" type="password" placeholder="password"/>
          <div class="mt12">
            <button id="doLogin" class="btn">Login</button>
            <button id="doReset" class="btn ghost mt8">Forgot Password</button>
          </div>
          <div class="mt8" style="font-size:12px;color:var(--muted)">
            New here? <a href="#" data-page="register" id="gotoReg">Create an account</a>
          </div>
        </div>
        <div class="card" id="registerCard">
          <h3 class="section" style="margin-top:0">Register</h3>
          <label>Email</label>
          <input id="regEmail" placeholder="email@example.com" class="mt8"/>
          <label class="mt8">Password</label>
          <input id="regPass" type="password" placeholder="password"/>
          <label class="mt8">Name</label>
          <input id="regName" placeholder="Your name"/>
          <label class="mt8">Phone</label>
          <input id="regPhone" placeholder="+8801..."/>
          <div class="mt12">
            <button id="doRegister" class="btn">Register (Needs Admin Approval)</button>
          </div>
          <div class="mt8" style="font-size:12px;color:var(--muted)">
            After registering, an admin must approve your account before you can log in.
          </div>
        </div>
      </div>
    </div>
  </section>
</main>

<!-- Footer -->
<footer>
  <div class="foot-left">¬© 2025 Sarkar Telecom. All rights reserved.</div>
  <div class="foot-right">
    <span class="chip" id="footBalance">Balance: üíé 0</span>
    <span class="chip" id="footTier">Tier: L0 (0%)</span>
  </div>
</footer>

<!-- Firebase SDKs -->
<script type="module">
/* ===== Firebase Init (Your Config) ===== */
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth, onAuthStateChanged, signInWithEmailAndPassword,
  createUserWithEmailAndPassword, sendPasswordResetEmail, signOut, updatePassword
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, doc, getDoc, setDoc, updateDoc, serverTimestamp,
  onSnapshot, collection, addDoc, query, where, orderBy, limit, Timestamp,
  runTransaction, getDocs
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";
import {
  getStorage, ref as sRef, uploadBytes, getDownloadURL
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-storage.js";

/* ---- Your Provided Config ---- */
const firebaseConfig = {
  apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.firebasestorage.app",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);
const storage = getStorage(app);

/* ======= UI Helpers ======= */
const $ = id => document.getElementById(id);
const pages = {
  dashboard:'page-dashboard', order:'page-order', history:'page-history',
  adminOrders:'page-adminOrders', adminUsers:'page-adminUsers',
  profile:'page-profile', login:'page-login'
};
function showPage(key){
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('active'));
  $(pages[key]||'page-dashboard').classList.add('active');
  if(key!=='login') sidebarClose();
}
function avatarFallback(){return 'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="64" height="64"><rect width="100%" height="100%" fill="%23222"/><text x="50%" y="54%" font-size="20" fill="%23aaa" text-anchor="middle">üë§</text></svg>'}

/* ======= Sidebar Toggle ======= */
const sidebar = $('sidebar'), overlay = $('overlay'), hamb = $('hamb');
function sidebarOpen(){ sidebar.classList.add('open'); overlay.classList.add('show'); }
function sidebarClose(){ sidebar.classList.remove('open'); overlay.classList.remove('show'); }
hamb.addEventListener('click',()=> sidebar.classList.contains('open')?sidebarClose():sidebarOpen());
overlay.addEventListener('click', sidebarClose);
window.addEventListener('keydown', e=>{ if(e.key==='Escape') sidebarClose(); });
document.querySelectorAll('.side-link[data-page], .btn[data-page], a[data-page]').forEach(el=>{
  el.addEventListener('click', (e)=>{ e.preventDefault(); showPage(el.getAttribute('data-page')); });
});

/* ======= Gift Buttons ======= */
const GIFT_AMOUNTS = [10,50,100,200,500,1000,2000,5000,10000,20000];
function renderGifts(){
  const grid = $('giftGrid'); grid.innerHTML='';
  GIFT_AMOUNTS.forEach(amt=>{
    const d = document.createElement('div');
    d.className='gift'; d.dataset.amount=String(amt);
    d.innerHTML = `<div class="amt">üíé ${amt.toLocaleString()}</div>`;
    d.addEventListener('click', ()=>{
      document.querySelectorAll('.gift').forEach(g=>g.classList.remove('selected'));
      d.classList.add('selected');
      $('selectedAmount').value = amt;
      enableOrderConfirmCheck();
    });
    grid.appendChild(d);
  });
}
renderGifts();

/* ======= Reward Tiers ======= */
function tierInfo(total){
  if(total>=800000) return {level:5, pct:3.5};
  if(total>=80000)  return {level:4, pct:2.6};
  if(total>=40000)  return {level:3, pct:2.1};
  if(total>=20000)  return {level:2, pct:1.6};
  if(total>=5000)   return {level:1, pct:1.0};
  return {level:0, pct:0};
}

/* ======= Weekly Boundary (Asia/Dhaka UTC+6) ======= */
function nowBd(){ const d=new Date(), utc=d.getTime()+d.getTimezoneOffset()*60000; return new Date(utc+6*3600000); }
function currentBoundaryEpoch(){
  const d = nowBd(); const day = d.getDay(); const diffToThu = (day - 4 + 7) % 7;
  const lastThu = new Date(d.getFullYear(),d.getMonth(),d.getDate()-diffToThu,22,0,0,0);
  return lastThu.getTime();
}

/* ======= Auth State & Live User Doc ======= */
let me = null;           // auth user (firebase)
let meDoc = null;        // users/{uid} snapshot data
let unsubUser = null, unsubOwnOrders = null, unsubAllOrders = null, unsubAllUsers = null;

function resetSubs(){
  if(unsubUser){unsubUser();unsubUser=null}
  if(unsubOwnOrders){unsubOwnOrders();unsubOwnOrders=null}
  if(unsubAllOrders){unsubAllOrders();unsubAllOrders=null}
  if(unsubAllUsers){unsubAllUsers();unsubAllUsers=null}
  $('histBody').innerHTML='';
  $('adminOrdersBody').innerHTML='';
  $('adminUsersBody').innerHTML='';
  updateHud(null);
}

function updateHud(userData){
  const u = userData;
  const avatar = u?.photoURL || avatarFallback();
  $('userAvatar').src = avatar;
  $('userName').textContent = u ? (u.name || u.email || 'User') : 'Guest';
  $('userRole').textContent = u ? `${u.email} (${u.role||'user'})` : 'Not logged in';
  const bal = u?.balance||0;
  $('hudBalance').textContent = `Balance: üíé ${bal.toLocaleString()}`;
  $('footBalance').textContent = `Balance: üíé ${bal.toLocaleString()}`;
  $('dashBalance').textContent = `üíé ${bal.toLocaleString()}`;
  const info = tierInfo(u?.weeklyTotal||0);
  $('hudTier').textContent = `Tier: L${info.level} (${info.pct}%)`;
  $('footTier').textContent = `Tier: L${info.level} (${info.pct}%)`;
  $('dashWeekly').textContent = (u?.weeklyTotal||0).toLocaleString();
  $('dashTier').textContent = `L${info.level} (${info.pct}%)`;
  // admin links show/hide
  document.querySelectorAll('.admin-only').forEach(el=>{ el.style.display = (u&&u.role==='admin')?'inline-block':'none'; });
  $('loginLink').style.display = u ? 'none' : 'block';
  $('logoutLink').style.display = u ? 'block' : 'none';
}

onAuthStateChanged(auth, async (user)=>{
  me = user || null;
  resetSubs();
  if(!me){ showPage('login'); return; }

  // attach users/{uid}
  const uRef = doc(db,'users',me.uid);
  unsubUser = onSnapshot(uRef, async snap=>{
    if(!snap.exists()){
      // If missing, create a minimal doc (active only after admin approves)
      await setDoc(uRef,{
        email: me.email||'',
        role:'user',
        status:'pending',
        balance:0,
        weeklyTotal:0,
        tier:0,
        name:'',
        phone:'',
        photoURL: me.photoURL||'',
        createdAt: serverTimestamp(),
        weekBoundary: currentBoundaryEpoch()
      },{merge:true});
      return;
    }
    meDoc = snap.data();
    // weekly boundary check (client side)
    const curB = currentBoundaryEpoch();
    if((meDoc.weekBoundary||0) < curB){
      await updateDoc(uRef, { weeklyTotal:0, tier:0, weekBoundary:curB });
    }
    updateHud({...meDoc, email: me.email||meDoc.email});

    // access gate
    if(meDoc.status!=='active'){
      showPage('login');
      alert('Your account is not approved yet.');
      return;
    }

    // own orders live
    const myQ = query(
      collection(db,'orders'),
      where('userId','==',me.uid),
      orderBy('createdAt','desc'),
      limit(100)
    );
    unsubOwnOrders = onSnapshot(myQ, (qs)=>{
      renderHistory(qs.docs.map(d=>({id:d.id, ...d.data()})));
    });

    // if admin, attach admin panels
    if(meDoc.role==='admin'){
      // all orders
      const allQ = query(collection(db,'orders'), orderBy('createdAt','desc'), limit(200));
      unsubAllOrders = onSnapshot(allQ, (qs)=>{
        renderAdminOrders(qs.docs.map(d=>({id:d.id, ...d.data()})));
      });
      // all users
      unsubAllUsers = onSnapshot(collection(db,'users'), (qs)=>{
        renderAdminUsers(qs.docs.map(d=>({id:d.id, ...d.data()})));
      });
    }
  });

  showPage('dashboard');
});

/* ======= Login / Register / Logout ======= */
$('doLogin').addEventListener('click', async ()=>{
  try{
    const email=$('loginEmail').value.trim().toLowerCase();
    const pass=$('loginPass').value;
    const res=await signInWithEmailAndPassword(auth,email,pass);
    // approved check happens in onSnapshot(userDoc)
    showPage('dashboard');
  }catch(e){ alert(e.message); }
});
$('doReset').addEventListener('click', async ()=>{
  const email = prompt('Enter your email for reset link:');
  if(!email) return;
  try{ await sendPasswordResetEmail(auth,email.trim().toLowerCase()); alert('Password reset email sent.'); }
  catch(e){ alert(e.message); }
});
$('gotoReg').addEventListener('click', (e)=>{ e.preventDefault(); showPage('login'); $('registerCard').scrollIntoView({behavior:'smooth'}); });
$('doRegister').addEventListener('click', async ()=>{
  try{
    const email=$('regEmail').value.trim().toLowerCase();
    const pass=$('regPass').value;
    const name=$('regName').value.trim(); const phone=$('regPhone').value.trim();
    if(!email||!pass) return alert('Email and password required.');
    const {user}=await createUserWithEmailAndPassword(auth,email,pass);
    await setDoc(doc(db,'users',user.uid),{
      email, role:'user', status:'pending', balance:0, weeklyTotal:0, tier:0,
      name, phone, photoURL:'', createdAt:serverTimestamp(), weekBoundary: currentBoundaryEpoch()
    },{merge:true});
    alert('Registered! Waiting for admin approval.');
    await signOut(auth);
    showPage('login');
  }catch(e){ alert(e.message); }
});
$('logoutLink').addEventListener('click', async (e)=>{ e.preventDefault(); await signOut(auth); showPage('login'); });

/* ======= Profile ======= */
function loadProfileForm(){
  if(!me || !meDoc) return;
  $('profName').value = meDoc.name||'';
  $('profPhone').value = meDoc.phone||'';
  $('profPass').value = '';
  $('profAvatarPreview').src = meDoc.photoURL || avatarFallback();
}
$('profAvatarInput').addEventListener('change', async (e)=>{
  const file = e.target.files[0]; if(!file || !me) return;
  try{
    const r = sRef(storage, `avatars/${me.uid}`);
    await uploadBytes(r, file);
    const url = await getDownloadURL(r);
    await updateDoc(doc(db,'users',me.uid), { photoURL:url });
  }catch(err){ alert(err.message); }
});
$('saveProfileBtn').addEventListener('click', async ()=>{
  try{
    if(!me||!meDoc) return alert('Login first.');
    const up = {};
    const nm = $('profName').value.trim(); if(nm) up.name=nm;
    const ph = $('profPhone').value.trim(); up.phone=ph;
    if($('profPass').value){ await updatePassword(me, $('profPass').value); }
    if(Object.keys(up).length) await updateDoc(doc(db,'users',me.uid), up);
    alert('Profile updated.');
  }catch(e){ alert(e.message); }
});

/* ======= Order Create (transaction) ======= */
$('recipientInput').addEventListener('input', enableOrderConfirmCheck);
function enableOrderConfirmCheck(){
  const recip = $('recipientInput').value.trim();
  const amt = Number($('selectedAmount').value||0);
  const bal = meDoc?.balance||0;
  $('confirmOrderBtn').disabled = !(me && meDoc && meDoc.status==='active' && recip && amt>0 && bal>=amt);
}

async function createOrderTx(clientId, amount){
  await runTransaction(db, async (tx)=>{
    const uRef = doc(db,'users',me.uid);
    const uSnap = await tx.get(uRef);
    if(!uSnap.exists()) throw new Error('User not found.');
    const u = uSnap.data();
    if(u.status!=='active') throw new Error('You are not approved.');
    if(u.balance < amount) throw new Error('Insufficient balance.');
    // deduct
    tx.update(uRef,{ balance: u.balance - amount });

    // create order
    const createdAt = serverTimestamp();
    const expiresAt = Timestamp.fromMillis(Date.now()+5*60*1000);
    const oRef = doc(collection(db,'orders'));
    tx.set(oRef,{
      userId: me.uid, userEmail: me.email, clientId,
      amount, status:'waiting', createdAt, expiresAt, refunded:false
    });
  });
}
$('confirmOrderBtn').addEventListener('click', async ()=>{
  try{
    const clientId = $('recipientInput').value.trim();
    const amt = Number($('selectedAmount').value||0);
    if(!clientId||!amt) return;
    await createOrderTx(clientId, amt);
    // reset form
    $('recipientInput').value=''; $('selectedAmount').value='0';
    document.querySelectorAll('.gift').forEach(g=>g.classList.remove('selected'));
    $('confirmOrderBtn').disabled = true;
    showPage('history');
  }catch(e){ alert(e.message); }
});

/* ======= History Render (own) ======= */
function renderHistory(list){
  const tbody = $('histBody'); tbody.innerHTML='';
  list.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.id}</td>
      <td>${o.clientId}</td>
      <td>${Number(o.amount||0).toLocaleString()}</td>
      <td><span class="status ${o.status}">${o.status}</span></td>
      <td>${o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() : ''}</td>
    `;
    tbody.appendChild(tr);
  });
}

/* ======= Admin: Orders ======= */
async function adminSetOrderStatus(orderId, newStatus){
  if(meDoc?.role!=='admin') return alert('Admin only.');
  await runTransaction(db, async (tx)=>{
    const oRef = doc(db,'orders',orderId);
    const oSnap = await tx.get(oRef); if(!oSnap.exists()) throw new Error('Order not found.');
    const o = oSnap.data();
    if(o.status===newStatus) return;

    const uRef = doc(db,'users', o.userId);
    const uSnap = await tx.get(uRef); if(!uSnap.exists()) throw new Error('User not found.');
    const u = uSnap.data();

    if(newStatus==='cancelled'){
      // refund if not refunded
      if(!o.refunded){
        tx.update(uRef,{ balance: (u.balance||0) + (o.amount||0) });
      }
      tx.update(oRef,{ status:'cancelled', refunded:true });
    }else if(newStatus==='completed'){
      // add to weekly & tier (only once from waiting)
      if(o.status==='waiting'){
        const newWeekly = (u.weeklyTotal||0) + (o.amount||0);
        const info = tierInfo(newWeekly);
        tx.update(uRef,{ weeklyTotal:newWeekly, tier: info.level });
      }
      tx.update(oRef,{ status:'completed' });
    }
  });
}

function renderAdminOrders(list){
  const tbody = $('adminOrdersBody'); tbody.innerHTML='';
  list.forEach(o=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${o.id}</td>
      <td>${o.userEmail}</td>
      <td>${o.clientId}</td>
      <td>${Number(o.amount||0).toLocaleString()}</td>
      <td><span class="status ${o.status}">${o.status}</span></td>
      <td>${o.createdAt?.toDate ? o.createdAt.toDate().toLocaleString() : ''}</td>
      <td class="inline">
        <button class="btn ok" data-act="complete" data-id="${o.id}" ${o.status==='completed'?'disabled':''}>Complete</button>
        <button class="btn bad" data-act="cancel" data-id="${o.id}" ${o.status==='cancelled'?'disabled':''}>Cancel</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
  tbody.querySelectorAll('button[data-act]').forEach(btn=>{
    btn.addEventListener('click', ()=>{
      const id = btn.getAttribute('data-id');
      const act = btn.getAttribute('data-act');
      adminSetOrderStatus(id, act==='complete'?'completed':'cancelled').catch(e=>alert(e.message));
    });
  });
}

/* ======= Admin: Users ======= */
function renderAdminUsers(list){
  const tbody = $('adminUsersBody'); tbody.innerHTML='';
  list.forEach(x=>{
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${x.photoURL||avatarFallback()}" style="width:36px;height:36px;border-radius:50%;object-fit:cover"/></td>
      <td><input data-k="name" data-id="${x.id}" value="${x.name||''}"/></td>
      <td><input data-k="email" data-id="${x.id}" value="${x.email||''}" disabled/></td>
      <td><input data-k="phone" data-id="${x.id}" value="${x.phone||''}"/></td>
      <td>
        <select data-k="role" data-id="${x.id}">
          <option ${x.role==='user'?'selected':''}>user</option>
          <option ${x.role==='admin'?'selected':''}>admin</option>
        </select>
      </td>
      <td>
        <select data-k="status" data-id="${x.id}">
          <option ${x.status==='active'?'selected':''}>active</option>
          <option ${x.status==='pending'?'selected':''}>pending</option>
          <option ${x.status==='blocked'?'selected':''}>blocked</option>
        </select>
      </td>
      <td>üíé ${(x.balance||0).toLocaleString()}</td>
      <td>${(x.weeklyTotal||0).toLocaleString()}</td>
      <td>L${x.tier||0}</td>
      <td class="inline">
        <input type="number" style="width:100px" placeholder="Amount" data-k="delta" data-id="${x.id}"/>
        <button class="btn" data-act="add" data-id="${x.id}">Add</button>
        <button class="btn bad" data-act="sub" data-id="${x.id}">Sub</button>
      </td>
      <td class="inline">
        <button class="btn ok" data-act="save" data-id="${x.id}">Save</button>
      </td>
    `;
    tbody.appendChild(tr);
  });

  // Balance Add/Sub
  tbody.querySelectorAll('button[data-act="add"],button[data-act="sub"]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      if(meDoc?.role!=='admin') return alert('Admin only.');
      const uid = b.getAttribute('data-id');
      const deltaInput = tbody.querySelector(`input[data-k="delta"][data-id="${uid}"]`);
      const amt = Number(deltaInput.value||0);
      if(amt<=0) return alert('Enter amount.');
      const sign = b.getAttribute('data-act')==='add' ? +1 : -1;
      try{
        await runTransaction(db, async (tx)=>{
          const uRef = doc(db,'users',uid);
          const uSnap = await tx.get(uRef); if(!uSnap.exists()) throw new Error('User missing');
          const cur = uSnap.data();
          const newBal = (cur.balance||0) + sign*amt;
          if(newBal<0) throw new Error('Negative balance not allowed');
          tx.update(uRef,{ balance:newBal });
        });
      }catch(e){ alert(e.message); }
      deltaInput.value='';
    });
  });

  // Save row
  tbody.querySelectorAll('button[data-act="save"]').forEach(b=>{
    b.addEventListener('click', async ()=>{
      if(meDoc?.role!=='admin') return alert('Admin only.');
      const uid = b.getAttribute('data-id');
      const name = tbody.querySelector(`input[data-k="name"][data-id="${uid}"]`)?.value||'';
      const phone = tbody.querySelector(`input[data-k="phone"][data-id="${uid}"]`)?.value||'';
      const role = tbody.querySelector(`select[data-k="role"][data-id="${uid}"]`)?.value||'user';
      const status = tbody.querySelector(`select[data-k="status"][data-id="${uid}"]`)?.value||'pending';
      try{
        await updateDoc(doc(db,'users',uid), { name, phone, role, status });
        alert('Saved.');
      }catch(e){ alert(e.message); }
    });
  });
}

/* ======= Auto-cancel Sweep (every 10s) ======= */
async function sweepExpired(){
  // admin sweeps all; user sweeps own
  if(!me) return;
  const isAdmin = meDoc?.role==='admin';
  const baseQ = isAdmin
    ? query(collection(db,'orders'), where('status','==','waiting'))
    : query(collection(db,'orders'), where('userId','==',me.uid), where('status','==','waiting'));
  try{
    const qs = await getDocs(baseQ);
    const now = Date.now();
    for(const d of qs.docs){
      const o = d.data();
      const exp = o.expiresAt?.toMillis?.()||0;
      if(exp && exp<now){
        // perform cancel+refund via transaction
        await runTransaction(db, async (tx)=>{
          const oRef = doc(db,'orders',d.id);
          const oSnap = await tx.get(oRef);
          const cur = oSnap.data();
          if(cur.status!=='waiting') return;
          const uRef = doc(db,'users', cur.userId);
          const uSnap = await tx.get(uRef); if(!uSnap.exists()) return;
          const ub = (uSnap.data().balance||0) + (cur.amount||0);
          tx.update(uRef,{ balance: ub });
          tx.update(oRef,{ status:'cancelled', refunded:true });
        });
      }
    }
  }catch(e){ /* silent */ }
}
setInterval(sweepExpired, 10000);

/* ======= Navigation helpers ======= */
$('userPill').addEventListener('click', ()=> showPage('profile'));
function refreshAll(){
  updateHud(meDoc?{...meDoc, email:me?.email}:null);
  loadProfileForm();
  enableOrderConfirmCheck();
}
document.addEventListener('visibilitychange', ()=>{ if(!document.hidden) refreshAll(); });

</script>
</body>
</html>