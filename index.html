<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Sarkar Telecom ‚Ä¢ Diamond Portal</title>
<meta name="color-scheme" content="dark">
<style>
:root{
  --bg:#0f1216;--card:#151a21;--muted:#a9b1bd;--line:#242c36;--brand:#42a5f5;
  --good:#2ecc71;--bad:#e74c3c;--wait:#f1c40f;
}
*{box-sizing:border-box}
html,body{height:100%}
body{margin:0;background:var(--bg);color:#e9eef5;font-family:system-ui,-apple-system,Segoe UI,Roboto,Ubuntu,Helvetica,Arial}
a{color:inherit}
button{font:inherit}
input,select,textarea{background:#0e1218;border:1px solid var(--line);color:#fff;border-radius:10px;padding:10px}
.section{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:14px;margin:12px 0}
h2{margin:0 0 10px;font-size:18px}
.small{color:var(--muted);font-size:12px}
.row{display:flex;gap:10px;flex-wrap:wrap}
.field{display:flex;flex-direction:column;gap:6px;flex:1 1 220px}
.btn{background:var(--brand);color:#00111c;border:none;border-radius:10px;padding:10px 14px;cursor:pointer}
.btn.outline{background:transparent;color:var(--brand);border:1px solid var(--brand)}
.btn.good{background:var(--good);color:#001b0f}
.btn.danger{background:var(--bad)}
.btn.wait{background:var(--wait);color:#1a1a00}
.btn:disabled{opacity:.55;cursor:not-allowed}
.pill{padding:5px 10px;border-radius:999px;background:#0e1218;border:1px solid var(--line);font-size:12px}
.table-wrap{overflow:auto;border:1px solid var(--line);border-radius:12px}
table{width:100%;border-collapse:collapse;background:#0e1218}
th,td{padding:10px;border-bottom:1px solid #1b232d;text-align:center;font-size:13px}
th{position:sticky;top:0;background:#121821;color:#cfe9ff;z-index:1}
.status{display:inline-block;padding:4px 8px;border-radius:7px;font-weight:700;font-size:12px;color:#111}
.status.WAITING{background:var(--wait)}
.status.COMPLETED{background:var(--good);color:#fff}
.status.CANCELLED{background:var(--bad);color:#fff}
.gift-grid{display:grid;grid-template-columns:repeat(5,1fr);gap:10px}
.gift{background:#0e1218;border:2px solid transparent;border-radius:12px;padding:16px;text-align:center;cursor:pointer}
.gift.selected{border-color:var(--brand);background:#131a22}
header{position:fixed;inset:0 0 auto 0;height:56px;background:var(--card);border-bottom:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;padding:0 12px;z-index:50}
.brand{font-weight:800;color:var(--brand)}
.user-chip{display:flex;align-items:center;gap:8px;background:#0e1218;border:1px solid var(--line);border-radius:10px;padding:6px 10px}
.user-chip img{width:24px;height:24px;border-radius:50%;object-fit:cover;border:1px solid var(--line)}
main{max-width:1100px;margin:72px auto 84px;padding:0 12px}
footer{position:fixed;inset:auto 0 0 0;height:56px;background:var(--card);border-top:1px solid var(--line);
  display:flex;align-items:center;justify-content:space-between;padding:0 12px}
.nowrap{white-space:nowrap}
.pager{display:flex;gap:6px;justify-content:center;margin-top:10px}
.pager button{padding:6px 10px;border-radius:8px;border:1px solid var(--line);background:#121821;color:#fff}
.pager .active{background:var(--brand);border-color:var(--brand);color:#00111c}
/* Drawer */
#drawer{position:fixed;inset:0;pointer-events:none;z-index:60}
#drawer .scrim{position:absolute;inset:0;background:#0008;opacity:0;transition:opacity .2s}
#drawer.open .scrim{opacity:1;pointer-events:auto}
#drawer .panel{position:absolute;left:12px;top:64px;bottom:12px;width:280px;transform:translateX(-120%);
  transition:transform .2s;background:var(--card);border:1px solid var(--line);border-radius:12px;overflow:hidden}
#drawer.open .panel{transform:none;pointer-events:auto}
.nav a{display:flex;align-items:center;gap:10px;padding:14px 16px;color:#e9eef5;text-decoration:none;border-bottom:1px solid #1b232d}
.nav a:hover{background:#161e28}
.menu-btn{border:none;background:transparent;color:#fff;font-size:22px;cursor:pointer}
@media (max-width:740px){ .gift-grid{grid-template-columns:repeat(3,1fr)} th,td{font-size:12px;padding:8px} }
.hide{display:none!important}
</style>
</head>
<body>
<header>
  <div class="left" style="display:flex;align-items:center;gap:10px">
    <button class="menu-btn" id="menuBtn">‚ò∞</button>
    <div class="brand">Sarkar Telecom</div>
  </div>
  <div class="right" style="display:flex;align-items:center;gap:8px">
    <span id="hdrEmail" class="pill">Guest</span>
    <span id="hdrTier" class="pill">Tier ‚Äì</span>
    <span id="hdrBal" class="pill">üíé 0</span>
    <div class="user-chip">
      <img id="hdrAvatar" alt="avatar">
      <span id="hdrName">Not logged in</span>
    </div>
  </div>
</header>

<!-- Drawer -->
<div id="drawer">
  <div class="scrim"></div>
  <div class="panel">
    <div class="nav">
      <a href="#/dashboard">üè† Dashboard</a>
      <a href="#/order">‚ûï Create Order</a>
      <a href="#/history">üßæ Order History</a>
      <a href="#/profile">üë§ Profile</a>
      <a href="#/admin-orders">üõ† Admin: Orders</a>
      <a href="#/admin-users">üë• Admin: Users</a>
      <a href="#/login">üîê Login</a>
      <a href="#/register">üìù Register</a>
      <a href="#/logout">üö™ Logout</a>
    </div>
  </div>
</div>

<main>
  <!-- LOGIN -->
  <section id="v-login" class="section">
    <h2>Login</h2>
    <div class="row">
      <div class="field"><label>Email</label><input id="loginEmail" type="email" placeholder="you@example.com"></div>
      <div class="field"><label>Password</label><input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢"></div>
    </div>
    <div class="row">
      <button class="btn" id="btnLogin">Login</button>
      <button class="btn outline" onclick="go('#/register')">Create Account</button>
    </div>
    <p class="small">Default admin (add in Users sheet): <b>admin@sarkar.com / Admin@123</b></p>
  </section>

  <!-- REGISTER -->
  <section id="v-register" class="section hide">
    <h2>Register</h2>
    <div class="row">
      <div class="field"><label>Email</label><input id="regEmail" type="email"></div>
      <div class="field"><label>Password</label><input id="regPass" type="password"></div>
      <div class="field"><label>Full Name</label><input id="regName" type="text"></div>
      <div class="field"><label>Phone</label><input id="regPhone" type="tel"></div>
    </div>
    <div class="row">
      <button class="btn" id="btnRegister">Submit</button>
      <button class="btn outline" onclick="go('#/login')">Back</button>
    </div>
    <p class="small">Admin approval required before login.</p>
  </section>

  <!-- DASHBOARD -->
  <section id="v-dashboard" class="section hide">
    <h2>Welcome to Sarkar Telecom</h2>
    <div class="row">
      <div class="section" style="flex:1 1 420px">
        <h2>Account</h2>
        <div class="small" id="acctLines"></div>
        <div class="row" style="margin-top:12px">
          <button class="btn" onclick="go('#/order')">Create Order</button>
          <button class="btn outline" onclick="go('#/history')">View History</button>
          <button class="btn outline" onclick="go('#/profile')">Profile</button>
          <button class="btn outline" onclick="go('#/admin-users')">Admin Users</button>
          <button class="btn outline" onclick="go('#/admin-orders')">Admin Orders</button>
        </div>
      </div>
      <div class="section" style="flex:1 1 300px">
        <h2>Tips</h2>
        <ul class="small">
          <li>Orders auto-cancel in 5 minutes if not completed; refund applies.</li>
          <li>Weekly window: Thu 10:00 PM (BD) ‚Üí next Thu 10:00 PM (BD).</li>
          <li>Admin can change order status and manage users.</li>
        </ul>
      </div>
    </div>
  </section>

  <!-- ORDER -->
  <section id="v-order" class="section hide">
    <h2>Create Order</h2>
    <div class="field">
      <label>Gift Recipient (Number / Profile ID)</label>
      <input id="recipient" type="number" inputmode="numeric" placeholder="Enter ID">
    </div>
    <div class="small">Your balance: <b id="orderBal">üíé 0</b></div>
    <div class="gift-grid" id="giftGrid"></div>
    <div class="row">
      <button class="btn" id="btnConfirm" disabled>Order Confirm</button>
      <button class="btn outline" onclick="go('#/history')">View Order History</button>
    </div>
  </section>

  <!-- HISTORY -->
  <section id="v-history" class="section hide">
    <h2>Order History</h2>
    <div class="row">
      <div class="field"><label>Search</label><input id="histSearch" placeholder="Order ID / Client / Amount / Time"></div>
      <div class="field"><label>Status</label>
        <select id="histStatus">
          <option value="">All</option><option>WAITING</option><option>COMPLETED</option><option>CANCELLED</option>
        </select>
      </div>
      <div class="field"><label>Weekly Total (BD)</label><input id="histWeekly" disabled></div>
    </div>
    <div class="table-wrap">
      <table><thead><tr><th>Order ID</th><th>Client</th><th>Amount</th><th>Status</th><th>Time</th></tr></thead>
        <tbody id="histBody"></tbody></table>
    </div>
    <div class="pager" id="histPager"></div>
  </section>

  <!-- ADMIN: ORDERS -->
  <section id="v-admin-orders" class="section hide">
    <h2>Admin ‚Ä¢ Manage Orders</h2>
    <div class="row">
      <div class="field w100"><label>Search</label><input id="admOrdSearch" placeholder="ID / Client / Email / Amount / Time"></div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>ID</th><th>User</th><th>Client</th><th>Amount</th><th>Status</th><th>Time</th><th>Action</th></tr></thead>
        <tbody id="admOrdersBody"></tbody>
      </table>
    </div>
    <div class="pager" id="admOrdPager"></div>
  </section>

  <!-- ADMIN: USERS -->
  <section id="v-admin-users" class="section hide">
    <h2>Admin ‚Ä¢ Users</h2>
    <div class="row">
      <div class="field"><label>Find</label><input id="userSearch" placeholder="Email / Name / Phone"></div>
      <div class="field"><label>Role</label>
        <select id="userRoleFilter"><option value="">All</option><option>admin</option><option>user</option><option value="pending">pending</option></select>
      </div>
    </div>
    <div class="table-wrap">
      <table>
        <thead><tr><th>Avatar</th><th>Name</th><th>Email</th><th>Phone</th><th>Role</th><th>Approved</th><th>Balance</th><th>Weekly</th><th>Actions</th></tr></thead>
        <tbody id="usersBody"></tbody>
      </table>
    </div>
  </section>

  <!-- PROFILE -->
  <section id="v-profile" class="section hide">
    <h2>Profile</h2>
    <div class="row">
      <div class="field">
        <label>Avatar</label>
        <input id="avatarFile" type="file" accept="image/*">
        <div class="small" style="margin-top:8px"><img id="profAvatar" style="width:76px;height:76px;border-radius:50%;border:1px solid var(--line);object-fit:cover"/></div>
      </div>
      <div class="field"><label>Name</label><input id="profName"></div>
      <div class="field"><label>Email (read only)</label><input id="profEmail" disabled></div>
      <div class="field"><label>Phone</label><input id="profPhone"></div>
      <div class="field"><label>Password</label><input id="profPass" type="password" placeholder="Change password"></div>
    </div>
    <div class="row">
      <button class="btn" id="btnSaveProfile">Save</button>
      <button class="btn outline" onclick="go('#/dashboard')">Back</button>
    </div>
  </section>

  <!-- LOGOUT -->
  <section id="v-logout" class="section hide">
    <h2>Logging out‚Ä¶</h2>
    <p class="small">Redirecting to Login‚Ä¶</p>
  </section>
</main>

<footer>
  <div class="small">¬© 2025 Sarkar Telecom ‚Ä¢ All rights reserved</div>
  <div style="display:flex;gap:8px;align-items:center">
    <span class="pill" id="fWeekly">Week: 0</span>
    <span class="pill" id="fTier">Tier ‚Äì</span>
    <span class="pill" id="fBal">üíé 0</span>
  </div>
</footer>

<script>
/*** ========= CONFIG (HARD-CODED) ========= ***/
const API = 'https://sheetdb.io/api/v1/olia09hyw73k1';
const SHEETS = { users:'Users', orders:'Orders' };

/*** ========= UTIL ========= ***/
const $ = sel => document.querySelector(sel);
const $$ = sel => Array.from(document.querySelectorAll(sel));
const json = r => r.json();
const sleep = ms => new Promise(r=>setTimeout(r,ms));
function uid(){
  return 'ORD' + Math.random().toString(36).slice(2,6).toUpperCase() + Date.now().toString().slice(-5);
}
function now(){ return Date.now(); }
function bdNow(){ return Date.now() + 6*3600*1000; } // for window anchor only
function lastThu22BD(ms=bdNow()){
  const d=new Date(ms); const day=d.getUTCDay(); const diff=((day-4)+7)%7;
  const t=new Date(ms - diff*86400000); t.setUTCHours(22,0,0,0);
  if(t.getTime()>ms) t.setTime(t.getTime()-7*86400000);
  return t.getTime() - 6*3600*1000; // convert BD back to UTC ms
}
function money(n){ return Number(n||0).toLocaleString(); }
function dataUrl(img){ return img||'data:image/svg+xml;utf8,<svg xmlns="http://www.w3.org/2000/svg" width="72" height="72"><rect width="100%" height="100%" fill="%23121a22"/><text x="50%" y="55%" font-family="sans-serif" font-size="14" fill="%23a9b1bd" text-anchor="middle">Avatar</text></svg>'; }

/*** ========= SHEETDB HELPERS ========= ***/
async function sGet(sheet, params={}){ // list
  const qs = new URLSearchParams({sheet, ...params}).toString();
  return fetch(`${API}?${qs}`).then(json);
}
async function sSearch(sheet, params){ // GET /search
  const qs = new URLSearchParams({sheet, ...params}).toString();
  return fetch(`${API}/search?${qs}`).then(json);
}
async function sInsert(sheet, rows){ // POST
  return fetch(`${API}?sheet=${encodeURIComponent(sheet)}`,{
    method:'POST', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({data: rows})
  }).then(json);
}
async function sPatchBySearch(sheet, searchParams, data){ // PATCH /search
  const qs = new URLSearchParams({sheet, ...searchParams}).toString();
  return fetch(`${API}/search?${qs}`,{
    method:'PATCH', headers:{'Content-Type':'application/json'},
    body: JSON.stringify({data})
  }).then(json);
}
async function sDeleteBySearch(sheet, searchParams){ // DELETE /search
  const qs = new URLSearchParams({sheet, ...searchParams}).toString();
  return fetch(`${API}/search?${qs}`,{method:'DELETE'}).then(json);
}

/*** ========= STATE ========= ***/
let current = null; // {email, ...}
let cache = { users:[], orders:[] };

/*** ========= MENU / ROUTER ========= ***/
const drawer = $('#drawer'); const scrim = drawer.querySelector('.scrim');
$('#menuBtn').onclick = ()=> drawer.classList.toggle('open');
scrim.onclick = ()=> drawer.classList.remove('open');
$$('.nav a').forEach(a=>a.addEventListener('click', ()=>drawer.classList.remove('open')));

const VIEWS = ['login','register','dashboard','order','history','admin-orders','admin-users','profile','logout'];
function show(v){ VIEWS.forEach(x=>$('#v-'+x).classList.add('hide')); $('#v-'+v).classList.remove('hide'); }
function go(hash){ location.hash = hash; }
window.addEventListener('hashchange', onRoute);

async function onRoute(){
  const hash = location.hash || '#/login';
  const v = hash.replace('#/','');
  const needAuth = ['dashboard','order','history','admin-orders','admin-users','profile','logout'];
  if(needAuth.includes(v) && !current){ alert('Please login first'); return go('#/login'); }
  if(v.startsWith('admin') && current?.role!=='admin'){ alert('Admin only'); return go('#/dashboard'); }

  show(v);
  if(v==='dashboard') renderDashboard();
  if(v==='order') renderOrder();
  if(v==='history') renderHistory();
  if(v==='admin-orders') renderAdminOrders();
  if(v==='admin-users') renderAdminUsers();
  if(v==='profile') renderProfile();
  if(v==='logout'){ current=null; syncHeaderFooter(); go('#/login'); }
}

/*** ========= AUTH ========= ***/
async function login(email, pass){
  const rows = await sSearch(SHEETS.users,{email, pass});
  const u = rows[0];
  if(!u) throw new Error('Invalid credentials');
  if(u.role!=='admin' && String(u.approved).toLowerCase()!=='true') throw new Error('Pending admin approval');
  current = u;
  syncHeaderFooter();
}
async function register({email,pass,name,phone}){
  const exists = await sSearch(SHEETS.users,{email});
  if(exists.length) throw new Error('Email already exists');
  await sInsert(SHEETS.users,[{
    email, pass, name, phone, role:'user', approved:false,
    balance:0, weeklyDiamonds:0, avatar:''
  }]);
}

/*** ========= TIER ========= ***/
const TIERS = [
  {min:800000, level:5, rate:3.5},
  {min:80000, level:4, rate:2.6},
  {min:40000, level:3, rate:2.1},
  {min:20000, level:2, rate:1.6},
  {min:5000,  level:1, rate:1.0},
  {min:0,     level:0, rate:0},
];
function tierFrom(total){ for(const t of TIERS) if(total>=t.min) return t; return TIERS.at(-1); }
function withinWeekly(ts){ return Number(ts)>=lastThu22BD(); }

async function refreshCaches(){
  cache.users = await sGet(SHEETS.users);
  cache.orders = await sGet(SHEETS.orders);
}
function weeklyTotalFor(email){
  return cache.orders
    .filter(o=>o.userEmail===email && o.status==='COMPLETED' && withinWeekly(o.timestamp))
    .reduce((a,b)=>a+Number(b.amount||0),0);
}

/*** ========= HEADER/FOOTER ========= ***/
function syncHeaderFooter(){
  $('#hdrEmail').textContent = current? current.email : 'Guest';
  $('#hdrName').textContent  = current? (current.name||current.email) : 'Not logged in';
  $('#hdrAvatar').src        = current? dataUrl(current.avatar) : dataUrl('');
  const bal = current? Number(current.balance||0) : 0;
  $('#hdrBal').textContent = 'üíé '+money(bal);

  const w = current? weeklyTotalFor(current.email) : 0;
  const t = tierFrom(w);
  $('#hdrTier').textContent = `Tier ${t.level}`;
  $('#fTier').textContent   = `Tier ${t.level}`;
  $('#fWeekly').textContent = `Week: ${money(w)}`;
  $('#fBal').textContent    = 'üíé '+money(bal);
}

/*** ========= DASHBOARD ========= ***/
function renderDashboard(){
  const w = weeklyTotalFor(current.email);
  const t = tierFrom(w);
  const lines = [
    `Email: <b>${current.email}</b>`,
    `Role: <b>${current.role}</b>`,
    `Phone: ${current.phone||'-'}`,
    `Balance: üíé <b>${money(current.balance||0)}</b>`,
    `Weekly Completed: üíé <b>${money(w)}</b> ‚Ä¢ Tier L${t.level} (${t.rate}%)`,
  ];
  $('#acctLines').innerHTML = lines.map(x=>`<div>${x}</div>`).join('');
}

/*** ========= ORDER ========= ***/
const AMOUNTS = [10,50,100,200,500,1000,2000,5000,10000,20000];
let selectedAmt = null;

function renderOrder(){
  selectedAmt=null;
  $('#recipient').value='';
  $('#orderBal').textContent = 'üíé '+money(current.balance||0);
  const grid = $('#giftGrid'); grid.innerHTML='';
  AMOUNTS.forEach(a=>{
    const div=document.createElement('div');
    div.className='gift'; div.dataset.amount=a; div.innerHTML=`<div class="price">üíé ${a}</div>`;
    div.onclick=()=>{ [...grid.children].forEach(c=>c.classList.remove('selected')); div.classList.add('selected'); selectedAmt=a; checkOrderForm(); };
    grid.appendChild(div);
  });
  checkOrderForm();
}
function checkOrderForm(){
  $('#btnConfirm').disabled = !( $('#recipient').value.trim() && selectedAmt );
}
$('#recipient').addEventListener('input', checkOrderForm);

$('#btnConfirm').onclick = async ()=>{
  try{
    await refreshCaches();
    const me = cache.users.find(u=>u.email===current.email);
    const amt = Number(selectedAmt||0);
    const rec = $('#recipient').value.trim();
    if(!rec || !amt) return;
    if(Number(me.balance||0) < amt) return alert('Insufficient balance');

    // deduct balance
    await sPatchBySearch(SHEETS.users,{email:me.email},{balance: Number(me.balance||0) - amt});
    // create order
    const id = uid(); const ts = now(); const cancelAt = ts + 5*60*1000;
    await sInsert(SHEETS.orders,[{
      id, clientId: rec, amount: amt, status:'WAITING',
      userEmail: me.email, timestamp: ts, autoCancelAt: cancelAt
    }]);

    // local refresh
    await refreshCaches();
    current = cache.users.find(u=>u.email===me.email);
    syncHeaderFooter();
    alert(`Order submitted!\nID: ${id}\nClient: ${rec}\nAmount: üíé ${amt}`);
    go('#/history');
  }catch(e){ alert(e.message||'Order failed'); }
};

/*** ========= HISTORY ========= ***/
let histPage=1, histSize=10;
async function renderHistory(){
  await refreshCaches();
  const mine = cache.orders.filter(o=>o.userEmail===current.email).sort((a,b)=>Number(b.timestamp)-Number(a.timestamp));
  const s = ($('#histSearch').value||'').toLowerCase();
  const st = $('#histStatus').value;
  const filtered = mine.filter(o=>{
    const blob = `${o.id} ${o.clientId} ${o.amount} ${o.status} ${o.timestamp}`.toLowerCase();
    return (!s || blob.includes(s)) && (!st || o.status===st);
  });
  const pages = Math.max(1, Math.ceil(filtered.length/histSize));
  if(histPage>pages) histPage=pages;
  const slice = filtered.slice((histPage-1)*histSize, histPage*histSize);

  $('#histBody').innerHTML = slice.map(o=>`
    <tr>
      <td class="nowrap">${o.id}</td>
      <td class="nowrap">${o.clientId}</td>
      <td>üíé ${money(o.amount)}</td>
      <td><span class="status ${o.status}">${o.status}</span></td>
      <td class="nowrap">${new Date(Number(o.timestamp)).toLocaleString()}</td>
    </tr>`).join('');

  const pag = $('#histPager'); pag.innerHTML='';
  for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.textContent=i; if(i===histPage)b.classList.add('active'); b.onclick=()=>{histPage=i;renderHistory();}; pag.appendChild(b); }

  const w = weeklyTotalFor(current.email);
  $('#histWeekly').value = money(w);
  syncHeaderFooter();
}
$('#histSearch').oninput = ()=>{histPage=1;renderHistory();};
$('#histStatus').onchange = ()=>{histPage=1;renderHistory();};

/*** ========= ADMIN: ORDERS ========= ***/
let aoPage=1, aoSize=12;
async function renderAdminOrders(){
  await refreshCaches();
  const q = ($('#admOrdSearch').value||'').toLowerCase();
  const list = cache.orders.slice().sort((a,b)=>Number(b.timestamp)-Number(a.timestamp))
    .filter(o=>{
      const blob = `${o.id} ${o.clientId} ${o.amount} ${o.userEmail} ${o.status}`.toLowerCase();
      return !q || blob.includes(q);
    });

  const pages = Math.max(1, Math.ceil(list.length/aoSize)); if(aoPage>pages) aoPage=pages;
  const rows = list.slice((aoPage-1)*aoSize, aoPage*aoSize);
  $('#admOrdersBody').innerHTML = rows.map(o=>`
    <tr>
      <td>${o.id}</td>
      <td>${o.userEmail}</td>
      <td>${o.clientId}</td>
      <td>üíé ${money(o.amount)}</td>
      <td><span class="status ${o.status}">${o.status}</span></td>
      <td>${new Date(Number(o.timestamp)).toLocaleString()}</td>
      <td class="nowrap">
        <button class="btn good" onclick="admSetStatus('${o.id}','COMPLETED')">Complete</button>
        <button class="btn danger" onclick="admSetStatus('${o.id}','CANCELLED')">Cancel</button>
        <button class="btn wait" onclick="admSetStatus('${o.id}','WAITING')">Waiting</button>
      </td>
    </tr>`).join('');

  const pag = $('#admOrdPager'); pag.innerHTML='';
  for(let i=1;i<=pages;i++){ const b=document.createElement('button'); b.textContent=i; if(i===aoPage)b.classList.add('active'); b.onclick=()=>{aoPage=i;renderAdminOrders();}; pag.appendChild(b); }
}
$('#admOrdSearch').oninput = ()=>{aoPage=1;renderAdminOrders();};

async function admSetStatus(id, status){
  await refreshCaches();
  const o = cache.orders.find(x=>x.id===id); if(!o) return;
  if(o.status===status) return;

  // refund/charge
  const me = cache.users.find(u=>u.email===o.userEmail);
  if(status==='CANCELLED' && o.status!=='CANCELLED'){ // refund
    await sPatchBySearch(SHEETS.users,{email:me.email},{balance:Number(me.balance||0)+Number(o.amount||0)});
  }
  if(status==='WAITING' && o.status==='CANCELLED'){ // charge back again
    const bal = Number(me.balance||0);
    if(bal<Number(o.amount||0)) return alert('User balance insufficient to revert to WAITING');
    await sPatchBySearch(SHEETS.users,{email:me.email},{balance:bal-Number(o.amount||0)});
  }

  await sPatchBySearch(SHEETS.orders,{id},{status});
  await refreshCaches(); syncHeaderFooter();
  renderAdminOrders(); renderHistory();
}

/*** ========= ADMIN: USERS ========= ***/
async function renderAdminUsers(){
  await refreshCaches();
  const q = ($('#userSearch').value||'').toLowerCase();
  const rf = $('#userRoleFilter').value;
  const tbody = $('#usersBody'); tbody.innerHTML='';

  cache.users.forEach(u=>{
    const w = weeklyTotalFor(u.email);
    const role = u.role||'user';
    const isPending = String(u.approved).toLowerCase()!=='true';
    const match = (!q || `${u.email} ${u.name} ${u.phone}`.toLowerCase().includes(q)) &&
                  (!rf || (rf==='pending'? isPending : role===rf));
    if(!match) return;

    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td><img src="${dataUrl(u.avatar)}" style="width:36px;height:36px;border-radius:50%;border:1px solid #1b232d;object-fit:cover"></td>
      <td>${u.name||'-'}</td>
      <td>${u.email}</td>
      <td>${u.phone||'-'}</td>
      <td>${role}</td>
      <td>${isPending? 'pending':'true'}</td>
      <td>üíé ${money(u.balance)}</td>
      <td>${money(w)}</td>
      <td class="nowrap">
        ${isPending? `<button class="btn good" data-act="approve">Approve</button>
                      <button class="btn danger" data-act="reject">Reject</button>`:''}
        <button class="btn outline" data-act="edit">Edit</button>
        <button class="btn" data-act="addbal">Add Bal</button>
        <button class="btn outline" data-act="role">${role==='admin'?'Set User':'Make Admin'}</button>
      </td>`;
    tbody.appendChild(tr);

    tr.querySelectorAll('button').forEach(b=>{
      b.onclick = async ()=>{
        const act=b.dataset.act;
        if(act==='approve'){ await sPatchBySearch(SHEETS.users,{email:u.email},{approved:true}); }
        else if(act==='reject'){ await sDeleteBySearch(SHEETS.users,{email:u.email}); }
        else if(act==='edit'){
          const name=prompt('Name', u.name||'');
          const phone=prompt('Phone', u.phone||'');
          const pass=prompt('Password (blank = keep)','');
          const data={name,phone}; if(pass) data.pass=pass;
          await sPatchBySearch(SHEETS.users,{email:u.email},data);
        }
        else if(act==='addbal'){
          const add = Number(prompt('Add diamonds:', '0')||0); if(add>0){
            await sPatchBySearch(SHEETS.users,{email:u.email},{balance:Number(u.balance||0)+add});
          }
        }
        else if(act==='role'){
          await sPatchBySearch(SHEETS.users,{email:u.email},{role: u.role==='admin'?'user':'admin'});
        }
        await refreshCaches(); renderAdminUsers(); syncHeaderFooter();
      };
    });
  });
}
$('#userSearch').oninput = renderAdminUsers;
$('#userRoleFilter').onchange = renderAdminUsers;

/*** ========= PROFILE ========= ***/
function renderProfile(){
  $('#profAvatar').src = dataUrl(current.avatar);
  $('#profName').value = current.name||'';
  $('#profEmail').value = current.email;
  $('#profPhone').value = current.phone||'';
  $('#profPass').value = '';
}
$('#avatarFile').addEventListener('change', function(){
  const f=this.files[0]; if(!f) return;
  const r=new FileReader();
  r.onload=async ()=>{
    await sPatchBySearch(SHEETS.users,{email:current.email},{avatar:r.result});
    await refreshCaches(); current=cache.users.find(u=>u.email===current.email);
    renderProfile(); syncHeaderFooter();
  };
  r.readAsDataURL(f);
});
$('#btnSaveProfile').onclick = async ()=>{
  const name=$('#profName').value.trim(); const phone=$('#profPhone').value.trim(); const pass=$('#profPass').value;
  const data={name,phone}; if(pass) data.pass=pass;
  await sPatchBySearch(SHEETS.users,{email:current.email},data);
  await refreshCaches(); current=cache.users.find(u=>u.email===current.email);
  alert('Profile updated'); syncHeaderFooter();
};

/*** ========= LOGIN / REGISTER BTN ========= ***/
$('#btnLogin').onclick = async ()=>{
  try{
    await login($('#loginEmail').value.trim().toLowerCase(), $('#loginPass').value);
    await refreshCaches(); current = cache.users.find(u=>u.email===current.email);
    go('#/dashboard');
  }catch(e){ alert(e.message||'Login failed'); }
};
$('#btnRegister').onclick = async ()=>{
  try{
    await register({
      email: $('#regEmail').value.trim().toLowerCase(),
      pass:  $('#regPass').value,
      name:  $('#regName').value.trim(),
      phone: $('#regPhone').value.trim()
    });
    alert('Registered! Wait for admin approval.'); go('#/login');
  }catch(e){ alert(e.message||'Register failed'); }
};

/*** ========= AUTO-CANCEL SWEEPER + LIVE REFRESH ========= ***/
async function sweepAutoCancel(){
  try{
    await refreshCaches();
    const waitings = cache.orders.filter(o=>o.status==='WAITING' && Number(o.autoCancelAt||0) < now());
    for(const o of waitings){
      // refund
      const u = cache.users.find(x=>x.email===o.userEmail);
      if(u) await sPatchBySearch(SHEETS.users,{email:u.email},{balance:Number(u.balance||0)+Number(o.amount||0)});
      // mark cancelled
      await sPatchBySearch(SHEETS.orders,{id:o.id},{status:'CANCELLED'});
    }
    if(waitings.length) await refreshCaches();
    if(current){ current = cache.users.find(u=>u.email===current.email) || current; syncHeaderFooter(); }
    const route = (location.hash||'#/login').replace('#/','');
    if(route==='history') renderHistory();
    if(route==='admin-orders') renderAdminOrders();
    if(route==='admin-users') renderAdminUsers();
    if(route==='dashboard') renderDashboard();
  }catch(e){ /* ignore transient errors */ }
}
setInterval(sweepAutoCancel, 15000);

/*** ========= BOOT ========= ***/
(async function boot(){
  await refreshCaches();
  syncHeaderFooter();
  onRoute();
})();
</script>
</body>
</html>