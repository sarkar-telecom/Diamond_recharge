<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Sarkar Telecom ‚Ä¢ Diamond Recharge</title>
<link rel="icon" href="data:," />
<style>
  :root{
    --bg:#0f1216; --panel:#161b22; --muted:#94a3b8; --text:#e5e7eb;
    --brand:#60a5fa; --ok:#22c55e; --warn:#f59e0b; --bad:#ef4444;
    --card:#1f2631; --border:#2a3443;
  }
  *{box-sizing:border-box} body{margin:0;background:var(--bg);color:var(--text);font:14px/1.5 system-ui,Segoe UI,Roboto}
  a{color:var(--brand);text-decoration:none}
  .appbar{position:sticky;top:0;z-index:50;background:#0b0e13;border-bottom:1px solid var(--border);display:flex;align-items:center;gap:10px;padding:10px 12px}
  .brand{font-weight:700;font-size:18px;color:#a5d8ff}
  .spacer{flex:1}
  .chip{background:var(--card);border:1px solid var(--border);padding:6px 10px;border-radius:999px}
  .btn{background:#3b82f6;border:0;color:white;padding:10px 14px;border-radius:12px;font-weight:600;cursor:pointer}
  .btn.secondary{background:#2a3342}
  .btn.ghost{background:transparent;border:1px solid var(--border);color:var(--text)}
  .btn.small{padding:6px 10px;border-radius:10px}
  .grid{display:grid;gap:12px}
  .two{grid-template-columns:repeat(2,minmax(0,1fr))}
  .three{grid-template-columns:repeat(3,minmax(0,1fr))}
  @media(max-width:780px){.two,.three{grid-template-columns:1fr}}
  .panel{background:var(--panel);border:1px solid var(--border);border-radius:16px;padding:16px}
  .title{font-size:18px;font-weight:700;margin:0 0 10px}
  .muted{color:var(--muted)}
  .footer{position:sticky;bottom:0;background:#0b0e13;border-top:1px solid var(--border);padding:10px 12px;display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  /* sidebar */
  .hamb{font-size:22px;cursor:pointer}
  .drawer{position:fixed;inset:0;pointer-events:none}
  .drawer .scrim{position:absolute;inset:0;background:#0008;opacity:0;transition:.2s}
  .drawer .side{position:absolute;top:0;bottom:0;left:0;width:290px;background:#0d1117;border-right:1px solid var(--border);transform:translateX(-100%);transition:.2s;overflow:auto}
  .drawer.show{pointer-events:auto}
  .drawer.show .scrim{opacity:1}
  .drawer.show .side{transform:none}
  .nav a{display:block;padding:14px 16px;border-bottom:1px solid #111825;color:#dbeafe}
  .nav a.active{background:#111827}
  /* forms */
  input,select{width:100%;padding:10px 12px;border-radius:10px;border:1px solid var(--border);background:var(--card);color:var(--text)}
  label{display:block;margin:8px 0 6px}
  .row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
  .badge{display:inline-block;padding:4px 8px;border-radius:999px;font-weight:700}
  .b-wait{background:#3b2e06;color:#facc15}
  .b-ok{background:#063116;color:#34d399}
  .b-bad{background:#3b0b0b;color:#f87171}
  .hide{display:none !important}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid var(--border);vertical-align:top}
  th{text-align:left;color:#cbd5e1}
  .amounts .btn{background:#1d4ed8}
  .btn.outline{background:transparent;border:1px solid var(--border)}
  .avatar{width:34px;height:34px;border-radius:50%;object-fit:cover;border:1px solid var(--border)}
</style>
</head>
<body>

<!-- Top App Bar -->
<div class="appbar">
  <span class="hamb" id="openMenu">‚ò∞</span>
  <div class="brand">Sarkar <span style="color:#60a5fa">Telecom</span></div>
  <div class="spacer"></div>
  <div id="hdrUser" class="row">
    <span id="hdrEmail" class="chip">‚Äî</span>
    <span id="hdrTier" class="chip">Tier 0</span>
    <span id="hdrBal" class="chip">üíé 0</span>
    <img id="hdrAvatar" class="avatar" src="" alt="">
    <button class="btn small" id="newOrderBtn">New Order</button>
  </div>
  <div id="hdrAnon" class="row">
    <button class="btn small" onclick="showPage('login')">Login</button>
    <button class="btn small secondary" onclick="showPage('register')">Register</button>
  </div>
</div>

<!-- Sidebar Drawer -->
<div class="drawer" id="drawer">
  <div class="scrim" id="closeMenu"></div>
  <aside class="side">
    <div class="brand" style="padding:16px 16px 8px">Sarkar Telecom</div>
    <nav class="nav">
      <a href="#/dashboard" data-page="dashboard" class="active">üè† Dashboard</a>
      <a href="#/create" data-page="create">‚ûï Create Order</a>
      <a href="#/orders" data-page="orders">üßæ Order History</a>
      <a href="#/profile" data-page="profile">üë§ Profile</a>
      <a href="#/admin-orders" data-page="adminOrders" id="linkAdminOrders" class="hide">üõ†Ô∏è Admin: Orders</a>
      <a href="#/admin-users" data-page="adminUsers" id="linkAdminUsers" class="hide">üë• Admin: Users</a>
      <a href="#/settings" data-page="settings" id="linkSettings" class="hide">‚öôÔ∏è Settings</a>
      <a href="#/login" data-page="login" id="linkLoginAnon" class="">üîê Login</a>
      <a href="#/logout" data-page="logout" id="linkLogout" class="hide">üö™ Logout</a>
    </nav>
  </aside>
</div>

<!-- PAGES -->
<main style="padding:16px;max-width:1100px;margin:0 auto;">
  <!-- Dashboard -->
  <section id="page-dashboard" class="page">
    <div class="grid two">
      <div class="panel">
        <h3 class="title">Welcome</h3>
        <div class="muted">Manage diamond gifting with live updates.</div>
        <div class="row" style="margin-top:12px;gap:8px;">
          <button class="btn" onclick="showPage('create')">Create Order</button>
          <button class="btn secondary" onclick="showPage('orders')">View History</button>
          <button class="btn ghost" onclick="autoCancelSweep()">Auto-cancel overdue</button>
        </div>
      </div>
      <div class="panel">
        <h3 class="title">Account</h3>
        <div class="grid">
          <div>Email: <b id="accEmail">‚Äî</b></div>
          <div>Phone: <b id="accPhone">‚Äî</b></div>
          <div>Role: <b id="accRole">‚Äî</b></div>
          <div>Approved: <b id="accApproved">‚Äî</b></div>
          <div>Weekly Completed: <b id="accWeek">0</b></div>
          <div>Balance: <b id="accBal">0</b></div>
        </div>
      </div>
    </div>
    <div class="panel" style="margin-top:12px">
      <h3 class="title">Tips</h3>
      <ul>
        <li>Orders auto-cancel in <b id="tipAutoCancel">5</b> minutes if not completed.</li>
        <li>Admins can manage status and balances in Admin pages.</li>
      </ul>
    </div>
  </section>

  <!-- Login -->
  <section id="page-login" class="page hide">
    <div class="panel" style="max-width:460px;margin:auto">
      <h3 class="title">Login</h3>
      <label>Email</label>
      <input id="loginEmail" type="email" placeholder="user@email.com">
      <label>Password</label>
      <input id="loginPass" type="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="doLogin()">Login</button>
        <button class="btn outline" onclick="sendReset()">Forgot password?</button>
        <button class="btn secondary" onclick="showPage('register')">Create account</button>
      </div>
      <div class="muted" id="loginMsg" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Register -->
  <section id="page-register" class="page hide">
    <div class="panel" style="max-width:520px;margin:auto">
      <h3 class="title">Register</h3>
      <div class="grid two">
        <div>
          <label>Name</label>
          <input id="regName" placeholder="Your name">
        </div>
        <div>
          <label>Phone</label>
          <input id="regPhone" placeholder="+880...">
        </div>
      </div>
      <label>Email</label>
      <input id="regEmail" type="email">
      <label>Password</label>
      <input id="regPass" type="password">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="doRegister()">Create account</button>
        <button class="btn secondary" onclick="showPage('login')">Back to Login</button>
      </div>
      <p class="muted" style="margin-top:10px">Admin approval required before you can use the site.</p>
      <div class="muted" id="regMsg"></div>
    </div>
  </section>

  <!-- Create Order -->
  <section id="page-create" class="page hide">
    <div class="panel">
      <h3 class="title">Create Order</h3>
      <label>Gift Recipient (Number / Profile ID)</label>
      <input id="clientId" placeholder="58848454">
      <div class="muted" style="margin:6px 0">Your usable balance: üíé <span id="availableBal">0</span></div>
      <div class="row amounts" style="flex-wrap:wrap;margin:8px 0">
        <button class="btn small" onclick="pickAmount(10)">üíé 10</button>
        <button class="btn small" onclick="pickAmount(50)">üíé 50</button>
        <button class="btn small" onclick="pickAmount(100)">üíé 100</button>
        <button class="btn small" onclick="pickAmount(200)">üíé 200</button>
        <button class="btn small" onclick="pickAmount(500)">üíé 500</button>
        <button class="btn small" onclick="pickAmount(1000)">üíé 1000</button>
      </div>
      <label>Amount</label>
      <input id="amount" type="number" min="1" step="1" value="50">
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="createOrder()">Submit</button>
        <button class="btn secondary" onclick="showPage('orders')">Go to History</button>
      </div>
      <div id="createMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Order History -->
  <section id="page-orders" class="page hide">
    <div class="panel">
      <h3 class="title">Order History</h3>
      <table id="ordersTable">
        <thead>
          <tr><th>ID</th><th>Client</th><th>Amount</th><th>Time</th><th>Status</th><th>Action</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Profile -->
  <section id="page-profile" class="page hide">
    <div class="panel grid two">
      <div>
        <h3 class="title">Profile</h3>
        <label>Name</label><input id="pfName">
        <label>Phone</label><input id="pfPhone">
        <label>Avatar</label><input id="pfAvatar" type="file" accept="image/*">
        <div class="row" style="margin-top:10px">
          <button class="btn" onclick="saveProfile()">Save</button>
          <button class="btn outline" onclick="sendReset()">Reset password via email</button>
        </div>
        <div id="pfMsg" class="muted" style="margin-top:8px"></div>
      </div>
      <div>
        <h3 class="title">Account</h3>
        <div class="grid">
          <div>Email: <b id="pfEmail">‚Äî</b></div>
          <div>Role: <b id="pfRole">‚Äî</b></div>
          <div>Approved: <b id="pfApproved">‚Äî</b></div>
          <div>Balance: <b id="pfBalance">‚Äî</b></div>
          <div>Weekly Diamonds: <b id="pfWeekly">‚Äî</b></div>
        </div>
      </div>
    </div>
  </section>

  <!-- Admin: Orders -->
  <section id="page-adminOrders" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Orders</h3>
      <div class="row">
        <button class="btn ghost" onclick="autoCancelSweep()">Auto-cancel overdue</button>
      </div>
      <table id="adminOrdersTbl" style="margin-top:10px">
        <thead>
          <tr><th>ID</th><th>Client</th><th>Amount</th><th>User</th><th>Status</th><th>Time</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Admin: Users -->
  <section id="page-adminUsers" class="page hide">
    <div class="panel">
      <h3 class="title">Admin: Users</h3>
      <table id="adminUsersTbl">
        <thead>
          <tr><th>Email</th><th>Name</th><th>Phone</th><th>Role</th><th>Approved</th><th>Balance</th><th>Actions</th></tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </section>

  <!-- Settings (admin) -->
  <section id="page-settings" class="page hide">
    <div class="panel" style="max-width:520px;">
      <h3 class="title">Settings</h3>
      <label>Auto-cancel after (minutes)</label>
      <input id="setAutoCancel" type="number" min="1" step="1" value="5" />
      <div class="row" style="margin-top:10px">
        <button class="btn" onclick="saveSettings()">Save Settings</button>
      </div>
      <div id="setMsg" class="muted" style="margin-top:8px"></div>
    </div>
  </section>

  <!-- Logout (dummy to trigger) -->
  <section id="page-logout" class="page hide">
    <div class="panel"><h3 class="title">Logging out‚Ä¶</h3></div>
  </section>
</main>

<!-- Footer -->
<div class="footer">
  <span>¬© 2025 Sarkar Telecom</span>
  <span class="spacer"></span>
  <span class="chip">Week: <span id="ftWeek">0</span></span>
  <span class="chip">Tier: <span id="ftTier">0</span></span>
  <span class="chip">üíé <span id="ftBal">0</span></span>
</div>

<!-- Firebase (compat CDN for single-file ease) -->
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-firestore-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.4/firebase-storage-compat.js"></script>

<script>
/*** ========= CONFIG ========= ***/
// Admin note: Firestore collections used ‚Üí users, orders, settings(primary)
// ‡¶è‡¶á ‡¶ï‡¶®‡¶´‡¶ø‡¶ó ‡¶Ü‡¶™‡¶®‡¶æ‡¶∞ ‡¶™‡ßç‡¶∞‡ßã‡¶ú‡ßá‡¶ï‡ßç‡¶ü‡ßá‡¶∞‡¶ü‡¶æ‡¶á ‡¶¨‡¶∏‡¶æ‡¶®‡ßã ‡¶Ü‡¶õ‡ßá
const firebaseConfig = {
  apiKey: "AIzaSyDJRm9-jRkxVrTLYBzK1gGrRmAEu29jVrU",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};
/*** ===== END CONFIG ===== ***/

firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
auth.setPersistence(firebase.auth.Auth.Persistence.LOCAL); // refresh ‡¶è ‡¶≤‡¶ó‡¶á‡¶® ‡¶†‡¶ø‡¶ï ‡¶•‡¶æ‡¶ï‡¶¨‡ßá
const db = firebase.firestore();
const storage = firebase.storage();

// SETTINGS (live)
let SETTINGS = { autoCancelMin: 5 };
const settingsRef = db.collection('settings').doc('primary');
settingsRef.get().then(s=>{
  if(s.exists){ SETTINGS = {...SETTINGS, ...s.data()}; }
  $('#setAutoCancel').value = SETTINGS.autoCancelMin||5;
  $('#tipAutoCancel').textContent = SETTINGS.autoCancelMin||5;
});

// UI helpers
const $ = s => document.querySelector(s);
const $$ = s => Array.from(document.querySelectorAll(s));
function fmt(n){return new Intl.NumberFormat().format(n||0)}
function pageId(key){ return `page-${key}`; }
function showPage(key){
  $$('.page').forEach(p=>p.classList.add('hide'));
  $('#'+pageId(key))?.classList.remove('hide');
  $$('.nav a').forEach(a=>a.classList.toggle('active', a.dataset.page===key));
  if(key==='logout') doLogout();
  if(key==='orders') loadMyOrders();
  if(key==='adminOrders') loadAdminOrders();
  if(key==='adminUsers') loadAdminUsers();
  if(key==='settings') loadSettings();
}
function toast(el,msg){ el.textContent=msg; setTimeout(()=>el.textContent='',4000); }
$('#openMenu').onclick=()=>$('#drawer').classList.add('show');
$('#closeMenu').onclick=()=>$('#drawer').classList.remove('show');
$$('.nav a').forEach(a=>a.onclick=()=>$('#drawer').classList.remove('show'));
$('#newOrderBtn').onclick=()=>showPage('create');

// State
let me=null;     // auth user
let myDoc=null;  // users/{uid}
let myWaitingSum=0;

// Auth watcher
auth.onAuthStateChanged(async u=>{
  me=u||null;
  if(!me){
    myDoc=null; myWaitingSum=0;
    $('#hdrAnon').classList.remove('hide');
    $('#hdrUser').classList.add('hide');
    $('#linkLogout').classList.add('hide');
    $('#linkLoginAnon').classList.remove('hide');
    $('#linkAdminOrders').classList.add('hide');
    $('#linkAdminUsers').classList.add('hide');
    $('#linkSettings').classList.add('hide');
    showPage('login');
    return;
  }
  // ensure user doc exists or load it
  const ref=db.collection('users').doc(me.uid);
  const snap = await ref.get();
  if(!snap.exists){
    await ref.set({
      email: me.email, name: me.displayName||'', phone:'', role:'user',
      approved:false, balance:0, weeklyDiamonds:0, avatar:'', tier:0
    },{merge:true});
  }
  // live snapshot
  ref.onSnapshot(s=>{
    myDoc = {...s.data(), id:s.id};
    refreshHeaderFooter();
    if(!myDoc.approved){
      $('#loginMsg').textContent='Your account is pending admin approval.';
      showPage('profile');
    }else{
      const hash = location.hash.replace('#/','') || 'dashboard';
      showPage(hash);
    }
    // compute waiting hold
    computeWaitingHold();
    // admin links
    const isAdmin = myDoc.role==='admin';
    $('#linkAdminOrders').classList.toggle('hide', !isAdmin);
    $('#linkAdminUsers').classList.toggle('hide', !isAdmin);
    $('#linkSettings').classList.toggle('hide', !isAdmin);
    $('#linkLogout').classList.remove('hide');
    $('#linkLoginAnon').classList.add('hide');
  });
});

// waiting sum (HOLD = sum of WAITING orders)
async function computeWaitingHold(){
  if(!me) return;
  const qs = await db.collection('orders')
    .where('uid','==',me.uid).where('status','==','WAITING').get();
  myWaitingSum = qs.docs.reduce((a,d)=>a+(d.data().amount||0),0);
  refreshHeaderFooter();
}

function refreshHeaderFooter(){
  if(!me || !myDoc) return;
  $('#hdrAnon').classList.add('hide');
  $('#hdrUser').classList.remove('hide');

  $('#hdrEmail').textContent = me.email||'';
  $('#hdrBal').textContent = 'üíé '+fmt( (myDoc.balance||0) - (myWaitingSum||0) );
  $('#availableBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );

  $('#accEmail').textContent=me.email||'';
  $('#accPhone').textContent=myDoc.phone||'';
  $('#accRole').textContent=myDoc.role||'user';
  $('#accApproved').textContent=String(!!myDoc.approved);
  $('#accWeek').textContent=fmt(myDoc.weeklyDiamonds||0);
  $('#accBal').textContent=fmt(myDoc.balance||0);

  $('#pfEmail').textContent=me.email||'';
  $('#pfRole').textContent=myDoc.role||'user';
  $('#pfApproved').textContent=String(!!myDoc.approved);
  $('#pfBalance').textContent=fmt(myDoc.balance||0);
  $('#pfWeekly').textContent=fmt(myDoc.weeklyDiamonds||0);
  $('#pfName').value = myDoc.name||'';
  $('#pfPhone').value = myDoc.phone||'';
  $('#hdrAvatar').src = myDoc.avatar || 'https://i.imgur.com/2QfG8z7.png';

  $('#ftWeek').textContent = fmt(myDoc.weeklyDiamonds||0);
  $('#ftTier').textContent = (myDoc.tier||0);
  $('#ftBal').textContent = fmt( (myDoc.balance||0) - (myWaitingSum||0) );
}

// Auth actions
async function doLogin(){
  const email = $('#loginEmail').value.trim();
  const pass = $('#loginPass').value;
  try{
    await auth.signInWithEmailAndPassword(email, pass);
    $('#loginMsg').textContent='';
  }catch(e){
    console.error(e); toast($('#loginMsg'), 'Login failed: '+e.message);
  }
}
async function sendReset(){
  const email = me?.email || $('#loginEmail').value.trim();
  if(!email){ toast($('#loginMsg'),'Enter your email first'); return; }
  try{ await auth.sendPasswordResetEmail(email); alert('Reset mail sent to '+email); }
  catch(e){ alert('Error: '+e.message); }
}
async function doRegister(){
  const name=$('#regName').value.trim();
  const phone=$('#regPhone').value.trim();
  const email=$('#regEmail').value.trim();
  const pass=$('#regPass').value;
  try{
    const cred = await auth.createUserWithEmailAndPassword(email, pass);
    await db.collection('users').doc(cred.user.uid).set({
      email,name,phone,role:'user',approved:false,balance:0,weeklyDiamonds:0,avatar:'',tier:0
    },{merge:true});
    alert('Account created. Wait for admin approval.');
    showPage('profile');
  }catch(e){
    toast($('#regMsg'),'Register failed: '+e.message);
  }
}
async function doLogout(){ await auth.signOut(); }

// Profile
async function saveProfile(){
  const name=$('#pfName').value.trim();
  const phone=$('#pfPhone').value.trim();
  try{
    await db.collection('users').doc(me.uid).update({name,phone});
    const file = $('#pfAvatar').files[0];
    if(file){
      const ref = storage.ref(`avatars/${me.uid}/${file.name}`);
      await ref.put(file);
      const url = await ref.getDownloadURL();
      await db.collection('users').doc(me.uid).update({avatar:url});
    }
    toast($('#pfMsg'),'Profile updated.');
  }catch(e){ toast($('#pfMsg'),'Error: '+e.message); }
}

// Settings
function loadSettings(){
  $('#setAutoCancel').value = SETTINGS.autoCancelMin||5;
}
async function saveSettings(){
  const v = Math.max(1, parseInt($('#setAutoCancel').value||'5',10));
  try{
    await settingsRef.set({autoCancelMin:v},{merge:true});
    SETTINGS.autoCancelMin = v;
    $('#tipAutoCancel').textContent = v;
    toast($('#setMsg'),'Saved.');
  }catch(e){ toast($('#setMsg'), 'Error: '+e.message); }
}

// Create order
function pickAmount(n){ $('#amount').value = n; }
async function createOrder(){
  if(!myDoc?.approved) { alert('Your account is not approved yet.'); return; }
  const clientId = $('#clientId').value.trim();
  const amount = parseInt($('#amount').value||'0',10);
  const avail = (myDoc.balance||0) - (myWaitingSum||0);
  if(!clientId) return alert('Enter client/profile ID');
  if(amount<=0) return alert('Enter a valid amount');
  if(amount>avail) return alert('Insufficient balance');

  try{
    const autoCancelAt = new Date(Date.now()+(SETTINGS.autoCancelMin||5)*60*1000);
    await db.collection('orders').add({
      clientId, amount, status:'WAITING',
      userEmail: me.email, uid: me.uid,
      timestamp: firebase.firestore.FieldValue.serverTimestamp(),
      autoCancelAt: firebase.firestore.Timestamp.fromDate(autoCancelAt),
      settled:false
    });
    $('#createMsg').textContent='Order placed ‚úì';
    computeWaitingHold();
    showPage('orders');
  }catch(e){
    toast($('#createMsg'),'Error: '+e.message);
  }
}

// My orders
let unsubMyOrders=null;
function loadMyOrders(){
  if(!me) return;
  unsubMyOrders && unsubMyOrders();
  const tbody = $('#ordersTable tbody');
  tbody.innerHTML = '';
  unsubMyOrders = db.collection('orders')
    .where('uid','==',me.uid)
    .orderBy('timestamp','desc')
    .limit(100)
    .onSnapshot(snap=>{
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data(); const id=doc.id;
        const tr=document.createElement('tr');
        const ts=d.timestamp?.toDate?.()||new Date();
        const badge = d.status==='WAITING'?'b-wait': d.status==='COMPLETED'?'b-ok':'b-bad';
        tr.innerHTML = `
          <td>${id.slice(-6)}</td>
          <td>${d.clientId||''}</td>
          <td>üíé ${fmt(d.amount)}</td>
          <td>${ts.toLocaleString()}</td>
          <td><span class="badge ${badge}">${d.status}</span></td>
          <td>${d.status==='WAITING'
            ? `<button class="btn small outline" onclick="cancelOwnOrder('${id}')">Cancel</button>`
            : `<button class="btn small outline" onclick="showPage('create')">Re-order</button>`}
          </td>`;
        tbody.appendChild(tr);
      });
    });
  autoCancelSweep(false); // own overdue
}
async function cancelOwnOrder(id){
  try{ await db.collection('orders').doc(id).update({status:'CANCELLED'}); }
  catch(e){ alert('Cancel failed: '+e.message); }
}

// Auto-cancel overdue (admin = all, user = own)
async function autoCancelSweep(){
  const isAdmin = myDoc?.role==='admin';
  const q = db.collection('orders')
    .where('status','==','WAITING')
    .where('autoCancelAt','<=',firebase.firestore.Timestamp.now());
  const snap = await q.get();
  const batch = db.batch();
  snap.forEach(doc=>{
    const d=doc.data();
    if(isAdmin || d.uid===me.uid){
      batch.update(doc.ref,{status:'CANCELLED'});
    }
  });
  if(!snap.empty) await batch.commit();
  computeWaitingHold();
}

// Admin: Orders
let unsubAdminOrders=null;
function loadAdminOrders(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  unsubAdminOrders && unsubAdminOrders();
  const tbody = $('#adminOrdersTbl tbody');
  tbody.innerHTML='';
  unsubAdminOrders = db.collection('orders').orderBy('timestamp','desc').limit(200)
    .onSnapshot(snap=>{
      tbody.innerHTML='';
      snap.forEach(doc=>{
        const d=doc.data(); const id=doc.id;
        const badge = d.status==='WAITING'?'b-wait': d.status==='COMPLETED'?'b-ok':'b-bad';
        const ts=d.timestamp?.toDate?.()||new Date();
        const tr=document.createElement('tr');
        tr.innerHTML = `
          <td>${id.slice(-6)}</td>
          <td>${d.clientId}</td>
          <td>üíé ${fmt(d.amount)}</td>
          <td>${d.userEmail}</td>
          <td><span class="badge ${badge}">${d.status}</span></td>
          <td>${ts.toLocaleString()}</td>
          <td>
            <button class="btn small" onclick="adminComplete('${id}')">Complete</button>
            <button class="btn small outline" onclick="adminCancel('${id}')">Cancel</button>
          </td>`;
        tbody.appendChild(tr);
      });
    });
}
async function adminCancel(id){
  try{ await db.collection('orders').doc(id).update({status:'CANCELLED'}); }
  catch(e){ alert('Cancel failed: '+e.message); }
}
async function adminComplete(id){
  const ref = db.collection('orders').doc(id);
  await db.runTransaction(async tr=>{
    const o = await tr.get(ref);
    if(!o.exists) throw new Error('Order not found');
    const d=o.data();
    if(d.status!=='WAITING') return;
    tr.update(ref,{status:'COMPLETED', settled:true});
    if(!d.settled){
      const uref = db.collection('users').doc(d.uid);
      const u = await tr.get(uref);
      const ub = (u.data().balance||0) - (d.amount||0);
      const w = (u.data().weeklyDiamonds||0) + (d.amount||0);
      tr.update(uref,{balance:ub, weeklyDiamonds:w});
    }
  });
  computeWaitingHold();
}

// Admin: Users
let unsubAdminUsers=null;
function loadAdminUsers(){
  if(myDoc?.role!=='admin'){ showPage('dashboard'); return; }
  unsubAdminUsers && unsubAdminUsers();
  const tbody = $('#adminUsersTbl tbody');
  tbody.innerHTML='';
  unsubAdminUsers = db.collection('users').orderBy('email').onSnapshot(snap=>{
    tbody.innerHTML='';
    snap.forEach(doc=>{
      const d=doc.data(); const id=doc.id;
      const tr=document.createElement('tr');
      tr.innerHTML = `
        <td>${d.email||''}</td>
        <td><input value="${d.name||''}" data-id="${id}" data-key="name" onblur="editUser(this)"></td>
        <td><input value="${d.phone||''}" data-id="${id}" data-key="phone" onblur="editUser(this)"></td>
        <td>
          <select data-id="${id}" data-key="role" onchange="editUser(this)">
            <option value="user" ${d.role==='user'?'selected':''}>user</option>
            <option value="admin" ${d.role==='admin'?'selected':''}>admin</option>
          </select>
        </td>
        <td>
          <select data-id="${id}" data-key="approved" onchange="editUser(this)">
            <option value="true" ${d.approved?'selected':''}>true</option>
            <option value="false" ${!d.approved?'selected':''}>false</option>
          </select>
        </td>
        <td><input type="number" value="${d.balance||0}" data-id="${id}" data-key="balance" onblur="editUser(this)"></td>
        <td><button class="btn small outline" onclick="makeAdminLogin('${id}')">Login link</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
}
async function editUser(el){
  const id=el.dataset.id, key=el.dataset.key;
  let val = el.value;
  if(key==='approved') val = (val==='true');
  if(key==='balance') val = Number(val||0);
  try{ await db.collection('users').doc(id).update({[key]:val}); }
  catch(e){ alert('Update failed: '+e.message); }
}
function makeAdminLogin(uid){
  alert('Impersonation requires Cloud Functions. ‡¶è‡¶ñ‡¶æ‡¶®‡ßá ‡¶∂‡ßÅ‡¶ß‡ßÅ Firestore ‡¶ñ‡ßÅ‡¶≤‡ßá users/'+uid+' inspect ‡¶ï‡¶∞‡ßÅ‡¶®‡•§');
}

// Router (hash)
window.addEventListener('hashchange',()=>{
  const key = (location.hash.replace('#/','')||'dashboard');
  showPage(key);
});

// Utils
function nowTs(){ return firebase.firestore.Timestamp.now(); }
</script>
</body>
</html>