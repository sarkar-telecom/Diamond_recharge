<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Orders</title>
<style>
body { font-family: Arial, Helvetica, sans-serif; background:#0f1115; color:#e7eaf0; padding:5px; margin:0; }
h2 { text-align:center; color:#06b6d4; margin-bottom:5px; font-size:18px; }
button#orderPageBtn { background:#06b6d4; color:#000; border:none; padding:6px 10px; border-radius:6px; cursor:pointer; margin-bottom:5px; font-size:14px; }
button#orderPageBtn:hover { background:#0ea5e9; }
input#searchBox { width:100%; padding:6px; margin-bottom:5px; border-radius:6px; border:1px solid #333; background:#171a21; color:#e7eaf0; font-size:14px; box-sizing:border-box; }
table { width:100%; border-collapse: collapse; margin-bottom:5px; display:none; table-layout: fixed; word-wrap: break-word; }
th, td { padding:4px; text-align:center; border:1px solid #333; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
th { background:#1f2937; color:#06b6d4; }
td { background:#171a21; }
.status-pending { color:#facc15; font-weight:bold; }
.status-completed { color:#22c55e; font-weight:bold; }
.status-failed { color:#ef4444; font-weight:bold; }
.status-cancelled { color:#ef4444; font-weight:bold; }
.msg { text-align:center; margin-top:5px; font-size:14px; color:#06b6d4; }
.pagination { text-align:center; margin-top:5px; }
.pagination button { margin:1px; padding:4px 6px; border:none; border-radius:6px; cursor:pointer; background:#1f2937; color:#06b6d4; font-size:12px; }
.pagination button.active { background:#06b6d4; color:#000; }
.pagination button:hover { background:#0ea5e9; color:#000; }

/* Responsive adjustments */
@media screen and (max-width:600px){
  th, td { font-size:10px; padding:3px; }
  button#orderPageBtn { font-size:12px; padding:4px 6px; }
  input#searchBox { font-size:12px; padding:4px; }
  .msg { font-size:12px; }
  table, thead, tbody, th, td, tr { display:block; }
  thead tr { display:none; }
  tbody tr { margin-bottom:5px; border:1px solid #333; border-radius:6px; padding:4px; background:#1a1c21; }
  td { border:none; text-align:left; padding:2px 4px; white-space:normal; }
  td::before { 
    content: attr(data-label); 
    font-weight:bold; 
    display:inline-block; 
    width:80px; 
  }
}
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let allOrders = [];
let currentPage = 1;
const perPage = 20;

function formatTime(timestamp){
  if(!timestamp?.toDate) return "-";
  const d = timestamp.toDate();
  let hours = d.getHours();
  const minutes = d.getMinutes().toString().padStart(2,'0');
  const ampm = hours>=12 ? 'PM' : 'AM';
  hours = hours%12 || 12;
  return `${hours}:${minutes} ${ampm}`;
}

function renderTable(orders){
  const tableBody = document.getElementById("ordersBody");
  tableBody.innerHTML = "";
  const totalOrders = allOrders.length;
  orders.forEach((data,index)=>{
    const sl = totalOrders - ((currentPage-1)*perPage + index);
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td data-label="SL">${sl}</td>
      <td data-label="Profile ID">${data.profileId || "-"}</td>
      <td data-label="Amount">${data.amount || "-"}</td>
      <td data-label="Method">${data.method || "-"}</td>
      <td data-label="Account">${data.account || "-"}</td>
      <td data-label="TXID">${data.txid || "-"}</td>
      <td data-label="Status" class="status-${data.status.toLowerCase()}">${data.status || "-"}</td>
      <td data-label="Created At">${formatTime(data.createdAt)}</td>
    `;
    tableBody.appendChild(tr);
  });
  document.getElementById("ordersTable").style.display = orders.length ? "table" : "none";
}

function renderPagination(total){
  const pagDiv = document.getElementById("pagination");
  pagDiv.innerHTML = "";
  const totalPages = Math.ceil(total/perPage);
  if(totalPages<=1) return;
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i===currentPage ? "active" : "";
    btn.onclick = ()=>{
      currentPage = i;
      showPage();
    };
    pagDiv.appendChild(btn);
  }
}

function showPage(){
  const start = (currentPage-1)*perPage;
  const end = start+perPage;
  renderTable(allOrders.slice(start,end));
  renderPagination(allOrders.length);
}

function filterOrders(){
  const queryStr = document.getElementById("searchBox").value.toLowerCase();
  const filtered = allOrders.filter(o=>{
    return (
      (o.profileId||"").toLowerCase().includes(queryStr) ||
      (o.amount||"").toString().includes(queryStr) ||
      (o.method||"").toLowerCase().includes(queryStr) ||
      (o.account||"").toLowerCase().includes(queryStr) ||
      (o.txid||"").toLowerCase().includes(queryStr) ||
      (o.status||"").toLowerCase().includes(queryStr)
    );
  });
  renderTable(filtered.slice(0,perPage));
  currentPage=1;
  renderPagination(filtered.length);
}

window.addEventListener("load",()=>{
  const msg = document.getElementById("msg");
  msg.textContent = "â³ Loading orders...";
  
  document.getElementById("searchBox").addEventListener("input", filterOrders);
  
  onAuthStateChanged(auth, async(user)=>{
    if(user){
      try{
        const q = query(
          collection(db,"orders"),
          where("userId","==",user.uid),
          orderBy("createdAt","desc")
        );
        const snapshot = await getDocs(q);
        if(snapshot.empty){
          msg.textContent = "No orders yet.";
        } else {
          allOrders = snapshot.docs.map(doc=>doc.data());
          msg.textContent = "";
          showPage();
        }
      }catch(e){
        msg.textContent = "Error: "+e.message;
      }
    }else{
      alert("Please login first");
      window.location.href="login.html";
    }
  });
});
</script>
</head>
<body>
<h2>ðŸ’Ž My Order History</h2>

<button id="orderPageBtn" onclick="window.location.href='order.html'">ðŸ’  Order Diamonds</button>

<input type="text" id="searchBox" placeholder="Search by Profile ID, Amount, Method, Account, TXID, Status">

<table id="ordersTable">
<thead>
<tr>
  <th>SL</th>
  <th>Profile ID</th>
  <th>Amount</th>
  <th>Method</th>
  <th>Account</th>
  <th>TXID</th>
  <th>Status</th>
  <th>Created At</th>
</tr>
</thead>
<tbody id="ordersBody">
</tbody>
</table>

<div class="pagination" id="pagination"></div>
<p id="msg" class="msg"></p>
</body>
</html>
