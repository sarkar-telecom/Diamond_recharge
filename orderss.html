<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>My Order History</title>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      margin: 0; padding: 0;
      background: #f8f9fa;
    }
    header {
      background: #222;
      color: #fff;
      padding: 15px;
      text-align: center;
    }
    h2 { margin: 0; font-size: 20px; }

    .container {
      padding: 15px;
      max-width: 100%;
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      background: #fff;
    }
    th, td {
      padding: 8px 10px;
      text-align: center;
      border: 1px solid #ddd;
      font-size: 14px;
    }
    th {
      background: #f1f1f1;
    }
    td img {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      object-fit: cover;
    }

    /* status colors */
    .status-pending { color: orange; font-weight: bold; }
    .status-completed { color: green; font-weight: bold; }
    .status-cancelled { color: red; font-weight: bold; }

    /* pagination + search */
    .top-bar {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }
    .top-bar input {
      padding: 6px;
      font-size: 14px;
      margin-top: 5px;
    }
    .pagination {
      margin-top: 10px;
      text-align: center;
    }
    .pagination button {
      padding: 5px 10px;
      margin: 2px;
      cursor: pointer;
    }
  </style>
</head>
<body>
  <header>
    <h2>ðŸ’Ž My Order History</h2>
  </header>

  <div class="container">
    <div class="top-bar">
      <input type="text" id="searchBox" placeholder="Search orders...">
      <button onclick="window.location.href='order.html'">âž• New Order</button>
    </div>
    <table>
      <thead>
        <tr>
          <th>#</th>
          <th>Avatar</th>
          <th>Profile ID</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Account</th>
          <th>TXID</th>
          <th>Status</th>
          <th>Created At</th>
        </tr>
      </thead>
      <tbody id="orderTable"></tbody>
    </table>
    <div class="pagination">
      <button onclick="prevPage()">â¬… Prev</button>
      <span id="pageInfo"></span>
      <button onclick="nextPage()">Next âž¡</button>
    </div>
  </div>

  <script>
    // ========================
    // Firebase Config
    // ========================
    const firebaseConfig = {
      apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
      authDomain: "diamond-recharge-f7f59.firebaseapp.com",
      projectId: "diamond-recharge-f7f59",
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();

    let ordersData = [];
    let currentPage = 1;
    const itemsPerPage = 20;

    auth.onAuthStateChanged(async (user) => {
      if (user) {
        const q = db.collection("orders")
          .where("userId", "==", user.uid)
          .orderBy("createdAt", "desc");

        q.onSnapshot(snapshot => {
          ordersData = [];
          snapshot.forEach(doc => {
            ordersData.push({ id: doc.id, ...doc.data() });
          });
          renderTable();
        });
      }
    });

    function renderTable() {
      const tableBody = document.getElementById("orderTable");
      tableBody.innerHTML = "";

      const searchTerm = document.getElementById("searchBox").value.toLowerCase();
      const filtered = ordersData.filter(order =>
        order.profileId?.toLowerCase().includes(searchTerm) ||
        String(order.amount).includes(searchTerm) ||
        order.method?.toLowerCase().includes(searchTerm) ||
        order.account?.toLowerCase().includes(searchTerm) ||
        order.txid?.toLowerCase().includes(searchTerm) ||
        order.status?.toLowerCase().includes(searchTerm)
      );

      const start = (currentPage - 1) * itemsPerPage;
      const paginated = filtered.slice(start, start + itemsPerPage);

      paginated.forEach((order, index) => {
        const tr = document.createElement("tr");
        const serial = start + index + 1;

        const createdAt = order.createdAt?.toDate ? order.createdAt.toDate() : null;
        const timeStr = createdAt ? createdAt.toLocaleTimeString([], { hour: "2-digit", minute: "2-digit", hour12: true }) : "";

        tr.innerHTML = `
          <td>${serial}</td>
          <td><img src="${order.avatar || 'https://via.placeholder.com/40'}" alt="avatar"></td>
          <td>${order.profileId || ""}</td>
          <td>${order.amount || ""}</td>
          <td>${order.method || ""}</td>
          <td>${order.account || ""}</td>
          <td>${order.txid || ""}</td>
          <td class="status-${(order.status || "").toLowerCase()}">${order.status || ""}</td>
          <td>${timeStr}</td>
        `;
        tableBody.appendChild(tr);
      });

      document.getElementById("pageInfo").textContent =
        `Page ${currentPage} of ${Math.ceil(filtered.length / itemsPerPage)}`;
    }

    function nextPage() {
      if (currentPage * itemsPerPage < ordersData.length) {
        currentPage++;
        renderTable();
      }
    }
    function prevPage() {
      if (currentPage > 1) {
        currentPage--;
        renderTable();
      }
    }

    document.getElementById("searchBox").addEventListener("input", () => {
      currentPage = 1;
      renderTable();
    });
  </script>
</body>
</html>
