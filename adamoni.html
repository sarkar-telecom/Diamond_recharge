<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard - SARKAR TELECOM</title>
<style>
body { margin:0; font-family:Arial,sans-serif; background:#1a2a43; color:#ecf0f1; overflow-x:hidden; }
.app-container { display:flex; min-height:100vh; transition: all 0.3s; }
/* Sidebar */
.sidebar { background-color:#1a2a43; width:220px; position:fixed; top:0; left:-220px; bottom:0; padding:10px; box-sizing:border-box; transition:left 0.3s; z-index:1000; border-right:1px solid #1a2a43; display:flex; flex-direction:column; }
.sidebar.active { left:0; }
.sidebar-header { display:flex; align-items:center; justify-content:center; padding:0 10px; margin-bottom:30px; }
.sidebar-header h2 { font-size:20px; font-weight:bold; color:#3498db; text-align:center; }
.nav-list { list-style:none; padding:0; margin:0; display:flex; flex-direction:column; gap:15px; }
.nav-item { display:flex; align-items:center; color:#ecf0f1; padding:12px 10px; border-radius:6px; cursor:pointer; transition:0.3s; }
.nav-item:hover, .nav-item.active { background-color:#2c3e50; }
.nav-item i { margin-right:10px; }
/* Page Frame */
.page-frame { margin-left:0; flex-grow:1; display:flex; flex-direction:column; min-height:100vh; transition:margin-left 0.3s; }
/* Header */
.header { display:flex; justify-content:space-between; align-items:center; padding:8px 12px; background-color:#1a2a43; border-bottom:1px solid #1a2a43; position:sticky; top:0; z-index:50; }
.header .menu-icon { font-size:26px; cursor:pointer; margin-right:10px; }
.header-title { font-size:18px; font-weight: normal; }
.profile-wrapper { position: relative; }
.profile-icon { width:42px; height:42px; border-radius:50%; cursor:pointer; object-fit:cover; transition:all 0.3s; }
.dropdown-menu { position:absolute; top:52px; right:0; background-color:#2c3e50; border-radius:6px; box-shadow:0 5px 15px rgba(0,0,0,0.4); display:none; padding:10px 0; z-index:100; min-width:150px; }
.dropdown-menu.show { display:block; }
.dropdown-item { display:flex; align-items:center; padding:10px 15px; color:#ecf0f1; cursor:pointer; justify-content:space-between; transition:0.2s; }
.dropdown-item:hover { background-color:#34495e; }

/* Announcement Ticker */
.ticker { background:#112240; color:#22c55e; padding:12px 15px; font-weight:bold; font-size:16px; border-radius:5px; margin:8px 0; overflow:hidden; white-space:nowrap; display:flex; align-items:center;}
.ticker-icon { margin-right:10px; flex-shrink:0; }
.ticker-text { display:inline-block; padding-left:100%; animation: tickerMove 30s linear infinite; }
@keyframes tickerMove { 0% { transform:translateX(0%); } 100% { transform:translateX(-100%); } }

/* Content */
.content { flex-grow:1; padding:20px; background-color:#f0f2f5; color:#333; border-radius:12px; margin:20px; transition: all 0.3s ease; box-shadow:0 2px 8px rgba(0,0,0,0.1); }
.top-bar { display:flex; justify-content:space-between; gap:10px; margin-bottom:15px; flex-wrap:wrap; }
#searchBox { flex:1; padding:8px; border:1px solid #ccc; border-radius:8px; font-size:14px; transition: all 0.2s; }
#searchBox:focus { outline:none; border-color:#06b6d4; box-shadow:0 0 5px #06b6d4; }
/* Stats */
.stats { display:flex; gap:20px; margin-bottom:20px; flex-wrap:wrap; }
.stat-card { background:#2c3e50; color:#ecf0f1; padding:12px 20px; border-radius:10px; flex:1; min-width:120px; text-align:center; box-shadow:0 2px 8px rgba(0,0,0,0.15); transition:all 0.3s; }
.stat-card:hover { transform:translateY(-3px); box-shadow:0 4px 12px rgba(0,0,0,0.2); }
/* Table */
.table-wrapper { width:100%; overflow-x:auto; }
table { width:100%; border-collapse:collapse; background:#fff; color:#333; border-radius:12px; overflow:hidden; box-shadow:0 3px 8px rgba(0,0,0,0.15); table-layout:fixed; font-size:14px; transition:all 0.3s; }
th, td { padding:10px 8px; border:1px solid #e5e7eb; text-align:center; word-wrap:break-word; transition:all 0.2s; }
th { background:#f1f5f9; font-weight:bold; color:#000; }
tr:nth-child(even) td { background:#fafbfc; }
tr:hover { background:#e0f7fa; transform:scale(1.01); }
/* Full box colored status */
.status-dropdown { font-weight:bold; cursor:pointer; border:none; border-radius:6px; padding:8px; width:100%; text-align:center; transition: all 0.2s; }
.status-pending { background:#fde68a; color:#92400e; }
.status-completed { background:#bbf7d0; color:#166534; }
.status-cancelled { background:#fecaca; color:#991b1b; }
.duplicate-txid { background:#fef08a !important; font-weight:bold; }
/* Pagination */
.pagination { text-align:center; margin-top:15px; }
.pagination button { margin:3px; padding:6px 12px; border:none; border-radius:6px; cursor:pointer; background:#1f2937; color:#fff; font-size:13px; transition:all 0.2s; }
.pagination button.active { background:#06b6d4; color:#000; }
.pagination button:hover { background:#2f3c52; }
/* Footer */
.footer { text-align:center; padding:10px 0; color:#888; font-size:16px; background-color:#1a2a43; border-top:1px solid #1a2a43; }
/* Mobile */
@media (max-width:100%){
  th, td { font-size:11px; padding:5px 3px; }
  #searchBox { font-size:12px; padding:6px; }
  .stat-card { padding:8px 12px; font-size:12px; }
}
</style>
<link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
</head>

<body>
<div class="app-container">
  <!-- Sidebar -->
  <div class="sidebar" id="sidebar">
    <div class="sidebar-header"><h2>SARKAR TELECOM</h2></div>
    <ul class="nav-list">
      <li class="nav-item active"><i class="material-icons">dashboard</i><a href="admin_dashboard.html" style="color:inherit;text-decoration:none;">Dashboard</a></li>
      <li class="nav-item"><i class="material-icons">person</i><a href="profile.html" style="color:inherit;text-decoration:none;">Profile</a></li>
      <li class="nav-item"><i class="material-icons">shopping_cart</i><a href="order.html" style="color:inherit;text-decoration:none;">Order</a></li>
      <li class="nav-item"><i class="material-icons">history</i><a href="history.html" style="color:inherit;text-decoration:none;">History</a></li>
      <li class="nav-item"><i class="material-icons">admin_panel_settings</i><a href="admin.html" style="color:inherit;text-decoration:none;">Admin</a></li>
    </ul>
  </div>

  <!-- Main Page -->
  <div class="page-frame">
    <!-- Header -->
    <header class="header">
      <div style="display:flex; align-items:center;">
        <i class="material-icons menu-icon" id="toggleSidebar">menu</i>
        <span class="header-title">Admin Dashboard</span>
      </div>
      <div class="profile-wrapper">
        <img src="https://via.placeholder.com/40" class="profile-icon" id="profileIcon" alt="Profile">
        <div class="dropdown-menu" id="dropdownMenu">
          <div class="dropdown-item"><a href="profile.html" style="color:inherit;text-decoration:none;">Profile</a></div>
          <div class="dropdown-item"><a href="order.html" style="color:inherit;text-decoration:none;">Order</a></div>
          <div class="dropdown-item"><a href="#" id="logoutBtn" style="color:inherit;text-decoration:none;">Logout</a></div>
        </div>
      </div>
    </header>

    <!-- Ticker -->        
    <div class="ticker" id="announcementTicker"> 
        <span class="ticker-icon">📢 </span>
        <span class="ticker-text">Loading announcement...</span>
    </div>

    <!-- Content -->
    <div class="content">
      <div class="top-bar">
        <input type="text" id="searchBox" placeholder="Search Profile ID / TXID / Status">
      </div>

      <div class="stats">
        <div class="stat-card">Total Orders: <span id="totalOrders">0</span></div>
        <div class="stat-card">Total Amount: <span id="totalAmount">0</span></div>
      </div>

      <div class="table-wrapper">
        <table id="historyTable">
          <thead>
            <tr>
              <th>SL</th>
              <th>Profile ID</th>
              <th>Amount</th>
              <th>Method</th>
              <th>Account</th>
              <th>TXID</th>
              <th>Status</th>
              <th>Created At</th>
            </tr>
          </thead>
          <tbody id="historyBody"></tbody>
        </table>
      </div>
      <div class="pagination" id="pagination"></div>
    </div>

    <!-- Footer -->
    <footer class="footer">© SARKAR TELECOM 2025-2026</footer>
  </div>
</div>

<audio id="newOrderSound" src="https://www.myinstants.com/media/sounds/notification.mp3"></audio>

<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-auth-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>

<script>
const firebaseConfig = {
  apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238"
};
firebase.initializeApp(firebaseConfig);
const auth = firebase.auth();
const db = firebase.firestore();

// Sidebar toggle
const sidebar = document.getElementById('sidebar');
document.getElementById('toggleSidebar').addEventListener('click', e=>{ e.stopPropagation(); sidebar.classList.toggle('active'); });
document.addEventListener('click', e=>{ if(!sidebar.contains(e.target) && e.target.id!=='toggleSidebar'){ sidebar.classList.remove('active'); } });

// Profile dropdown
const profileIcon = document.getElementById('profileIcon');
const dropdownMenu = document.getElementById('dropdownMenu');
profileIcon.addEventListener('click', e=>{ e.stopPropagation(); dropdownMenu.classList.toggle('show'); });
document.addEventListener('click', e=>{ if(!profileIcon.contains(e.target) && !dropdownMenu.contains(e.target)){ dropdownMenu.classList.remove('show'); } });

// Logout
document.getElementById('logoutBtn').addEventListener('click', ()=>auth.signOut().then(()=>window.location.href="login.html"));

let allOrders=[], currentPage=1, perPage=20;
const newOrderSound = document.getElementById('newOrderSound');

function formatTime(ts){ return ts?.toDate ? ts.toDate().toLocaleString() : "-"; }
function copyToClipboard(text){ navigator.clipboard.writeText(text).then(()=>alert("Copied: "+text)); }

function renderTable(orders){
  const tbody=document.getElementById("historyBody");
  tbody.innerHTML="";
  const txidCount={};
  orders.forEach(o=>{ if(o.txid) txidCount[o.txid]=(txidCount[o.txid]||0)+1; });

  orders.forEach((d,i)=>{
    const tr=document.createElement("tr");
    const isDuplicate = d.txid && txidCount[d.txid]>1;
    if(isDuplicate) tr.classList.add('duplicate-txid');

    tr.innerHTML=`<td>${d.globalSL}</td>
      <td style="cursor:pointer; color:#3498db;" onclick="copyToClipboard('${d.profileId}')">${d.profileId||"-"}</td>
      <td>${d.amount||0}</td>
      <td>${d.method||"-"}</td>
      <td>${d.account||"-"}</td>
      <td style="cursor:pointer; color:#f97316;" onclick="copyToClipboard('${d.txid}')">${d.txid||"-"}</td>
      <td>
        <select class="status-dropdown" data-id="${d.docId}">
          <option value="Pending" ${d.status==='Pending'?'selected':''}>⚠ Pending</option>
          <option value="Completed" ${d.status==='Completed'?'selected':''}>✅ Completed</option>
          <option value="Cancelled" ${d.status==='Cancelled'?'selected':''}>❌ Cancelled</option>
        </select>
      </td>
      <td>${formatTime(d.createdAt)}</td>`;

    tbody.appendChild(tr);
  });

  document.querySelectorAll(".status-dropdown").forEach(sel=>{
    const applyColor = ()=>{
      sel.className='status-dropdown';
      if(sel.value==='Pending') sel.classList.add('status-pending');
      if(sel.value==='Completed') sel.classList.add('status-completed');
      if(sel.value==='Cancelled') sel.classList.add('status-cancelled');
    };
    applyColor();
    sel.addEventListener("change", async e=>{
      const val=e.target.value, id=e.target.dataset.id;
      await db.collection("orders").doc(id).update({status:val});
      applyColor();
    });
  });
}

function renderPagination(total){
  const pag=document.getElementById("pagination");
  pag.innerHTML="";
  const pages=Math.ceil(total/perPage);
  if(pages<=1) return;
  for(let i=1;i<=pages;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    btn.className=i===currentPage?"active":"";
    btn.onclick=()=>{ currentPage=i; showPage(); };
    pag.appendChild(btn);
  }
}

function showPage(){
  const s=(currentPage-1)*perPage;
  renderTable(allOrders.slice(s,s+perPage));
  renderPagination(allOrders.length);
}

// Search
document.getElementById("searchBox").addEventListener("input", function(){
  const q=this.value.toLowerCase();
  const filtered=allOrders.filter(o=>{
    return (o.profileId||"").toLowerCase().includes(q) ||
           (o.txid||"").toLowerCase().includes(q) ||
           (o.method||"").toLowerCase().includes(q) ||
           (o.status||"").toLowerCase().includes(q);
  });
  currentPage=1;
  renderTable(filtered.slice(0,perPage));
  renderPagination(filtered.length);
});

// Auth & Firestore
auth.onAuthStateChanged(async(user)=>{
  if(!user){ window.location.href="login.html"; return; }
  if(user.email !== "samrat.khulnas@gmail.com"){ auth.signOut(); window.location.href="login.html"; return; } 

  const userDoc = await db.collection('users').doc(user.uid).get();
  let userData = {};
  if(userDoc.exists) { profileIcon.src = userDoc.data().avatar || "https://via.placeholder.com/40"; userData = userDoc.data(); }

  db.collection("orders").orderBy("createdAt","asc").onSnapshot(async snapshot=>{
    let globalSL=0;
    const tempData=[];
    snapshot.forEach(doc=>{
      globalSL++;
      const data=doc.data();
      data.globalSL=globalSL;
      data.docId=doc.id;
      tempData.push(data);
    });
    if(allOrders.length && tempData.length>allOrders.length) newOrderSound.play();
    allOrders=tempData.reverse();

    // Update stats
    const totalOrders = allOrders.length;
    const totalAmount = allOrders.reduce((sum,o)=>sum + (Number(o.amount)||0),0);
    document.getElementById("totalOrders").textContent = totalOrders;
    document.getElementById("totalAmount").textContent = totalAmount;

    showPage();

    // Load announcement ticker
    const annRef = db.collection('settings').doc('announcement');
    const annSnap = await annRef.get();
    if(annSnap.exists && annSnap.data().text){
        document.querySelector('.ticker-text').textContent = annSnap.data().text.replace("(Username)", userData.name || "User");
    } else {
        document.querySelector('.ticker-text').textContent = `Welcome ${userData.name || "User"}!`;
    }
  });
});
</script>
</body>
</html>
