<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background: #0f1115; color: #e7eaf0; margin:0; }
  .topbar { background:#111; padding:10px; color:#0ff; display:flex; align-items:center; }
  .brand { flex:1; font-size:18px; }
  .menu-btn { background:none; border:none; color:#0ff; font-size:20px; cursor:pointer; margin-right:10px; }
  .sidebar { position:fixed; top:0; left:-220px; width:200px; height:100%; background:#111; padding:10px; transition:0.3s; overflow:auto; }
  .sidebar.open { left:0; }
  .sidebar a { display:block; color:#0ff; padding:8px; text-decoration:none; margin-bottom:5px; border-radius:5px; }
  .sidebar a:hover { background:#0cc; }
  .container { margin-left:220px; padding:20px; }
  h2 { color:#06b6d4; text-align:center; margin-bottom:20px; }
  .controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
  .controls input, .controls select { padding: 5px; border-radius: 4px; border: 1px solid #333; background: #171a21; color: #e7eaf0; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  table, th, td { border: 1px solid #444; }
  th, td { padding: 6px; text-align: center; }
  th { background: #1f2937; }
  tr:nth-child(even) { background: #171a21; }
  tr:nth-child(odd) { background: #0f1115; }
  button.updateBtn, button.deleteBtn, button.pageBtn { padding: 4px 6px; border-radius: 4px; border: none; cursor: pointer; font-size: 12px; }
  button.updateBtn { background: #06b6d4; color: #000; }
  button.updateBtn:hover { background: #0ea5e9; }
  button.deleteBtn { background: #ef4444; color: #fff; }
  button.deleteBtn:hover { background: #f87171; }
  button.pageBtn { background: #1f2937; color: #e7eaf0; margin: 2px; }
  button.pageBtn:hover { background: #374151; }
  #denied { color: red; text-align: center; font-size: 16px; margin-top: 50px; }
  @media(max-width:600px){
    table { font-size: 11px; }
    th, td { padding: 4px; }
    button.updateBtn, button.deleteBtn, button.pageBtn { padding: 3px 5px; font-size: 11px; }
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, getDocs, orderBy, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

// ==================== Firebase Config ====================
const firebaseConfig = {
  apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// ==================== Sidebar Toggle ====================
const menuBtn = document.createElement("button");
menuBtn.className="menu-btn";
menuBtn.textContent="‚ò∞";
document.addEventListener("DOMContentLoaded", ()=>{
    document.body.prepend(menuBtn);
});
menuBtn.addEventListener('click', ()=>{
    document.getElementById("sidebar").classList.toggle("open");
});

// ==================== Admin Config ====================
const adminEmails = ["samrat.khulnas@gmail.com"];
let allOrders = [];
let currentPage = 1;
const ordersPerPage = 20;

// ==================== Load Orders ====================
async function loadOrders(){
  allOrders = [];
  const q = query(collection(db,"orders"), orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  snap.forEach(docSnap => {
    const d = docSnap.data();
    d.id = docSnap.id;
    allOrders.push(d);
  });
  renderTable();
}

// ==================== Render Table ====================
function renderTable(){
  const searchEmail = document.getElementById("searchEmail").value.toLowerCase();
  const filterStatus = document.getElementById("filterStatus").value;

  let filteredOrders = allOrders.filter(o => 
    (!searchEmail || (o.email && o.email.toLowerCase().includes(searchEmail))) &&
    (!filterStatus || o.status === filterStatus)
  );

  // Reverse serial (descending)
  filteredOrders = filteredOrders.reverse();

  const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
  if(currentPage > totalPages) currentPage = totalPages || 1;
  const start = (currentPage-1)*ordersPerPage;
  const end = start + ordersPerPage;
  const pageOrders = filteredOrders.slice(start, end);

  const orderTable = document.getElementById("orderTable");
  orderTable.innerHTML = "";
  pageOrders.forEach((d,index)=>{
    const row = document.createElement("tr");
    const serialStr = (start+index+1).toString().padStart(3,"0");
    row.innerHTML = `
      <td>${serialStr}</td>
      <td>${d.email||"N/A"}</td>
      <td>${d.profileId||"N/A"}</td>
      <td>${d.amount||0}</td>
      <td>${d.method||"N/A"}</td>
      <td>${d.account||"N/A"}</td>
      <td>${d.txid||"N/A"}</td>
      <td>
        <select id="status_${d.id}">
          <option value="pending" ${d.status==="pending"?"selected":""}>Pending</option>
          <option value="completed" ${d.status==="completed"?"selected":""}>Completed</option>
          <option value="cancelled" ${d.status==="cancelled"?"selected":""}>Cancelled</option>
        </select>
        <button class="updateBtn" onclick="updateStatus('${d.id}')">Update</button>
      </td>
      <td>
        <button class="deleteBtn" onclick="deleteOrder('${d.id}')">Delete</button>
      </td>
    `;
    orderTable.appendChild(row);
  });

  renderPagination(totalPages);
}

// ==================== Pagination ====================
function renderPagination(totalPages){
  const container = document.getElementById("pagination");
  container.innerHTML="";
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.textContent=i;
    btn.className="pageBtn";
    if(i===currentPage) btn.style.background="#06b6d4";
    btn.onclick=()=>{currentPage=i; renderTable();};
    container.appendChild(btn);
  }
}

// ==================== Update & Delete ====================
window.updateStatus = async(orderId)=>{
  const newStatus = document.getElementById(`status_${orderId}`).value;
  await updateDoc(doc(db,"orders",orderId),{status:newStatus});
  alert("‚úÖ Status updated!");
  loadOrders();
}

window.deleteOrder = async(orderId)=>{
  if(confirm("Are you sure you want to delete this order?")){
    await deleteDoc(doc(db,"orders",orderId));
    alert("üóëÔ∏è Order deleted!");
    loadOrders();
  }
}

// ==================== Auth Check ====================
onAuthStateChanged(auth, user=>{
  if(user){
    if(adminEmails.includes(user.email)){
      document.getElementById("adminContent").style.display="block";
      loadOrders();
    } else {
      document.getElementById("denied").style.display="block";
    }
  } else {
    alert("Please login first");
    window.location.href="index.html";
  }
});
</script>
</head>
<body>
<aside id="sidebar" class="sidebar">
  <a href="home.html">Dashboard</a>
  <a href="products.html">Order Diamonds</a>
  <a href="cart.html">Order History</a>
  <a href="admin.html">Admin Panel</a>
</aside>

<h2>‚öôÔ∏è Admin Dashboard</h2>

<div id="adminContent" style="display:none;">
  <div class="controls">
    <input type="text" id="searchEmail" placeholder="Search by Email" oninput="renderTable()">
    <select id="filterStatus" onchange="renderTable()">
      <option value="">All Status</option>
      <option value="pending">Pending</option>
      <option value="completed">Completed</option>
      <option value="cancelled">Cancelled</option>
    </select>
  </div>

  <div style="overflow-x:auto;">
    <table>
      <thead>
        <tr>
          <th>Serial</th>
          <th>User Email</th>
          <th>Profile ID</th>
          <th>Amount</th>
          <th>Method</th>
          <th>Account</th>
          <th>TxID</th>
          <th>Status</th>
          <th>Delete</th>
        </tr>
      </thead>
      <tbody id="orderTable"></tbody>
    </table>
  </div>
  <div id="pagination" style="margin-top:10px;"></div>
</div>

<div id="denied" style="display:none;">
  ‚ùå Access Denied. You are not admin.
</div>
</body>
</html>
