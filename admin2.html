<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin Dashboard ‚Äî Diamond Recharge</title>
<style>
  body { font-family: Arial, Helvetica, sans-serif; background: #0a0f1e; color: #fff; margin:0; }
  .topbar { background:#111; padding:10px; color:#0ff; display:flex; align-items:center; position:fixed; width:100%; z-index:10; }
  .brand { flex:1; font-size:18px; font-weight:bold; }
  .menu-btn { background:none; border:none; color:#0ff; font-size:22px; cursor:pointer; margin-right:10px; }
  .sidebar { position:fixed; top:50px; left:-220px; width:220px; height:calc(100% - 50px); background:#111; padding:10px; transition:0.3s; overflow:auto; box-shadow:2px 0 10px #0ff50a33; }
  .sidebar.open { left:0; }
  .sidebar a { display:block; color:#0ff; padding:10px; text-decoration:none; margin-bottom:5px; border-radius:5px; }
  .sidebar a:hover { background:#0cc; }
  .container { margin-left:0; padding:70px 20px 20px 20px; transition:margin-left 0.3s; }
  .sidebar.open ~ .container { margin-left:220px; }
  h2 { color:#06b6d4; text-align:center; margin-bottom:20px; text-shadow:0 0 5px #0ff; }
  .controls { margin-bottom: 10px; display: flex; flex-wrap: wrap; gap: 10px; }
  .controls input, .controls select { padding: 8px; border-radius: 5px; border: 1px solid #333; background: #171a21; color: #e7eaf0; }
  table { width: 100%; border-collapse: collapse; margin-top: 10px; font-size: 13px; }
  table, th, td { border: 1px solid #0ff; }
  th, td { padding: 8px; text-align: center; }
  th { background: #1f2937; color:#0ff; }
  tr:nth-child(even) { background: #171a21; }
  tr:nth-child(odd) { background: #0f1115; }
  button.updateBtn, button.deleteBtn, button.pageBtn { padding: 5px 8px; border-radius: 5px; border: none; cursor: pointer; font-size: 12px; }
  button.updateBtn { background: #06b6d4; color: #000; }
  button.updateBtn:hover { background: #0ea5e9; }
  button.deleteBtn { background: #ef4444; color: #fff; }
  button.deleteBtn:hover { background: #f87171; }
  button.pageBtn { background: #1f2937; color: #0ff; margin: 2px; }
  button.pageBtn:hover { background: #374151; }
  #denied { color: red; text-align: center; font-size: 16px; margin-top: 50px; }
  @media(max-width:600px){
    table { font-size: 11px; }
    th, td { padding: 4px; }
    button.updateBtn, button.deleteBtn, button.pageBtn { padding: 3px 5px; font-size: 11px; }
    .sidebar { width:180px; }
    .sidebar.open ~ .container { margin-left:180px; }
  }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, getDocs, orderBy, query, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

const adminEmails = ["samrat.khulnas@gmail.com"];
let allOrders = [];
let currentPage = 1;
const ordersPerPage = 20;

// Load Orders
async function loadOrders(){
  allOrders = [];
  const q = query(collection(db,"orders"), orderBy("createdAt","desc"));
  const snap = await getDocs(q);
  snap.forEach(docSnap => {
    const d = docSnap.data();
    d.id = docSnap.id;
    allOrders.push(d);
  });
  renderTable();
}

// Render Table
function renderTable(){
  const searchEmail = document.getElementById("searchEmail").value.toLowerCase();
  const filterStatus = document.getElementById("filterStatus").value;

  let filteredOrders = allOrders.filter(o => 
    (!searchEmail || (o.email && o.email.toLowerCase().includes(searchEmail))) &&
    (!filterStatus || o.status === filterStatus)
  );

  // latest order first, serial accordingly
  const totalPages = Math.ceil(filteredOrders.length / ordersPerPage);
  if(currentPage > totalPages) currentPage = totalPages || 1;
  const start = (currentPage-1)*ordersPerPage;
  const end = start + ordersPerPage;
  const pageOrders = filteredOrders.slice(start,end);

  const orderTable = document.getElementById("orderTable");
  orderTable.innerHTML="";
  pageOrders.forEach((d,index)=>{
    const serial = filteredOrders.length - (start + index);
    const row = document.createElement("tr");
    row.innerHTML = `
      <td>${serial}</td>
      <td>${d.email||"N/A"}</td>
      <td>${d.profileId||"N/A"}</td>
      <td>${d.amount||0}</td>
      <td>${d.method||"N/A"}</td>
      <td>${d.account||"N/A"}</td>
      <td>${d.txid||"N/A"}</td>
      <td>
        <select id="status_${d.id}">
          <option value="pending" ${d.status==="pending"?"selected":""}>Pending</option>
          <option value="completed" ${d.status==="completed"?"selected":""}>Completed</option>
          <option value="cancelled" ${d.status==="cancelled"?"selected":""}>Cancelled</option>
        </select>
        <button class="updateBtn" onclick="updateStatus('${d.id}')">Update</button>
      </td>
      <td><button class="deleteBtn" onclick="deleteOrder('${d.id}')">Delete</button></td>
    `;
    orderTable.appendChild(row);
  });

  renderPagination(totalPages);
}

// Pagination
function renderPagination(totalPages){
  const container = document.getElementById("pagination");
  container.innerHTML="";
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.textContent=i;
    btn.className="pageBtn";
    if(i===currentPage) btn.style.background="#06b6d4";
    btn.onclick=()=>{currentPage=i; renderTable();};
    container.appendChild(btn);
  }
}

// Update / Delete
window.updateStatus = async(id)=>{
  const newStatus = document.getElementById(`status_${id}`).value;
  await updateDoc(doc(db,"orders",id),{status:newStatus});
  alert("‚úÖ Status updated!");
  loadOrders();
}
window.deleteOrder = async(id)=>{
  if(confirm("Are you sure to delete this order?")){
    await deleteDoc(doc(db,"orders",id));
    alert("üóëÔ∏è Order deleted!");
    loadOrders();
  }
}

// Auth & Admin Check
onAuthStateChanged(auth,user=>{
  if(user){
    if(adminEmails.includes(user.email)){
      document.getElementById("adminContent").style.display="block";
      loadOrders();
    } else {
      document.getElementById("denied").style.display="block";
    }
  } else {
    alert("Login first!");
    window.location.href="index.html";
  }
});

// Sidebar toggle
document.addEventListener("DOMContentLoaded",()=>{
  const menuBtn = document.querySelector(".menu-btn");
  menuBtn.addEventListener("click",()=>{
    document.querySelector(".sidebar").classList.toggle("open");
  });
});
</script>
</head>
<body>
<nav class="topbar">
  <button class="menu-btn">‚ò∞</button>
  <div class="brand">Diamond Recharge Admin</div>
</nav>

<aside class="sidebar">
  <a href="home.html">Dashboard</a>
  <a href="products.html">Order Diamonds</a>
  <a href="cart.html">Order History</a>
  <a href="admin.html">Admin Panel</a>
</aside>

<div class="container">
  <h2>‚öôÔ∏è Admin Dashboard</h2>

  <div id="adminContent" style="display:none;">
    <div class="controls">
      <input type="text" id="searchEmail" placeholder="Search by Email" oninput="renderTable()">
      <select id="filterStatus" onchange="renderTable()">
        <option value="">All Status</option>
        <option value="pending">Pending</option>
        <option value="completed">Completed</option>
        <option value="cancelled">Cancelled</option>
      </select>
    </div>

    <div style="overflow-x:auto;">
      <table>
        <thead>
          <tr>
            <th>Serial</th>
            <th>User Email</th>
            <th>Profile ID</th>
            <th>Amount</th>
            <th>Method</th>
            <th>Account</th>
            <th>TxID</th>
            <th>Status</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody id="orderTable"></tbody>
      </table>
    </div>

    <div id="pagination" style="margin-top:10px;"></div>
  </div>

  <div id="denied" style="display:none;">
    ‚ùå Access Denied. You are not admin.
  </div>
</div>
</body>
</html>
