<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Order History - SARKAR TELECOM</title>
<style>
body { margin:0; font-family: Arial, Helvetica, sans-serif; background:#0f1824; color:#e7eaf0; display:flex; flex-direction:column; min-height:100vh; }
/* Header */
header { display:flex; justify-content:space-between; align-items:center; background:#1b2735; padding:10px 15px; position:fixed; width:100%; top:0; z-index:1000; }
.menu-toggle { font-size:24px; cursor:pointer; background:none; border:none; color:#fff; }
.site-title { font-weight:bold; font-size:18px; flex:1; text-align:center; }
.profile { position:relative; cursor:pointer; display:flex; align-items:center; padding-right:30px; }
.profile img { width:40px; height:40px; border-radius:50%; object-fit:cover; margin-left:10px; }
.dropdown { position:absolute; right:0; top:50px; background:#1c2431; color:#fff; min-width:160px; border-radius:6px; display:none; flex-direction:column; box-shadow:0 4px 6px rgba(0,0,0,0.2); }
.dropdown a { padding:10px; text-decoration:none; color:#fff; border-bottom:1px solid #2a3445; }
.dropdown a:hover { background:#2f3c52; }
/* Sidebar */
.sidebar { position:fixed; left:-250px; top:0; width:250px; height:100%; background:#1c2431; padding-top:60px; transition:left 0.3s ease; z-index:999; overflow-y:auto; }
.sidebar.active { left:0; }
.sidebar a { display:block; padding:12px 20px; text-decoration:none; color:#fff; border-bottom:1px solid #2a3445; }
.sidebar a:hover { background:#2f3c52; }
.logout-btn { display:block; width:90%; margin:15px auto; padding:12px; background:#d62828; color:#fff; border:none; border-radius:8px; font-size:15px; cursor:pointer; text-align:center; }
.logout-btn:hover { background:#b91c1c; }
.user-card { background:#0f1115; border:1px solid #2b3347; border-radius:12px; padding:10px; display:flex; align-items:center; gap:10px; margin:15px; flex-direction:column; text-align:center; }
.user-card img { width:70px; height:70px; border-radius:50%; border:3px solid #06b6d4; }
.user-card h3 { margin:4px 0; font-size:16px; color:#06b6d4; }
.user-card p { margin:2px 0; font-size:13px; color:#fff; }
/* Main */
main { margin-top:70px; padding:15px; flex:1; }
h2 { text-align:center; color:#06b6d4; margin-bottom:20px; }
#searchBox { width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #333; background:#171a21; color:#e7eaf0; }
/* Table */
table { width:100%; border-collapse:collapse; table-layout:fixed; }
th, td { padding:8px 6px; border:1px solid #333; text-align:center; font-size:12px; overflow:hidden; text-overflow:ellipsis; white-space:nowrap; }
th { background:#1f2937; }
td { background:#171a21; }
.status-pending { color:#facc15; font-weight:bold; }
.status-completed { color:#22c55e; font-weight:bold; }
.status-cancelled { color:#ef4444; font-weight:bold; }
button.updateBtn { padding:4px 8px; border:none; border-radius:6px; cursor:pointer; background:#06b6d4; color:#000; font-weight:bold; }
button.updateBtn:hover { background:#0ea5e9; }
select.status-select { padding:4px 6px; border-radius:6px; border:none; background:#1f2937; color:#fff; }
/* Pagination */
.pagination { text-align:center; margin-top:10px; }
.pagination button { margin:2px; padding:5px 8px; border:none; border-radius:6px; cursor:pointer; background:#1f2937; color:#fff; font-size:12px; }
.pagination button.active { background:#06b6d4; color:#000; }
.pagination button:hover { background:#0ea5e9; }
/* Footer */
footer { background:#1b2735; padding:20px 10px; text-align:center; }
.footer-nav { display:flex; justify-content:center; flex-wrap:wrap; gap:10px; margin-bottom:10px; }
.footer-nav a { text-decoration:none; color:#fff; background:#06b6d4; padding:8px 14px; border-radius:20px; font-size:14px; transition:0.3s; }
.footer-nav a:hover { background:#0891b2; }
.copyright { font-size:13px; color:#aaa; }
/* Responsive */
@media screen and (max-width:600px){ table { display:block; overflow-x:auto; white-space:nowrap; } th, td { font-size:10px; padding:4px; } }
</style>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-app.js";
import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-auth.js";
import { getFirestore, collection, query, orderBy, getDocs, doc, getDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.0.1/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let allOrders=[], currentPage=1, perPage=20;

function formatTime(ts){
  if(!ts?.toDate) return "-";
  const d=ts.toDate();
  let h=d.getHours();
  const m=d.getMinutes().toString().padStart(2,'0');
  const ampm=h>=12?'PM':'AM';
  h=h%12||12;
  return `${h}:${m} ${ampm}`;
}

// Sidebar & dropdown toggle
document.addEventListener("DOMContentLoaded",()=>{
  document.querySelector(".menu-toggle").addEventListener("click",()=>{ document.getElementById("sidebar").classList.toggle("active"); });
  const profileMenu=document.getElementById("profileMenu");
  const dropdownMenu=document.getElementById("dropdownMenu");
  profileMenu.addEventListener("click",()=>{ dropdownMenu.style.display=dropdownMenu.style.display==="flex"?"none":"flex"; });
  document.getElementById("logoutBtn").addEventListener("click",()=>signOut(auth).then(()=>window.location.href="login.html"));
  document.getElementById("logoutBtn2").addEventListener("click",()=>signOut(auth).then(()=>window.location.href="login.html"));
});

// Render table
function renderTable(orders){
  const tbody=document.getElementById("ordersBody");
  tbody.innerHTML="";
  const total=allOrders.length;
  orders.forEach((d,i)=>{
    const sl=total-((currentPage-1)*perPage+i);
    const tr=document.createElement("tr");
    tr.innerHTML=`
      <td>${sl}</td>
      <td>${d.profileId||"-"}</td>
      <td>${d.amount||"-"}</td>
      <td>${d.method||"-"}</td>
      <td>${d.account||"-"}</td>
      <td>${d.txid||"-"}</td>
      <td><select class="status-select" id="status_${d.id}">
        <option value="pending" ${d.status==="pending"?"selected":""}>Pending</option>
        <option value="completed" ${d.status==="completed"?"selected":""}>Completed</option>
        <option value="cancelled" ${d.status==="cancelled"?"selected":""}>Cancelled</option>
      </select></td>
      <td>${formatTime(d.createdAt)}</td>
      <td><button class="updateBtn" onclick="updateStatus('${d.id}')">Update</button></td>
    `;
    tbody.appendChild(tr);
  });
}

// Pagination
function renderPagination(total){
  const pag=document.getElementById("pagination");
  pag.innerHTML="";
  const pages=Math.ceil(total/perPage);
  if(pages<=1) return;
  for(let i=1;i<=pages;i++){
    const btn=document.createElement("button");
    btn.textContent=i;
    btn.className=i===currentPage?"active":"";
    btn.onclick=()=>{ currentPage=i; showPage(); };
    pag.appendChild(btn);
  }
}

function showPage(){
  const s=(currentPage-1)*perPage;
  renderTable(allOrders.slice(s,s+perPage));
  renderPagination(allOrders.length);
}

function filterOrders(){
  const q=document.getElementById("searchBox").value.toLowerCase();
  const filtered=allOrders.filter(o=>((o.profileId||"").toLowerCase().includes(q)||(o.amount||"").toString().includes(q)||(o.method||"").toLowerCase().includes(q)||(o.account||"").toLowerCase().includes(q)||(o.txid||"").toLowerCase().includes(q)||(o.status||"").toLowerCase().includes(q)));
  currentPage=1;
  renderTable(filtered.slice(0,perPage));
  renderPagination(filtered.length);
}

document.addEventListener("DOMContentLoaded",()=>{ document.getElementById("searchBox").addEventListener("input",filterOrders); });

// Load Orders
async function loadOrders(){
  const ordersRef=collection(db,"orders");
  const q=query(ordersRef,orderBy("createdAt","desc"));
  const snap=await getDocs(q);
  allOrders=[];
  snap.forEach(d=>allOrders.push({...d.data(),id:d.id}));
  showPage();
}

// Update status
window.updateStatus=async(id)=>{
  const val=document.getElementById(`status_${id}`).value;
  await updateDoc(doc(db,"orders",id),{status:val});
  alert("âœ… Status updated!");
  loadOrders();
}

// Auth + Sidebar user info
onAuthStateChanged(auth,async(user)=>{
  if(user){
    const userDoc=doc(db,"users",user.uid);
    const snap=await getDoc(userDoc);
    const img=document.getElementById("profilePic");
    const userName=document.getElementById("userName");
    const userEmail=document.getElementById("userEmail");
    if(snap.exists()){
      img.src=snap.data().avatar || "https://via.placeholder.com/70";
      userName.textContent=snap.data().name || "User";
      userEmail.textContent=snap.data().email || "";
    } else {
      img.src="https://via.placeholder.com/70";
      userName.textContent="User";
      userEmail.textContent="";
    }
    loadOrders();
  } else window.location.href="login.html";
});
</script>
</head>
<body>
<header>
  <button class="menu-toggle">â˜°</button>
  <div class="site-title">SARKAR TELECOM</div>
  <div class="profile" id="profileMenu">
    <img id="profilePic" src="https://via.placeholder.com/40" alt="Profile">
    <div class="dropdown" id="dropdownMenu">
      <a href="profile.html">Profile</a>
      <a href="order.html">ðŸ’Ž Order Page</a>
      <a href="#" id="logoutBtn">Logout</a>
    </div>
  </div>
</header>

<div class="sidebar" id="sidebar">
  <div class="user-card">
    <img id="profilePicSidebar" src="https://via.placeholder.com/70" alt="User">
    <h3 id="userName">User</h3>
    <p id="userEmail">user@example.com</p>
  </div>
  <a href="dashboard.html">ðŸ“Š Dashboard</a>
  <a href="profile.html">ðŸ‘¤ Profile</a>
  <a href="user-managment.html">ðŸ“‹ User Request</a>
  <a href="order-history.html">ðŸ“œ Order History</a>
  <a href="order.html">ðŸ’Ž Order Page</a>
  <a href="diamond.html">ðŸ’° Diamond Recharge</a>
  <button class="logout-btn" id="logoutBtn2">ðŸšª Logout</button>
</div>

<main>
<h2>Order History</h2>
<input type="text" id="searchBox" placeholder="Search Profile ID / Amount / Method / Account / TXID / Status">
<table>
<thead>
<tr>
<th>SL</th>
<th>Profile ID</th>
<th>Amount</th>
<th>Method</th>
<th>Account</th>
<th>TXID</th>
<th>Status</th>
<th>Created At</th>
<th>Action</th>
</tr>
</thead>
<tbody id="ordersBody"></tbody>
</table>
<div class="pagination" id="pagination"></div>
</main>

<footer>
<div class="footer-nav">
<a href="dashboard.html">Dashboard</a>
<a href="profile.html">Profile</a>
<a href="order-history.html">Order History</a>
<a href="order.html">Order Page</a>
<a href="diamond.html">Diamond Recharge</a>
</div>
<div class="copyright">Â© 2025 SARKAR TELECOM</div>
</footer>
</body>
</html>
