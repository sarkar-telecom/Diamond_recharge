<!DOCTYPE html>
<html lang="bn">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>My Orders</title>
<style>
body { font-family: Arial, Helvetica, sans-serif; background:#0f1115; color:#e7eaf0; padding:10px; }
h2 { text-align:center; color:#06b6d4; margin-bottom:10px; }
button#orderPageBtn { background:#06b6d4; color:#000; border:none; padding:8px 12px; border-radius:6px; cursor:pointer; margin-bottom:10px; }
button#orderPageBtn:hover { background:#0ea5e9; }
input#searchBox { width:100%; padding:8px; margin-bottom:10px; border-radius:6px; border:1px solid #333; background:#171a21; color:#e7eaf0; }
table { width:100%; border-collapse: collapse; margin-bottom:10px; display:none; }
th, td { padding:8px; text-align:center; border:1px solid #333; }
th { background:#1f2937; color:#06b6d4; }
td { background:#171a21; }
.status-pending { color:#facc15; font-weight:bold; }
.status-completed { color:#22c55e; font-weight:bold; }
.status-failed { color:#ef4444; font-weight:bold; }
.msg { text-align:center; margin-top:10px; font-size:16px; color:#06b6d4; }
.pagination { text-align:center; margin-top:10px; }
.pagination button { margin:2px; padding:6px 10px; border:none; border-radius:6px; cursor:pointer; background:#1f2937; color:#06b6d4; }
.pagination button.active { background:#06b6d4; color:#000; }
.pagination button:hover { background:#0ea5e9; color:#000; }
</style>
<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import { getFirestore, collection, query, where, orderBy, getDocs } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAyhjOsIXNAkBglpRllt0OZIOJYpdB_9-8",
  authDomain: "diamond-recharge-f7f59.firebaseapp.com",
  projectId: "diamond-recharge-f7f59",
  storageBucket: "diamond-recharge-f7f59.appspot.com",
  messagingSenderId: "657717928489",
  appId: "1:657717928489:web:70431ebc9afb7002d4b238",
  measurementId: "G-TDK78BQ8SQ"
};

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let allOrders = [];
let currentPage = 1;
const perPage = 20;

function renderTable(orders){
  const tableBody = document.getElementById("ordersBody");
  tableBody.innerHTML = "";
  const totalOrders = allOrders.length;
  orders.forEach((data,index)=>{
    const sl = totalOrders - ((currentPage-1)*perPage + index); // Reverse Serial Number
    const tr = document.createElement("tr");
    tr.innerHTML = `
      <td>${sl}</td>
      <td>${data.profileId || "-"}</td>
      <td>${data.amount || "-"}</td>
      <td>${data.method || "-"}</td>
      <td>${data.account || "-"}</td>
      <td>${data.txid || "-"}</td>
      <td class="status-${data.status.toLowerCase()}">${data.status || "-"}</td>
      <td>${data.createdAt?.toDate ? data.createdAt.toDate().toLocaleString() : "-"}</td>
    `;
    tableBody.appendChild(tr);
  });
  document.getElementById("ordersTable").style.display = orders.length ? "table" : "none";
}

function renderPagination(total){
  const pagDiv = document.getElementById("pagination");
  pagDiv.innerHTML = "";
  const totalPages = Math.ceil(total/perPage);
  if(totalPages<=1) return;
  for(let i=1;i<=totalPages;i++){
    const btn = document.createElement("button");
    btn.textContent = i;
    btn.className = i===currentPage ? "active" : "";
    btn.onclick = ()=>{
      currentPage = i;
      showPage();
    };
    pagDiv.appendChild(btn);
  }
}

function showPage(){
  const start = (currentPage-1)*perPage;
  const end = start+perPage;
  renderTable(allOrders.slice(start,end));
  renderPagination(allOrders.length);
}

function filterOrders(){
  const queryStr = document.getElementById("searchBox").value.toLowerCase();
  const filtered = allOrders.filter(o=>{
    return (
      (o.profileId||"").toLowerCase().includes(queryStr) ||
      (o.amount||"").toString().includes(queryStr) ||
      (o.method||"").toLowerCase().includes(queryStr) ||
      (o.account||"").toLowerCase().includes(queryStr) ||
      (o.txid||"").toLowerCase().includes(queryStr) ||
      (o.status||"").toLowerCase().includes(queryStr)
    );
  });
  renderTable(filtered.slice(0,perPage));
  currentPage=1;
  renderPagination(filtered.length);
}

window.addEventListener("load",()=>{
  const msg = document.getElementById("msg");
  msg.textContent = "⏳ Loading orders...";
  
  document.getElementById("searchBox").addEventListener("input", filterOrders);
  
  onAuthStateChanged(auth, async(user)=>{
    if(user){
      try{
        const q = query(
          collection(db,"orders"),
          where("userId","==",user.uid),
          orderBy("createdAt","desc")
        );
        const snapshot = await getDocs(q);
        if(snapshot.empty){
          msg.textContent = "No orders yet.";
        } else {
          allOrders = snapshot.docs.map(doc=>doc.data());
          msg.textContent = "";
          showPage();
        }
      }catch(e){
        msg.textContent = "Error: "+e.message;
      }
    }else{
      alert("Please login first");
      window.location.href="login.html";
    }
  });
});
</script>
</head>
<body>
<h2>💎 My Order History</h2>

<button id="orderPageBtn" onclick="window.location.href='order.html'">💠 Order Diamonds</button>

<input type="text" id="searchBox" placeholder="Search by Profile ID, Amount, Method, Account, TXID, Status">

<table id="ordersTable">
<thead>
<tr>
  <th>SL</th>
  <th>Profile ID</th>
  <th>Amount</th>
  <th>Method</th>
  <th>Account</th>
  <th>TXID</th>
  <th>Status</th>
  <th>Created At</th>
</tr>
</thead>
<tbody id="ordersBody">
</tbody>
</table>

<div class="pagination" id="pagination"></div>
<p id="msg" class="msg"></p>
</body>
</html>
